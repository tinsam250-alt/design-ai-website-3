<!DOCTYPE html>
<html lang="zh-TW" class="h-full">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="description" content="Design Thinking AI - å°ˆæ¥­çš„äººå·¥æ™ºèƒ½å°è©±å¹³å°ï¼Œæ”¯æ´å¤šå¹³å°ä½¿ç”¨">
<meta name="keywords" content="AI,äººå·¥æ™ºèƒ½,æ™ºèƒ½åŠ©æ‰‹,èŠå¤©æ©Ÿå™¨äºº,è·¨å¹³å°,è¨­è¨ˆæ€ç¶­">
<meta name="author" content="Design Thinking AI Team">
<meta name="theme-color" content="#1e3a8a">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Design Thinking AI">

<title>Design Thinking AI - æ™ºèƒ½å°è©±åŠ©æ‰‹</title>

<!-- å­—é«”å’ŒCSSæ¡†æ¶ -->
<script src="https://cdn.tailwindcss.com"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&family=Noto+Sans+TC:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">

<!-- Tailwind é…ç½® -->
<script>
tailwind.config = {
theme: {
extend: {
fontFamily: {
'sans': ['Inter', 'Noto Sans TC', 'system-ui', 'sans-serif'],
},
colors: {
primary: {
50: '#eff6ff',
100: '#dbeafe',
200: '#bfdbfe', 
300: '#93c5fd',
400: '#60a5fa',
500: '#3b82f6',
600: '#2563eb',
700: '#1d4ed8',
800: '#1e40af',
900: '#1e3a8a',
}
},
animation: {
'fade-in': 'fadeIn 0.6s ease-out',
'slide-up': 'slideUp 0.5s ease-out',
'slide-down': 'slideDown 0.5s ease-out',
'slide-left': 'slideLeft 0.4s ease-out',
'slide-right': 'slideRight 0.4s ease-out',
'bounce-subtle': 'bounceSubtle 2s ease-in-out infinite',
'pulse-glow': 'pulseGlow 2s ease-in-out infinite',
'char-pop': 'charPop 0.15s ease-out forwards',
'blink': 'blink 1s infinite',
'float': 'float 3s ease-in-out infinite',
'glow-pulse': 'glowPulse 2s ease-in-out infinite',
'shimmer': 'shimmer 2s linear infinite',
'scale-bounce': 'scaleBounce 0.6s ease-out',
'border-pulse': 'borderPulse 3s ease-in-out infinite',
},
keyframes: {
fadeIn: {
'0%': { opacity: '0', transform: 'translateY(20px)' },
'100%': { opacity: '1', transform: 'translateY(0)' }
},
slideUp: {
'0%': { transform: 'translateY(30px)', opacity: '0' },
'100%': { transform: 'translateY(0)', opacity: '1' }
},
slideDown: {
'0%': { transform: 'translateY(-30px)', opacity: '0' },
'100%': { transform: 'translateY(0)', opacity: '1' }
},
slideLeft: {
'0%': { transform: 'translateX(30px)', opacity: '0' },
'100%': { transform: 'translateX(0)', opacity: '1' }
},
slideRight: {
'0%': { transform: 'translateX(-30px)', opacity: '0' },
'100%': { transform: 'translateX(0)', opacity: '1' }
},
bounceSubtle: {
'0%, 100%': { transform: 'translateY(0)' },
'50%': { transform: 'translateY(-8px)' }
},
pulseGlow: {
'0%, 100%': { boxShadow: '0 0 8px rgba(59, 130, 246, 0.5)' },
'50%': { boxShadow: '0 0 25px rgba(59, 130, 246, 0.9)' }
},
charPop: {
'0%': { 
opacity: '0', 
transform: 'scale(0.3) translateY(20px)',
filter: 'blur(3px)'
},
'50%': { 
transform: 'scale(1.1) translateY(-5px)',
filter: 'blur(0px)'
},
'100%': { 
opacity: '1', 
transform: 'scale(1) translateY(0)',
filter: 'blur(0px)'
}
},
blink: {
'0%, 50%': { opacity: '1' },
'51%, 100%': { opacity: '0' }
},
float: {
'0%, 100%': { transform: 'translateY(0px)' },
'50%': { transform: 'translateY(-10px)' }
},
glowPulse: {
'0%, 100%': { 
boxShadow: '0 0 20px rgba(59, 130, 246, 0.4), 0 0 40px rgba(59, 130, 246, 0.2)' 
},
'50%': { 
boxShadow: '0 0 30px rgba(59, 130, 246, 0.6), 0 0 60px rgba(59, 130, 246, 0.4)' 
}
},
shimmer: {
'0%': { backgroundPosition: '-200px 0' },
'100%': { backgroundPosition: '200px 0' }
},
scaleBounce: {
'0%': { transform: 'scale(0.3)', opacity: '0' },
'50%': { transform: 'scale(1.1)' },
'100%': { transform: 'scale(1)', opacity: '1' }
},
borderPulse: {
'0%, 100%': { 
borderColor: '#3b82f6',
boxShadow: '0 8px 32px rgba(59, 130, 246, 0.3)'
},
'25%': { 
borderColor: '#8b5cf6',
boxShadow: '0 8px 32px rgba(139, 92, 246, 0.4)'
},
'50%': { 
borderColor: '#06b6d4',
boxShadow: '0 8px 32px rgba(6, 182, 212, 0.4)'
},
'75%': { 
borderColor: '#10b981',
boxShadow: '0 8px 32px rgba(16, 185, 129, 0.4)'
}
}
}
}
}
}
</script>

<style>
body {
font-family: 'Inter', 'Noto Sans TC', system-ui, sans-serif;
font-weight: 800;
-webkit-font-smoothing: antialiased;
-moz-osx-font-smoothing: grayscale;
}

h1, h2, h3, h4, h5, h6 {
font-weight: 900 !important;
}

button, .btn {
font-weight: 800 !important;
}

p, span, div {
font-weight: 700 !important;
}

.glass-effect {
backdrop-filter: blur(20px);
background: rgba(30, 58, 138, 0.15);
border: 1px solid rgba(255, 255, 255, 0.15);
}

.chat-bubble {
max-width: 85%;
width: auto;
word-wrap: break-word;
word-break: break-word;
overflow-wrap: break-word;
hyphens: auto;
font-weight: 600;
border-radius: 20px;
position: relative;
overflow: hidden;
box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
line-height: 1.5;
display: inline-block;
box-sizing: border-box;
contain: layout style;
padding: 12px 16px !important;
}

.chat-bubble::before {
content: '';
position: absolute;
top: 0;
left: 0;
right: 0;
bottom: 0;
background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
transform: translateX(-100%);
transition: transform 0.6s;
}

.chat-bubble:hover::before {
transform: translateX(100%);
}

.chat-bubble.user {
background: linear-gradient(135deg, #4f46e5, #7c3aed, #ec4899);
color: white;
margin-left: auto;
margin-right: 0;
border-radius: 18px 18px 6px 18px;
font-weight: 700 !important;
box-shadow: 0 4px 16px rgba(79, 70, 229, 0.3);
border: 2px solid rgba(79, 70, 229, 0.5);
max-width: fit-content;
min-width: auto;
flex-shrink: 0;
white-space: pre-wrap;
padding: 10px 14px !important;
}

.chat-bubble.bot {
background: linear-gradient(135deg, #ffffff, #f8fafc, #e2e8f0);
color: #1e293b;
border-radius: 18px 18px 18px 6px;
font-weight: 700 !important;
box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
border: 2px solid #3b82f6;
margin-right: auto;
margin-left: 0;
max-width: fit-content;
min-width: auto;
flex-shrink: 0;
white-space: pre-wrap;
animation: borderPulse 3s ease-in-out infinite;
position: relative;
overflow: visible;
padding: 8px 12px !important;
margin: 0 !important;
}

.chat-bubble.bot * {
margin: 0 !important;
padding: 0 !important;
}

.chat-bubble.bot p {
margin: 0 !important;
padding: 0 !important;
line-height: 1.5 !important;
}

.chat-bubble.bot div {
margin: 0 !important;
padding: 0 !important;
line-height: 1.5 !important;
}

.chat-bubble.bot p + p,
.chat-bubble.bot div + div {
margin-top: 8px !important;
}

.sidebar {
width: 340px;
background: linear-gradient(135deg, #1e3a8a, #1d4ed8, #2563eb);
transform: translateX(-100%);
transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
box-shadow: 8px 0 32px rgba(0, 0, 0, 0.3);
}

.sidebar.open {
transform: translateX(0);
}

.conversation-item {
padding: 16px 20px;
margin: 8px 0;
border-radius: 16px;
background: rgba(255, 255, 255, 0.1);
border: 1px solid rgba(255, 255, 255, 0.2);
transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
cursor: pointer;
font-weight: 700;
position: relative;
overflow: hidden;
}

.conversation-item::before {
content: '';
position: absolute;
top: 0;
left: -100%;
width: 100%;
height: 100%;
background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
transition: left 0.5s;
}

.conversation-item:hover {
background: rgba(255, 255, 255, 0.25);
transform: translateX(8px) scale(1.02);
box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
}

.conversation-item:hover::before {
left: 100%;
}

.conversation-item.active {
background: rgba(255, 255, 255, 0.3);
border-color: rgba(255, 255, 255, 0.5);
box-shadow: 0 0 32px rgba(255, 255, 255, 0.3);
}

.scroll-area {
scrollbar-width: thin;
scrollbar-color: rgba(59, 130, 246, 0.6) transparent;
}

.scroll-area::-webkit-scrollbar {
width: 8px;
}

.scroll-area::-webkit-scrollbar-track {
background: rgba(255, 255, 255, 0.1);
border-radius: 4px;
}

.scroll-area::-webkit-scrollbar-thumb {
background: rgba(59, 130, 246, 0.6);
border-radius: 4px;
transition: background 0.3s;
}

.scroll-area::-webkit-scrollbar-thumb:hover {
background: rgba(59, 130, 246, 0.8);
}

.page {
display: none;
animation: fadeIn 0.6s ease-out;
}

.page.active {
display: block;
}

.typewriter-cursor {
animation: blink 1s infinite;
font-weight: 100;
color: #3b82f6;
}

.char-container {
display: inline-block;
opacity: 0;
}

.loading-dots {
display: inline-block;
}

.loading-dots::after {
content: '';
animation: dots 1.5s infinite;
}

@keyframes dots {
0%, 20% { content: ''; }
40% { content: '.'; }
60% { content: '..'; }
80%, 100% { content: '...'; }
}

.file-upload-area {
border: 3px dashed rgba(255, 255, 255, 0.3);
border-radius: 16px;
transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
position: relative;
overflow: hidden;
}

.file-upload-area:hover {
border-color: rgba(59, 130, 246, 0.6);
background: rgba(59, 130, 246, 0.1);
transform: scale(1.02);
}

.file-upload-area.drag-over {
border-color: #60a5fa;
background: rgba(96, 165, 250, 0.2);
transform: scale(1.05);
box-shadow: 0 0 32px rgba(96, 165, 250, 0.4);
}

@media (max-width: 768px) {
.sidebar {
width: 100%;
position: fixed;
top: 0;
left: 0;
height: 100vh;
z-index: 50;
}

.chat-bubble {
max-width: fit-content;
min-width: auto;
word-break: break-all;
overflow-wrap: anywhere;
padding: 8px 12px !important;
}

.chat-bubble.bot {
max-width: fit-content;
min-width: auto;
margin-right: auto;
margin-left: 0;
border: 2px solid #3b82f6;
background: linear-gradient(135deg, #ffffff, #f8fafc);
padding: 8px 12px !important;
}

.chat-bubble.user {
max-width: fit-content;
min-width: auto;
margin-left: auto;
margin-right: 0;
padding: 8px 12px !important;
}

#messagesContainer {
padding: 0 15px;
max-width: 100%;
box-sizing: border-box;
}

#chatArea {
padding: 1rem;
}
}

.input-focus-glow:focus {
box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3), 0 0 32px rgba(59, 130, 246, 0.2);
border-color: #3b82f6;
}

.button-hover-lift:hover {
transform: translateY(-3px);
box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
}

.smooth-transition {
transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.shimmer-effect {
background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
background-size: 200px 100%;
animation: shimmer 2s infinite;
}

.message-sending {
opacity: 0.7;
transform: scale(0.98);
transition: all 0.3s ease;
}

.message-sent {
opacity: 1;
transform: scale(1);
}
</style>
</head>

<body class="bg-gradient-to-br from-slate-900 via-slate-800 to-primary-900 text-white overflow-hidden">

<!-- ç¬¬ä¸€é ï¼šä¸»é ä»‹ç´¹ -->
<div id="homePage" class="page active fixed inset-0 bg-gradient-to-br from-gray-900 via-gray-800 to-gray-700 overflow-y-auto scroll-area">
<div class="min-h-screen flex flex-col items-center justify-start py-8 px-4 pb-20">

<!-- ä¸»æ¨™é¡Œå’ŒLogo -->
<div class="text-center mb-12 animate-fade-in">
<div class="flex flex-col md:flex-row items-center justify-center mb-10">

<!-- Design Thinking AI Logo - å°ˆæ¥­AIè…¦éƒ¨é›»è·¯è¨­è¨ˆ -->
<div class="w-28 h-28 md:w-32 md:h-32 bg-gradient-to-br from-gray-900 via-blue-900 to-cyan-900 rounded-full flex items-center justify-center animate-float border-4 border-cyan-400 shadow-2xl mb-8 md:mb-0 md:mr-10 relative overflow-hidden animate-glow-pulse">

<!-- ä¸»è¦AIè…¦éƒ¨é›»è·¯Logo -->
<div class="relative z-10 flex items-center justify-center w-full h-full">
<svg class="w-20 h-20 md:w-24 md:h-24 text-cyan-400" viewBox="0 0 200 200" fill="none" stroke="currentColor">

<!-- äººé¡é ­éƒ¨å´é¢è¼ªå»“ -->
<path d="M60 180 C40 170, 30 150, 30 130 C30 120, 32 110, 35 100 C35 90, 35 80, 40 70 C45 50, 55 35, 70 25 C80 20, 90 18, 100 18 C110 18, 120 20, 130 25 C140 30, 148 38, 155 48 C160 55, 163 63, 165 72 C167 80, 168 88, 168 96 C168 105, 167 114, 165 122 C163 130, 160 137, 156 144 C152 150, 147 156, 140 160 C130 166, 118 170, 105 172 C95 174, 85 175, 75 175 C70 176, 65 178, 60 180 Z" stroke-width="2" fill="none"/>

<!-- å¤§è…¦è¼ªå»“ -->
<path d="M70 25 C85 15, 105 15, 125 20 C140 25, 150 35, 155 50 C158 65, 155 80, 150 95 C145 110, 135 125, 120 135 C105 145, 85 145, 70 140 C55 135, 45 125, 42 110 C40 95, 42 80, 45 65 C48 50, 55 35, 70 25 Z" stroke-width="1.5" fill="none"/>

<!-- AIé›»è·¯æ¿åœ–æ¡ˆ - æ°´å¹³ç·šæ¢ -->
<g stroke-width="1" opacity="0.9">
<line x1="50" y1="40" x2="140" y2="40"/>
<line x1="55" y1="50" x2="135" y2="50"/>
<line x1="60" y1="60" x2="130" y2="60"/>
<line x1="65" y1="70" x2="125" y2="70"/>
<line x1="70" y1="80" x2="120" y2="80"/>
<line x1="75" y1="90" x2="115" y2="90"/>
<line x1="80" y1="100" x2="110" y2="100"/>
<line x1="85" y1="110" x2="105" y2="110"/>
</g>

<!-- AIé›»è·¯æ¿åœ–æ¡ˆ - å‚ç›´ç·šæ¢ -->
<g stroke-width="1" opacity="0.8">
<line x1="70" y1="30" x2="70" y2="120"/>
<line x1="85" y1="35" x2="85" y2="115"/>
<line x1="100" y1="30" x2="100" y2="120"/>
<line x1="115" y1="35" x2="115" y2="115"/>
<line x1="130" y1="40" x2="130" y2="110"/>
</g>

<!-- é›»è·¯ç¯€é» -->
<g fill="currentColor" opacity="0.9">
<circle cx="70" cy="40" r="2"/>
<circle cx="100" cy="45" r="2"/>
<circle cx="130" cy="50" r="2"/>
<circle cx="85" cy="65" r="2"/>
<circle cx="115" cy="75" r="2"/>
<circle cx="95" cy="85" r="2"/>
<circle cx="105" cy="95" r="2"/>
<circle cx="90" cy="105" r="2"/>
</g>

<!-- è¤‡é›œé›»è·¯é€£æ¥ç·š -->
<g stroke-width="0.8" opacity="0.7">
<path d="M70 40 L85 65 L115 75" fill="none"/>
<path d="M100 45 L95 85 L105 95" fill="none"/>
<path d="M130 50 L115 75 L90 105" fill="none"/>
<path d="M85 65 L105 95 L90 105" fill="none"/>
</g>

<!-- å¾®è™•ç†å™¨æ–¹å¡Š -->
<g stroke-width="1.2" fill="none" opacity="0.8">
<rect x="80" y="55" width="20" height="15" rx="2"/>
<rect x="90" y="75" width="15" height="12" rx="1"/>
<rect x="85" y="95" width="18" height="10" rx="1"/>
</g>

<!-- æ•¸æ“šæµå‹•æ•ˆæœç·šæ¢ -->
<g stroke-width="0.5" opacity="0.6">
<path d="M45 70 Q 60 65, 75 70 T 105 75 T 135 80" fill="none"/>
<path d="M45 90 Q 60 85, 75 90 T 105 95 T 135 100" fill="none"/>
<path d="M45 110 Q 60 105, 75 110 T 105 115" fill="none"/>
</g>

</svg>
</div>

<!-- å¢å¼·é–ƒçˆæ•ˆæœ -->
<div class="absolute inset-0 bg-gradient-to-br from-cyan-300 via-transparent to-blue-400 opacity-20 animate-pulse"></div>

<!-- ç™¼å…‰å…‰ç’°æ•ˆæœ -->
<div class="absolute -inset-2 bg-gradient-to-r from-cyan-400 to-blue-500 rounded-full blur opacity-30 animate-pulse"></div>

</div>

<div class="text-center md:text-left">
<div class="flex items-center justify-center md:justify-start mb-4">
<h1 class="text-4xl md:text-5xl font-black text-white tracking-wide animate-slide-right">Design Thinking AI</h1>
</div>
<p class="text-2xl md:text-3xl text-blue-200 font-bold animate-slide-left">æ™ºèƒ½å°è©±åŠ©æ‰‹å¹³å°</p>
</div>

</div>
</div>

<!-- æ­¡è¿å…§å®¹å¡ç‰‡ -->
<div class="max-w-6xl w-full bg-white bg-opacity-10 backdrop-blur-lg rounded-3xl border border-white border-opacity-20 p-10 md:p-16 shadow-2xl mb-12 animate-slide-up smooth-transition hover:bg-opacity-15">

<!-- æ­¡è¿æ¨™é¡Œ -->
<div class="text-center mb-12">
<h2 class="text-3xl md:text-4xl font-black text-white mb-6">ğŸŒŸ æ­¡è¿ä¾†åˆ° Design Thinking AIï¼</h2>
<div class="w-48 h-2 bg-gradient-to-r from-blue-400 via-purple-500 to-pink-500 mx-auto rounded-full"></div>
</div>

<!-- æ­¡è¿èªå’Œå¹³å°ç°¡ä»‹ -->
<div class="text-center mb-14">
<p class="text-lg md:text-xl text-white font-bold leading-loose mb-10 max-w-5xl mx-auto">
Design Thinking AI ç‚ºè¨­è¨ˆæ€ç¶­å¹³å°ï¼Œè¨­è¨ˆæ€ç¶­ä¸åƒ…é©ç”¨æ–¼ç”¢å“è¨­è¨ˆï¼Œé‚„èƒ½æ‡‰ç”¨æ–¼æœå‹™è¨­è¨ˆã€å•†æ¥­æ¨¡å¼å‰µæ–°ã€æ•™è‚²ç­‰å„å€‹é ˜åŸŸã€‚
<br><br>
å®ƒé¼“å‹µåœ˜éšŠä¸æ–·å˜—è©¦ã€å¾éŒ¯èª¤ä¸­å­¸ç¿’ï¼Œä¸¦æŒçºŒå„ªåŒ–è§£æ±ºæ–¹æ¡ˆï¼Œæœ€çµ‚å‰µé€ å‡ºæ›´ç¬¦åˆä½¿ç”¨è€…éœ€æ±‚ã€æ›´å…·åƒ¹å€¼å‰µæ–°çš„æˆæœã€‚
</p>

<!-- å¹³å°æ ¸å¿ƒåŠŸèƒ½ç°¡ä»‹ -->
<div class="bg-white bg-opacity-5 rounded-3xl p-10 border-2 border-white border-opacity-20 smooth-transition hover:bg-opacity-10 shadow-lg">
<h3 class="text-white font-black text-lg mb-8">ğŸ¤– æˆ‘å€‘çš„AIåŠ©æ‰‹èƒ½å¤ ï¼š</h3>
<div class="grid grid-cols-1 md:grid-cols-2 gap-8 text-blue-100 font-bold text-base">

<div class="flex items-start space-x-4 smooth-transition hover:transform hover:scale-105 p-4 rounded-xl hover:bg-white hover:bg-opacity-10">
<span class="text-green-400 text-2xl">ğŸ’¡</span>
<span class="leading-relaxed">åˆ©ç”¨è¨­è¨ˆæ€ç¶­äº”å€‹æ­¥é©Ÿä¾†å›ç­”å„ç¨®å•é¡Œ</span>
</div>

<div class="flex items-start space-x-4 smooth-transition hover:transform hover:scale-105 p-4 rounded-xl hover:bg-white hover:bg-opacity-10">
<span class="text-purple-400 text-2xl">ğŸ¯</span>
<span class="leading-relaxed">å¼·å‹çš„AIåŠ©æ‰‹å› æ‡‰ç”¨å®¶çš„å•é¡Œ, æ±ºå®šæ˜¯å¦éœ€è¦æ·±åº¦åˆ†æ</span>
</div>

<div class="flex items-start space-x-4 smooth-transition hover:transform hover:scale-105 p-4 rounded-xl hover:bg-white hover:bg-opacity-10">
<span class="text-blue-400 text-2xl">ğŸ”§</span>
<span class="leading-relaxed">çµ¦äºˆæœ€åˆé©çš„å»ºè­°å’Œç­”æ¡ˆ</span>
</div>

<div class="flex items-start space-x-4 smooth-transition hover:transform hover:scale-105 p-4 rounded-xl hover:bg-white hover:bg-opacity-10">
<span class="text-yellow-400 text-2xl">ğŸ’¬</span>
<span class="leading-relaxed">æœ€çµ‚èƒ½å¤ æœ‰æ»¿æ„çš„å°è©±, å‹™æ±‚è§£æ±ºåˆ°ç”¨å®¶éœ€è¦</span>
</div>

</div>
</div>

</div>

<!-- æ¨™é¡Œï¼šè¨­è¨ˆæ€ç¶­çš„äº”å€‹æ­¥é©Ÿ -->
<div class="text-center mb-12">
<h3 class="text-2xl md:text-3xl font-black text-white mb-10">è¨­è¨ˆæ€ç¶­çš„äº”å€‹æ­¥é©Ÿ</h3>
</div>

<!-- å‰ä¸‰å€‹æ­¥é©Ÿ -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-12">

<div class="text-center p-8 bg-white bg-opacity-10 rounded-3xl border-2 border-white border-opacity-20 smooth-transition hover:bg-opacity-20 hover:transform hover:scale-105 shadow-lg">
<div class="w-20 h-20 bg-blue-500 bg-opacity-30 rounded-full flex items-center justify-center mx-auto mb-6 animate-float">
<svg class="w-10 h-10 text-blue-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
</svg>
</div>
<h3 class="text-white font-black text-lg mb-4 leading-relaxed">åŒç†ï¼ˆEmpathizeï¼‰</h3>
<p class="text-blue-100 font-bold text-sm leading-relaxed">æ·±å…¥äº†è§£ä½¿ç”¨è€…ï¼Œé€éè§€å¯Ÿã€è¨ªè«‡ç­‰æ–¹å¼ï¼Œæ”¶é›†ä½¿ç”¨è€…è³‡æ–™</p>
</div>

<div class="text-center p-8 bg-white bg-opacity-10 rounded-3xl border-2 border-white border-opacity-20 smooth-transition hover:bg-opacity-20 hover:transform hover:scale-105 shadow-lg">
<div class="w-20 h-20 bg-purple-500 bg-opacity-30 rounded-full flex items-center justify-center mx-auto mb-6 animate-float" style="animation-delay: 0.2s;">
<svg class="w-10 h-10 text-purple-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
</svg>
</div>
<h3 class="text-white font-black text-lg mb-4 leading-relaxed">å®šç¾©ï¼ˆDefineï¼‰</h3>
<p class="text-blue-100 font-bold text-sm leading-relaxed">åœ¨æ”¶é›†åˆ°çš„è³‡æ–™åŸºç¤ä¸Šï¼Œæ‰¾å‡ºéœ€è¦è§£æ±ºçš„å…·é«”å•é¡Œ</p>
</div>

<div class="text-center p-8 bg-white bg-opacity-10 rounded-3xl border-2 border-white border-opacity-20 smooth-transition hover:bg-opacity-20 hover:transform hover:scale-105 shadow-lg">
<div class="w-20 h-20 bg-green-500 bg-opacity-30 rounded-full flex items-center justify-center mx-auto mb-6 animate-float" style="animation-delay: 0.4s;">
<svg class="w-10 h-10 text-green-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
</svg>
</div>
<h3 class="text-white font-black text-lg mb-4 leading-relaxed">ç™¼æƒ³ï¼ˆIdeateï¼‰</h3>
<p class="text-blue-100 font-bold text-sm leading-relaxed">æå‡ºå„ç¨®å¯èƒ½çš„è§£æ±ºæ–¹æ¡ˆï¼Œä¸è¨­é™åœ°æ¢ç´¢å„ç¨®å¯èƒ½æ€§</p>
</div>

</div>

<!-- å¾Œå…©å€‹æ­¥é©Ÿ -->
<div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-12 max-w-4xl mx-auto">

<div class="text-center p-8 bg-white bg-opacity-10 rounded-3xl border-2 border-white border-opacity-20 smooth-transition hover:bg-opacity-20 hover:transform hover:scale-105 shadow-lg">
<div class="w-20 h-20 bg-orange-500 bg-opacity-30 rounded-full flex items-center justify-center mx-auto mb-6 animate-float" style="animation-delay: 0.6s;">
<svg class="w-10 h-10 text-orange-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path>
</svg>
</div>
<h3 class="text-white font-black text-lg mb-4 leading-relaxed">åŸå‹ï¼ˆPrototypeï¼‰</h3>
<p class="text-blue-100 font-bold text-sm leading-relaxed">å°‡æƒ³æ³•å…·é«”åŒ–ï¼Œè£½ä½œå‡ºç°¡å–®çš„åŸå‹ï¼Œä¾‹å¦‚è‰åœ–ã€æ¨¡å‹ç­‰ï¼Œå¿«é€Ÿæ¸¬è©¦å’Œé©—è­‰</p>
</div>

<div class="text-center p-8 bg-white bg-opacity-10 rounded-3xl border-2 border-white border-opacity-20 smooth-transition hover:bg-opacity-20 hover:transform hover:scale-105 shadow-lg">
<div class="w-20 h-20 bg-red-500 bg-opacity-30 rounded-full flex items-center justify-center mx-auto mb-6 animate-float" style="animation-delay: 0.8s;">
<svg class="w-10 h-10 text-red-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
</svg>
</div>
<h3 class="text-white font-black text-lg mb-4 leading-relaxed">æ¸¬è©¦ï¼ˆTestï¼‰</h3>
<p class="text-blue-100 font-bold text-sm leading-relaxed">è®“ä½¿ç”¨è€…é«”é©—åŸå‹ï¼Œæ”¶é›†å›é¥‹æ„è¦‹ï¼Œä¸¦æ ¹æ“šå›é¥‹ä¸æ–·ä¿®æ”¹å’Œå®Œå–„åŸå‹</p>
</div>

</div>

<!-- é€²å…¥æŒ‰éµ -->
<div class="text-center mb-10">
<button id="enterChatBotBtn" class="group relative px-12 md:px-20 py-6 bg-white bg-opacity-20 hover:bg-opacity-30 border-3 border-white border-opacity-50 rounded-3xl transition-all duration-500 transform hover:scale-110 hover:shadow-2xl w-full md:w-auto button-hover-lift animate-glow-pulse">
<div class="absolute inset-0 bg-gradient-to-r from-blue-400 via-purple-500 to-pink-500 rounded-3xl opacity-0 group-hover:opacity-25 transition-opacity duration-500"></div>
<span class="relative text-white font-black text-2xl md:text-3xl tracking-wide">ğŸ¤– ç«‹å³é€²å…¥ChatBotç‰ˆé¢</span>
<div class="absolute -inset-1 bg-gradient-to-r from-blue-400 via-purple-500 to-pink-500 rounded-3xl blur opacity-20 group-hover:opacity-50 transition-opacity duration-500"></div>
</button>
</div>

</div>

<!-- åº•éƒ¨ä¿¡æ¯ -->
<div class="text-center animate-fade-in">
<p class="text-white font-black text-lg md:text-xl leading-loose max-w-4xl mx-auto">
æˆ‘å€‘å¹³å°æœƒ <span class="text-blue-300">[ä»¥äººç‚ºä¸­å¿ƒ]</span> ä½œç‚ºé¦–è¦è€ƒæ…®çš„å› ç´ , å¸Œæœ›å¯ä»¥åˆ©ç”¨ è¨­è¨ˆæ€ç¶­ä»¥ä¸Šçš„äº”æ­¥é©Ÿ, ä»¥åŠç‰ˆé¢çš„ç°¡ä»‹, ç¬¦åˆ ç”¨å®¶çš„å„ç¨®éœ€æ±‚, å‹™æ±‚åšåˆ° ç‚ºäººé¡è§£æ±ºå•é¡Œ
</p>
</div>

</div>
</div>

<!-- ç¬¬äºŒé ï¼šChatBotåŠ©æ‰‹ç‰ˆé¢ -->
<div id="chatPage" class="page">

<!-- å´é‚Šæ¬„é®ç½© -->
<div id="sidebarOverlay" class="fixed inset-0 bg-black bg-opacity-70 z-40 hidden md:hidden smooth-transition"></div>

<!-- å´é‚Šæ¬„ -->
<div id="sidebar" class="sidebar fixed top-0 left-0 h-full z-50 flex flex-col">

<!-- å´é‚Šæ¬„æ¨™é¡Œ -->
<div class="p-8 border-b border-white border-opacity-20">
<div class="flex items-center justify-between">
<h2 class="text-xl font-black text-white">ğŸ’¬ å°è©±ç´€éŒ„</h2>
<!-- é—œé–‰æŒ‰éˆ• -->
<button id="closeSidebar" class="text-white hover:bg-white hover:bg-opacity-20 p-3 rounded-xl transition-all duration-200 button-hover-lift" title="é—œé–‰å°è©±ç´€éŒ„">
<svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
</svg>
</button>
</div>
</div>

<!-- æ–°å°è©±æŒ‰éˆ• -->
<div class="p-6">
<button id="newChatBtn" class="w-full bg-white bg-opacity-20 hover:bg-opacity-30 text-white font-black py-4 px-6 rounded-2xl transition-all duration-300 flex items-center justify-center space-x-4 button-hover-lift animate-glow-pulse">
<svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
</svg>
<span class="text-lg">æ–°å°è©±</span>
</button>
</div>

<!-- å°è©±ç´€éŒ„åˆ—è¡¨ -->
<div class="flex-1 overflow-y-auto scroll-area px-6 pb-4">
<div id="conversationList">
<!-- å°è©±é …ç›®å°‡åœ¨é€™è£¡å‹•æ…‹ç”Ÿæˆ -->
</div>
</div>

<!-- åº•éƒ¨æŒ‰éˆ• - æ”¹ç‚ºè¿”å›åˆ°ChatBot -->
<div class="p-6 border-t border-white border-opacity-20">
<div class="grid grid-cols-1 gap-4">
<button id="backToChatBotBtn" class="border-2 border-purple-400 bg-transparent hover:bg-purple-500 hover:bg-opacity-20 text-white font-bold py-4 px-5 rounded-2xl transition-all duration-300 flex items-center justify-center space-x-3 text-base button-hover-lift">
<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
</svg>
<span>è¿”å›åˆ°ChatBot</span>
</button>
<button id="backToHomeBtn" class="border-2 border-blue-400 bg-transparent hover:bg-blue-500 hover:bg-opacity-20 text-white font-bold py-4 px-5 rounded-2xl transition-all duration-300 flex items-center justify-center space-x-3 text-base button-hover-lift">
<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m0-11l7 7m0-5v5a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-1a1 1 0 011-1h2a1 1 0 011 1v1a1 1 0 001 1m-6 0h6"></path>
</svg>
<span>è¿”å›ä¸»é </span>
</button>
</div>
</div>

</div>

<!-- ä¸»è¦å…§å®¹å€ -->
<div class="flex-1 flex flex-col h-screen ml-0 md:ml-0">

<!-- é ‚éƒ¨æ¨™é¡Œæ¬„ -->
<header class="glass-effect p-6 flex items-center justify-between border-b border-white border-opacity-10">
<div class="flex items-center space-x-6">
<button id="openSidebar" class="text-white hover:bg-white hover:bg-opacity-20 p-3 rounded-xl transition-all duration-200 button-hover-lift">
<svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
</svg>
</button>

<div class="flex items-center space-x-5">
<!-- Design Thinking AI Logo - ChatBotç‰ˆæœ¬ -->
<div class="w-16 h-16 bg-gradient-to-br from-gray-900 via-blue-900 to-cyan-900 rounded-full flex items-center justify-center animate-float border-3 border-cyan-400 shadow-lg relative overflow-hidden">

<!-- ä¸»è¦AIè…¦éƒ¨é›»è·¯Logo -->
<div class="relative z-10 flex items-center justify-center w-full h-full">
<svg class="w-12 h-12 text-cyan-400" viewBox="0 0 200 200" fill="none" stroke="currentColor">

<!-- äººé¡é ­éƒ¨å´é¢è¼ªå»“ -->
<path d="M60 180 C40 170, 30 150, 30 130 C30 120, 32 110, 35 100 C35 90, 35 80, 40 70 C45 50, 55 35, 70 25 C80 20, 90 18, 100 18 C110 18, 120 20, 130 25 C140 30, 148 38, 155 48 C160 55, 163 63, 165 72 C167 80, 168 88, 168 96 C168 105, 167 114, 165 122 C163 130, 160 137, 156 144 C152 150, 147 156, 140 160 C130 166, 118 170, 105 172 C95 174, 85 175, 75 175 C70 176, 65 178, 60 180 Z" stroke-width="1.5" fill="none"/>

<!-- å¤§è…¦è¼ªå»“ -->
<path d="M70 25 C85 15, 105 15, 125 20 C140 25, 150 35, 155 50 C158 65, 155 80, 150 95 C145 110, 135 125, 120 135 C105 145, 85 145, 70 140 C55 135, 45 125, 42 110 C40 95, 42 80, 45 65 C48 50, 55 35, 70 25 Z" stroke-width="1" fill="none"/>

<!-- AIé›»è·¯æ¿åœ–æ¡ˆ - æ°´å¹³ç·šæ¢ -->
<g stroke-width="0.8" opacity="0.8">
<line x1="55" y1="45" x2="135" y2="45"/>
<line x1="60" y1="55" x2="130" y2="55"/>
<line x1="65" y1="65" x2="125" y2="65"/>
<line x1="70" y1="75" x2="120" y2="75"/>
<line x1="75" y1="85" x2="115" y2="85"/>
<line x1="80" y1="95" x2="110" y2="95"/>
<line x1="85" y1="105" x2="105" y2="105"/>
</g>

<!-- AIé›»è·¯æ¿åœ–æ¡ˆ - å‚ç›´ç·šæ¢ -->
<g stroke-width="0.8" opacity="0.7">
<line x1="75" y1="35" x2="75" y2="115"/>
<line x1="90" y1="40" x2="90" y2="110"/>
<line x1="105" y1="35" x2="105" y2="115"/>
<line x1="120" y1="40" x2="120" y2="110"/>
</g>

<!-- é›»è·¯ç¯€é» -->
<g fill="currentColor" opacity="0.8">
<circle cx="75" cy="45" r="1.5"/>
<circle cx="105" cy="50" r="1.5"/>
<circle cx="90" cy="70" r="1.5"/>
<circle cx="120" cy="80" r="1.5"/>
<circle cx="100" cy="90" r="1.5"/>
</g>

<!-- è¤‡é›œé›»è·¯é€£æ¥ç·š -->
<g stroke-width="0.6" opacity="0.6">
<path d="M75 45 L90 70 L120 80" fill="none"/>
<path d="M105 50 L100 90" fill="none"/>
</g>

<!-- å¾®è™•ç†å™¨æ–¹å¡Š -->
<g stroke-width="0.8" fill="none" opacity="0.7">
<rect x="85" y="60" width="15" height="10" rx="1"/>
<rect x="95" y="80" width="12" height="8" rx="1"/>
</g>

</svg>
</div>

<!-- å¢å¼·é–ƒçˆæ•ˆæœ -->
<div class="absolute inset-0 bg-gradient-to-br from-cyan-300 via-transparent to-blue-400 opacity-15 animate-pulse"></div>

<!-- ç™¼å…‰å…‰ç’°æ•ˆæœ -->
<div class="absolute -inset-1 bg-gradient-to-r from-cyan-400 to-blue-500 rounded-full blur opacity-25 animate-pulse"></div>

</div>

<div>
<h1 class="text-xl md:text-2xl font-black text-white">Design Thinking AI - è¨­è¨ˆæ€ç¶­äººå·¥æ™ºèƒ½èŠå¤©æ©Ÿæ¢°äºº</h1>
<p class="text-sm md:text-base text-blue-200 font-bold">æ™ºèƒ½å°è©±åŠ©æ‰‹</p>
</div>

</div>
</div>
</header>

<!-- èŠå¤©å€åŸŸ -->
<div class="flex-1 overflow-y-auto scroll-area p-6" id="chatArea">
<div id="messagesContainer" class="space-y-8 max-w-6xl mx-auto">
<!-- æ­¡è¿æ¶ˆæ¯æœƒåœ¨é€™è£¡å‹•æ…‹åŠ è¼‰ -->
</div>
</div>

<!-- è¼¸å…¥å€åŸŸ - é€²ä¸€æ­¥ç¸®å° -->
<div class="glass-effect border-t border-white border-opacity-10 p-2">

<!-- æ–‡ä»¶ä¸Šå‚³é¸é … -->
<div id="fileUploadOptions" class="hidden max-w-6xl mx-auto mb-2 p-3 bg-white bg-opacity-10 rounded-xl border border-white border-opacity-20 animate-slide-down">
<div class="flex items-center justify-between mb-2">
<h4 class="text-white font-black text-sm">ğŸ“ æ–°å¢æª”æ¡ˆ</h4>
<button id="closeFileOptions" class="text-white hover:text-red-300 p-1 rounded-lg transition-all duration-200 button-hover-lift">
<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
</svg>
</button>
</div>

<div class="grid grid-cols-1 gap-2">
<!-- ç…§ç‰‡ä¸Šå‚³ -->
<div class="file-upload-area flex items-center space-x-2 p-2 bg-white bg-opacity-10 rounded-xl hover:bg-opacity-20 transition-all duration-300">
<div class="w-8 h-8 bg-blue-500 bg-opacity-30 rounded-xl flex items-center justify-center">
<svg class="w-5 h-5 text-blue-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
</svg>
</div>
<div class="flex-1">
<label for="photoUpload" class="cursor-pointer">
<span class="text-white font-black text-xs">ä¸Šå‚³ç…§ç‰‡</span>
<p class="text-blue-200 font-bold text-xs">æ”¯æ´æ ¼å¼ï¼šJPEG, JPG, PNG, TIFF, WebP</p>
</label>
<input type="file" id="photoUpload" class="hidden" accept=".jpeg,.jpg,.png,.tiff,.webp" multiple>
</div>
</div>

<!-- å½±ç‰‡ä¸Šå‚³ -->
<div class="file-upload-area flex items-center space-x-2 p-2 bg-white bg-opacity-10 rounded-xl hover:bg-opacity-20 transition-all duration-300">
<div class="w-8 h-8 bg-purple-500 bg-opacity-30 rounded-xl flex items-center justify-center">
<svg class="w-5 h-5 text-purple-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
</svg>
</div>
<div class="flex-1">
<label for="videoUpload" class="cursor-pointer">
<span class="text-white font-black text-xs">ä¸Šå‚³å½±ç‰‡</span>
<p class="text-blue-200 font-bold text-xs">æ”¯æ´æ ¼å¼ï¼šMP4, MOV, WMV, WebM</p>
</label>
<input type="file" id="videoUpload" class="hidden" accept=".mp4,.mov,.wmv,.webm" multiple>
</div>
</div>

<!-- æ–‡å­—æª”æ¡ˆä¸Šå‚³ -->
<div class="file-upload-area flex items-center space-x-2 p-2 bg-white bg-opacity-10 rounded-xl hover:bg-opacity-20 transition-all duration-300" onclick="document.getElementById('documentUpload').click()">
<div class="w-8 h-8 bg-green-500 bg-opacity-30 rounded-xl flex items-center justify-center">
<svg class="w-5 h-5 text-green-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
</svg>
</div>
<div class="flex-1 cursor-pointer">
<span class="text-white font-black text-xs">ä¸Šå‚³æ–‡å­—æª”æ¡ˆ</span>
<p class="text-blue-200 font-bold text-xs">æ”¯æ´æ ¼å¼ï¼šDOC, DOCX, PDF, TXT, XLS, XLSX</p>
<input type="file" id="documentUpload" class="hidden" accept=".doc,.docx,.pdf,.txt,.xls,.xlsx,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document,application/pdf,text/plain,application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" multiple>
</div>
</div>

</div>
</div>

<!-- å·²ä¸Šå‚³æ–‡ä»¶é è¦½ -->
<div id="uploadedFiles" class="hidden max-w-6xl mx-auto mb-2"></div>

<form id="chatForm" class="flex items-end space-x-2 max-w-6xl mx-auto">
<!-- æ–‡ä»¶ä¸Šå‚³æŒ‰éˆ• -->
<button type="button" id="fileUploadToggle" class="bg-green-600 hover:bg-green-700 text-white p-2 rounded-xl transition-all duration-300 flex-shrink-0 button-hover-lift animate-glow-pulse">
<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
</svg>
</button>

<div class="flex-1">
<textarea 
id="messageInput" 
placeholder="è¼¸å…¥æ‚¨çš„è¨Šæ¯ï¼ˆç„¡å­—æ•¸é™åˆ¶ï¼‰..." 
class="w-full p-3 bg-white bg-opacity-10 border-2 border-white border-opacity-20 rounded-xl text-white placeholder-blue-200 resize-none focus:outline-none focus:ring-2 focus:ring-blue-400 font-bold text-base input-focus-glow smooth-transition"
rows="1"
></textarea>
</div>

<button 
type="submit" 
id="sendBtn"
disabled
class="bg-blue-600 hover:bg-blue-700 disabled:bg-gray-600 disabled:cursor-not-allowed text-white p-2 rounded-xl transition-all duration-300 animate-glow-pulse shadow-lg border-2 border-blue-400 button-hover-lift"
title="ğŸ“¤ ç™¼é€è¨Šæ¯"
>
<div class="flex items-center justify-center">
<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
<path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
</svg>
<span class="sr-only">ç™¼é€è¨Šæ¯</span>
</div>
</button>
</form>

</div>

</div>

<!-- LoadingæŒ‡ç¤ºå™¨å®Œå…¨éš±è— -->
<div id="loadingIndicator" style="display: none !important;" class="hidden"></div>

</div>

<script>
// å…¨å±€è®Šé‡
let typewriterQueue = [];
let isTyping = false;

// é é¢å°èˆªç³»çµ±
class PageManager {
constructor() {
this.currentPage = 'homePage';
this.setupNavigation();
}

setupNavigation() {
// é€²å…¥ChatBotæŒ‰éˆ•
document.getElementById('enterChatBotBtn').addEventListener('click', () => {
this.showPage('chatPage');
// åˆå§‹åŒ–ChatBotæ‡‰ç”¨
if (!window.chatBotApp) {
window.chatBotApp = new ChatBotApp();
}
});

// è¿”å›ä¸»é æŒ‰éˆ•
document.getElementById('backToHomeBtn').addEventListener('click', () => {
this.showPage('homePage');
});

// è¿”å›åˆ°ChatBotæŒ‰éˆ•
document.getElementById('backToChatBotBtn').addEventListener('click', () => {
if (window.chatBotApp) {
window.chatBotApp.closeSidebar();
}
});
}

showPage(pageId) {
// éš±è—æ‰€æœ‰é é¢
document.querySelectorAll('.page').forEach(page => {
page.classList.remove('active');
});

// é¡¯ç¤ºæŒ‡å®šé é¢
document.getElementById(pageId).classList.add('active');
this.currentPage = pageId;

// é‡ç½®æ»¾å‹•ä½ç½®
document.body.scrollTop = 0;
document.documentElement.scrollTop = 0;
}
}

// å¢å¼·ç‰ˆæ‰“å­—æ©Ÿæ•ˆæœé¡
class TypewriterEffect {
constructor() {
this.queue = [];
this.isProcessing = false;
}

async typeText(elementId, text, speed = 20) {
return new Promise((resolve) => {
this.queue.push({
elementId,
text,
speed,
resolve
});

if (!this.isProcessing) {
this.processQueue();
}
});
}

async processQueue() {
if (this.queue.length === 0) {
this.isProcessing = false;
return;
}

this.isProcessing = true;
const { elementId, text, speed, resolve } = this.queue.shift();

const element = document.getElementById(elementId);
if (!element) {
resolve();
this.processQueue();
return;
}

element.innerHTML = '';
let charIndex = 0;

const typeChar = () => {
if (charIndex < text.length) {
const char = text.charAt(charIndex);
const span = document.createElement('span');
span.textContent = char;
span.className = 'char-container';
span.style.animationDelay = `${charIndex * 0.02}s`;
element.appendChild(span);

// è§¸ç™¼å‹•ç•«
setTimeout(() => {
span.style.animation = 'char-pop 0.15s ease-out forwards';
}, 10);

charIndex++;
setTimeout(typeChar, speed);
} else {
// ç§»é™¤å…‰æ¨™
const cursor = element.nextSibling;
if (cursor && cursor.classList && cursor.classList.contains('typewriter-cursor')) {
cursor.style.display = 'none';
}
resolve();
this.processQueue();
}
};

typeChar();
}

clear() {
this.queue = [];
this.isProcessing = false;
}
}

// ChatBotæ‡‰ç”¨é¡
class ChatBotApp {
constructor() {
this.typewriter = new TypewriterEffect();
this.storageAvailable = this.checkStorageAvailability();
this.conversations = this.loadConversationsFromStorage();
this.currentConversationId = this.loadCurrentConversationId();
this.uploadedFiles = new Map();
this.messageCounter = 0;
this.init();
}

checkStorageAvailability() {
const capabilities = {
localStorage: false,
sessionStorage: false,
indexedDB: false,
memory: true
};

// æª¢æ¸¬ localStorage
try {
const testKey = '__storage_test__';
localStorage.setItem(testKey, 'test');
localStorage.removeItem(testKey);
capabilities.localStorage = true;
} catch (e) {
console.warn('localStorage ä¸å¯ç”¨:', e);
}

// æª¢æ¸¬ sessionStorage
try {
const testKey = '__session_test__';
sessionStorage.setItem(testKey, 'test');
sessionStorage.removeItem(testKey);
capabilities.sessionStorage = true;
} catch (e) {
console.warn('sessionStorage ä¸å¯ç”¨:', e);
}

// æª¢æ¸¬ IndexedDB
try {
if ('indexedDB' in window) {
capabilities.indexedDB = true;
}
} catch (e) {
console.warn('IndexedDB ä¸å¯ç”¨:', e);
}

return capabilities;
}

async loadConversationsFromStorage() {
console.log('ğŸ”„ é–‹å§‹è¼‰å…¥å°è©±è¨˜éŒ„...');

try {
// ç”Ÿæˆè¨­å‚™æŒ‡ç´‹
this.deviceFingerprint = await this.generateDeviceFingerprint();
console.log('ğŸ”’ è¨­å‚™æŒ‡ç´‹:', this.deviceFingerprint);

// å¤šé‡å­˜å„²è¼‰å…¥ç­–ç•¥
let conversations = [];

// ç¬¬ä¸€å„ªå…ˆç´šï¼šlocalStorage
if (this.storageAvailable.localStorage) {
const localData = localStorage.getItem(`chatbot_conversations_${this.deviceFingerprint}`);
if (localData) {
try {
conversations = JSON.parse(localData);
console.log('âœ… å¾ localStorage è¼‰å…¥å°è©±è¨˜éŒ„:', conversations.length, 'å€‹å°è©±');
} catch (e) {
console.warn('localStorage æ•¸æ“šè§£æå¤±æ•—:', e);
}
}

// å˜—è©¦è¼‰å…¥å…¨å±€å‚™ä»½
if (conversations.length === 0) {
const globalData = localStorage.getItem('chatbot_conversations');
if (globalData) {
try {
conversations = JSON.parse(globalData);
console.log('âœ… å¾å…¨å±€ localStorage è¼‰å…¥å°è©±è¨˜éŒ„:', conversations.length, 'å€‹å°è©±');
} catch (e) {
console.warn('å…¨å±€ localStorage æ•¸æ“šè§£æå¤±æ•—:', e);
}
}
}
}

// ç¬¬äºŒå„ªå…ˆç´šï¼šsessionStorage
if (conversations.length === 0 && this.storageAvailable.sessionStorage) {
const sessionData = sessionStorage.getItem(`chatbot_conversations_${this.deviceFingerprint}`);
if (sessionData) {
try {
conversations = JSON.parse(sessionData);
console.log('âœ… å¾ sessionStorage è¼‰å…¥å°è©±è¨˜éŒ„:', conversations.length, 'å€‹å°è©±');
} catch (e) {
console.warn('sessionStorage æ•¸æ“šè§£æå¤±æ•—:', e);
}
}
}

// ç¬¬ä¸‰å„ªå…ˆç´šï¼šIndexedDB
if (conversations.length === 0 && this.storageAvailable.indexedDB) {
try {
conversations = await this.loadFromIndexedDB();
console.log('âœ… å¾ IndexedDB è¼‰å…¥å°è©±è¨˜éŒ„:', conversations.length, 'å€‹å°è©±');
} catch (e) {
console.warn('IndexedDB è¼‰å…¥å¤±æ•—:', e);
}
}

// ç¬¬å››å„ªå…ˆç´šï¼šå…§å­˜å­˜å„²
if (conversations.length === 0) {
if (!window.__chatbot_memory_storage) {
window.__chatbot_memory_storage = {};
}
conversations = window.__chatbot_memory_storage.conversations || [];
console.log('âœ… å¾å…§å­˜è¼‰å…¥å°è©±è¨˜éŒ„:', conversations.length, 'å€‹å°è©±');
}

// æ•¸æ“šå®Œæ•´æ€§æª¢æŸ¥å’Œä¿®å¾©
conversations = this.validateAndRepairConversations(conversations);

// å¦‚æœæˆåŠŸè¼‰å…¥æ•¸æ“šï¼Œç«‹å³ä¿å­˜åˆ°å…¶ä»–å­˜å„²ä½ç½®ä½œç‚ºå‚™ä»½
if (conversations.length > 0) {
this.createBackups(conversations);
}

console.log('ğŸ‰ å°è©±è¨˜éŒ„è¼‰å…¥å®Œæˆï¼Œç¸½è¨ˆ:', conversations.length, 'å€‹å°è©±');
return conversations;

} catch (error) {
console.error('âŒ è¼‰å…¥å°è©±ç´€éŒ„å¤±æ•—:', error);
this.showToast('âš ï¸ éƒ¨åˆ†å°è©±è¨˜éŒ„è¼‰å…¥å¤±æ•—ï¼Œä½†ç³»çµ±ä»å¯æ­£å¸¸ä½¿ç”¨', 'warning');
return [];
}
}

loadCurrentConversationId() {
try {
if (this.storageAvailable === 'localStorage') {
return localStorage.getItem('chatbot_current_conversation');
} else if (this.storageAvailable === 'sessionStorage') {
return sessionStorage.getItem('chatbot_current_conversation');
} else {
if (!window.__chatbot_memory_storage) {
window.__chatbot_memory_storage = {};
}
return window.__chatbot_memory_storage.currentConversationId || null;
}
} catch (error) {
console.error('è¼‰å…¥ç•¶å‰å°è©±IDå¤±æ•—:', error);
return null;
}
}

async init() {
console.log('ğŸš€ åˆå§‹åŒ– Design Thinking AI è¶…ç´šå¼·åŒ–å­˜å„²ç³»çµ±...');

this.setupEventListeners();
this.setupDarkModeDetection();

// ç•°æ­¥è¼‰å…¥å°è©±è¨˜éŒ„
this.conversations = await this.loadConversationsFromStorage();
this.loadConversations();

this.setupAutoSave();
this.setupDragAndDrop();
this.setupAdvancedStorageSystem();

// å¦‚æœæ²’æœ‰å°è©±ï¼Œå‰µå»ºç¬¬ä¸€å€‹
if (this.conversations.length === 0) {
this.createNewConversation();
} else {
// è¼‰å…¥æ­¡è¿æ¶ˆæ¯
this.addWelcomeMessage();
this.showToast('âœ… æˆåŠŸè¼‰å…¥æ‚¨çš„å°è©±è¨˜éŒ„', 'success');
}

console.log('ğŸ‰ Design Thinking AI åˆå§‹åŒ–å®Œæˆï¼');
}

// ç”Ÿæˆè¨­å‚™æŒ‡ç´‹
async generateDeviceFingerprint() {
const canvas = document.createElement('canvas');
const ctx = canvas.getContext('2d');
ctx.textBaseline = 'top';
ctx.font = '14px Arial';
ctx.fillText('Design Thinking AI Device Fingerprint', 2, 2);

const fingerprint = {
screen: `${screen.width}x${screen.height}`,
timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
language: navigator.language,
platform: navigator.platform,
cookieEnabled: navigator.cookieEnabled,
doNotTrack: navigator.doNotTrack,
canvas: canvas.toDataURL(),
userAgent: navigator.userAgent.slice(0, 100), // æˆªçŸ­ä»¥ç¯€çœç©ºé–“
hardwareConcurrency: navigator.hardwareConcurrency || 1,
timestamp: new Date().toISOString().slice(0, 10) // åªä¿ç•™æ—¥æœŸéƒ¨åˆ†ï¼Œä½¿æŒ‡ç´‹åœ¨ä¸€å¤©å…§ä¿æŒä¸€è‡´
};

// ç”Ÿæˆè¨­å‚™æŒ‡ç´‹å“ˆå¸Œ
const fingerprintString = JSON.stringify(fingerprint);
let hash = 0;
for (let i = 0; i < fingerprintString.length; i++) {
const char = fingerprintString.charCodeAt(i);
hash = ((hash << 5) - hash) + char;
hash = hash & hash; // è½‰æ›ç‚º32ä½æ•´æ•¸
}

return Math.abs(hash).toString(36);
}

// å¾IndexedDBè¼‰å…¥æ•¸æ“š
async loadFromIndexedDB() {
return new Promise((resolve, reject) => {
const request = indexedDB.open('DesignThinkingAI_ChatBot', 1);

request.onerror = () => reject(request.error);

request.onsuccess = () => {
const db = request.result;
const transaction = db.transaction(['conversations'], 'readonly');
const store = transaction.objectStore('conversations');
const getRequest = store.get(`conversations_${this.deviceFingerprint}`);

getRequest.onsuccess = () => {
resolve(getRequest.result ? getRequest.result.data : []);
};

getRequest.onerror = () => reject(getRequest.error);
};

request.onupgradeneeded = (event) => {
const db = event.target.result;
if (!db.objectStoreNames.contains('conversations')) {
db.createObjectStore('conversations', { keyPath: 'id' });
}
};
});
}

// ä¿å­˜åˆ°IndexedDB
async saveToIndexedDB(conversations) {
return new Promise((resolve, reject) => {
const request = indexedDB.open('DesignThinkingAI_ChatBot', 1);

request.onerror = () => reject(request.error);

request.onsuccess = () => {
const db = request.result;
const transaction = db.transaction(['conversations'], 'readwrite');
const store = transaction.objectStore('conversations');

const data = {
id: `conversations_${this.deviceFingerprint}`,
data: conversations,
timestamp: new Date().toISOString(),
version: '2.0'
};

const putRequest = store.put(data);

putRequest.onsuccess = () => resolve();
putRequest.onerror = () => reject(putRequest.error);
};

request.onupgradeneeded = (event) => {
const db = event.target.result;
if (!db.objectStoreNames.contains('conversations')) {
db.createObjectStore('conversations', { keyPath: 'id' });
}
};
});
}

// æ•¸æ“šå®Œæ•´æ€§æª¢æŸ¥å’Œä¿®å¾©
validateAndRepairConversations(conversations) {
if (!Array.isArray(conversations)) {
console.warn('å°è©±æ•¸æ“šæ ¼å¼éŒ¯èª¤ï¼Œé‡æ–°åˆå§‹åŒ–');
return [];
}

const repairedConversations = conversations.map(conv => {
// ç¢ºä¿å°è©±å°è±¡æœ‰å¿…è¦çš„å±¬æ€§
const repaired = {
id: conv.id || Date.now().toString(),
name: conv.name || 'æœªå‘½åå°è©±',
messages: Array.isArray(conv.messages) ? conv.messages : [],
createdAt: conv.createdAt || new Date().toISOString(),
lastUpdated: conv.lastUpdated || conv.createdAt || new Date().toISOString()
};

// é©—è­‰å’Œä¿®å¾©è¨Šæ¯
repaired.messages = repaired.messages.map(msg => ({
content: msg.content || '',
isUser: Boolean(msg.isUser),
timestamp: msg.timestamp || new Date().toISOString()
}));

return repaired;
}).filter(conv => conv.id); // ç§»é™¤ç„¡æ•ˆçš„å°è©±

console.log(`âœ… æ•¸æ“šå®Œæ•´æ€§æª¢æŸ¥å®Œæˆï¼Œä¿®å¾©äº† ${conversations.length - repairedConversations.length} å€‹æå£çš„å°è©±`);
return repairedConversations;
}

// å‰µå»ºå¤šé‡å‚™ä»½
async createBackups(conversations) {
const backupPromises = [];

// localStorage å‚™ä»½
if (this.storageAvailable.localStorage) {
try {
localStorage.setItem(`chatbot_conversations_${this.deviceFingerprint}`, JSON.stringify(conversations));
localStorage.setItem('chatbot_conversations', JSON.stringify(conversations)); // å…¨å±€å‚™ä»½
localStorage.setItem('chatbot_backup_timestamp', new Date().toISOString());
} catch (e) {
console.warn('localStorage å‚™ä»½å¤±æ•—:', e);
}
}

// sessionStorage å‚™ä»½
if (this.storageAvailable.sessionStorage) {
try {
sessionStorage.setItem(`chatbot_conversations_${this.deviceFingerprint}`, JSON.stringify(conversations));
} catch (e) {
console.warn('sessionStorage å‚™ä»½å¤±æ•—:', e);
}
}

// IndexedDB å‚™ä»½
if (this.storageAvailable.indexedDB) {
backupPromises.push(
this.saveToIndexedDB(conversations).catch(e => {
console.warn('IndexedDB å‚™ä»½å¤±æ•—:', e);
})
);
}

// å…§å­˜å‚™ä»½
if (!window.__chatbot_memory_storage) {
window.__chatbot_memory_storage = {};
}
window.__chatbot_memory_storage.conversations = conversations;
window.__chatbot_memory_storage.timestamp = new Date().toISOString();

await Promise.all(backupPromises);
console.log('ğŸ”„ å¤šé‡å‚™ä»½å‰µå»ºå®Œæˆ');
}

// è¨­ç½®é«˜ç´šå­˜å„²ç³»çµ±
setupAdvancedStorageSystem() {
// æ¯30ç§’è‡ªå‹•å‚™ä»½
setInterval(() => {
if (this.conversations && this.conversations.length > 0) {
this.createBackups(this.conversations);
}
}, 30000);

// æ¯5åˆ†é˜é€²è¡Œæ•¸æ“šå®Œæ•´æ€§æª¢æŸ¥
setInterval(() => {
this.performIntegrityCheck();
}, 300000);

// æª¢æ¸¬ç€è¦½å™¨é—œé–‰/åˆ·æ–°
window.addEventListener('beforeunload', () => {
console.log('ğŸ”„ ç€è¦½å™¨é—œé–‰å‰è‡ªå‹•ä¿å­˜...');
this.performEmergencyBackup();
});

// æª¢æ¸¬é é¢å¯è¦‹æ€§è®ŠåŒ–
document.addEventListener('visibilitychange', () => {
if (document.visibilityState === 'hidden') {
console.log('ğŸ”„ é é¢éš±è—æ™‚è‡ªå‹•ä¿å­˜...');
this.performEmergencyBackup();
}
});

// æª¢æ¸¬ç¶²è·¯ç‹€æ…‹è®ŠåŒ–
window.addEventListener('online', () => {
console.log('ğŸŒ ç¶²è·¯æ¢å¾©ï¼ŒåŸ·è¡Œæ•¸æ“šåŒæ­¥...');
this.performDataSync();
});

window.addEventListener('offline', () => {
console.log('ğŸ“¡ ç¶²è·¯ä¸­æ–·ï¼Œå•Ÿç”¨é›¢ç·šæ¨¡å¼...');
this.enableOfflineMode();
});
}

// åŸ·è¡Œæ•¸æ“šå®Œæ•´æ€§æª¢æŸ¥
async performIntegrityCheck() {
try {
const originalCount = this.conversations.length;
this.conversations = this.validateAndRepairConversations(this.conversations);

if (this.conversations.length !== originalCount) {
console.log('âš ï¸ ç™¼ç¾æ•¸æ“šå•é¡Œï¼Œå·²è‡ªå‹•ä¿®å¾©');
this.saveConversations();
}

// æª¢æŸ¥å­˜å„²å®¹é‡
if (this.storageAvailable.localStorage) {
const usage = this.calculateStorageUsage();
if (usage > 0.8) { // è¶…é80%ä½¿ç”¨ç‡
console.warn('âš ï¸ å­˜å„²ç©ºé–“ä¸è¶³ï¼Œé–‹å§‹æ¸…ç†èˆŠæ•¸æ“š');
this.cleanupOldData();
}
}
} catch (error) {
console.error('âŒ æ•¸æ“šå®Œæ•´æ€§æª¢æŸ¥å¤±æ•—:', error);
}
}

// è¨ˆç®—å­˜å„²ä½¿ç”¨ç‡
calculateStorageUsage() {
try {
let total = 0;
for (let key in localStorage) {
if (localStorage.hasOwnProperty(key)) {
total += localStorage[key].length;
}
}
// å‡è¨­ localStorage é™åˆ¶ç‚º 5MB
return total / (5 * 1024 * 1024);
} catch (e) {
return 0;
}
}

// æ¸…ç†èˆŠæ•¸æ“š
cleanupOldData() {
try {
// åªä¿ç•™æœ€è¿‘30å¤©çš„å°è©±
const thirtyDaysAgo = new Date();
thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

const originalLength = this.conversations.length;
this.conversations = this.conversations.filter(conv => {
const convDate = new Date(conv.lastUpdated || conv.createdAt);
return convDate > thirtyDaysAgo;
});

const removedCount = originalLength - this.conversations.length;
if (removedCount > 0) {
console.log(`ğŸ§¹ æ¸…ç†äº† ${removedCount} å€‹èˆŠå°è©±`);
this.saveConversations();
this.showToast(`å·²æ¸…ç† ${removedCount} å€‹èˆŠå°è©±ä»¥é‡‹æ”¾ç©ºé–“`, 'info');
}
} catch (error) {
console.error('âŒ æ¸…ç†èˆŠæ•¸æ“šå¤±æ•—:', error);
}
}

// ç·Šæ€¥å‚™ä»½
performEmergencyBackup() {
try {
// åŒæ­¥åŸ·è¡Œå¿«é€Ÿå‚™ä»½
const data = JSON.stringify(this.conversations);

if (this.storageAvailable.localStorage) {
localStorage.setItem(`emergency_backup_${this.deviceFingerprint}`, data);
localStorage.setItem('emergency_backup_timestamp', new Date().toISOString());
}

// å…§å­˜å‚™ä»½
window.__chatbot_emergency_backup = {
conversations: this.conversations,
timestamp: new Date().toISOString(),
deviceFingerprint: this.deviceFingerprint
};

console.log('ğŸš¨ ç·Šæ€¥å‚™ä»½å®Œæˆ');
} catch (error) {
console.error('âŒ ç·Šæ€¥å‚™ä»½å¤±æ•—:', error);
}
}

// æ•¸æ“šåŒæ­¥
async performDataSync() {
try {
// æª¢æŸ¥æ˜¯å¦æœ‰ç·Šæ€¥å‚™ä»½éœ€è¦æ¢å¾©
const emergencyBackup = localStorage.getItem(`emergency_backup_${this.deviceFingerprint}`);
if (emergencyBackup) {
const backupData = JSON.parse(emergencyBackup);
const backupTimestamp = localStorage.getItem('emergency_backup_timestamp');

if (backupData.length > this.conversations.length) {
console.log('ğŸ”„ ç™¼ç¾ç·Šæ€¥å‚™ä»½æ•¸æ“šï¼Œæ­£åœ¨æ¢å¾©...');
this.conversations = this.validateAndRepairConversations(backupData);
this.loadConversations();
this.showToast('âœ… å·²æ¢å¾©ç·Šæ€¥å‚™ä»½æ•¸æ“š', 'success');
}

// æ¸…ç†ç·Šæ€¥å‚™ä»½
localStorage.removeItem(`emergency_backup_${this.deviceFingerprint}`);
localStorage.removeItem('emergency_backup_timestamp');
}

// åŸ·è¡Œæ­£å¸¸å‚™ä»½
await this.createBackups(this.conversations);
} catch (error) {
console.error('âŒ æ•¸æ“šåŒæ­¥å¤±æ•—:', error);
}
}

// å•Ÿç”¨é›¢ç·šæ¨¡å¼
enableOfflineMode() {
// å¢åŠ å…§å­˜å‚™ä»½é »ç‡
if (this.offlineBackupInterval) {
clearInterval(this.offlineBackupInterval);
}

this.offlineBackupInterval = setInterval(() => {
window.__chatbot_memory_storage.conversations = this.conversations;
window.__chatbot_memory_storage.timestamp = new Date().toISOString();
}, 10000); // æ¯10ç§’å‚™ä»½åˆ°å…§å­˜

this.showToast('ğŸ“¡ å·²åˆ‡æ›åˆ°é›¢ç·šæ¨¡å¼ï¼Œæ•¸æ“šå°‡ä¿å­˜åœ¨æœ¬åœ°', 'info');
}

setupEventListeners() {
// å´é‚Šæ¬„æ§åˆ¶
document.getElementById('openSidebar').addEventListener('click', () => this.openSidebar());
document.getElementById('closeSidebar').addEventListener('click', () => this.closeSidebar());
document.getElementById('sidebarOverlay').addEventListener('click', () => this.closeSidebar());

// é»æ“Šä¸»è¦èŠå¤©å€åŸŸé—œé–‰å´é‚Šæ¬„
this.setupChatAreaClick();

// èŠå¤©åŠŸèƒ½
document.getElementById('chatForm').addEventListener('submit', (e) => this.handleSendMessage(e));
document.getElementById('messageInput').addEventListener('input', (e) => this.handleInputChange(e));
document.getElementById('messageInput').addEventListener('keydown', (e) => this.handleKeyDown(e));

// å°è©±ç®¡ç†
document.getElementById('newChatBtn').addEventListener('click', () => this.createNewConversation());

// æ–‡ä»¶ä¸Šå‚³åŠŸèƒ½
document.getElementById('fileUploadToggle').addEventListener('click', () => this.toggleFileUploadOptions());
document.getElementById('closeFileOptions').addEventListener('click', () => this.hideFileUploadOptions());
document.getElementById('photoUpload').addEventListener('change', (e) => this.handleFileUpload(e, 'photo'));
document.getElementById('videoUpload').addEventListener('change', (e) => this.handleFileUpload(e, 'video'));
document.getElementById('documentUpload').addEventListener('change', (e) => this.handleFileUpload(e, 'document'));

// éŸ¿æ‡‰å¼è¨­è¨ˆ
window.addEventListener('resize', () => this.handleResize());

// éŒ¯èª¤è™•ç†
window.addEventListener('error', (e) => this.handleGlobalError(e));
window.addEventListener('unhandledrejection', (e) => this.handlePromiseRejection(e));
}

setupDarkModeDetection() {
if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
document.documentElement.classList.add('dark');
}

window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
if (event.matches) {
document.documentElement.classList.add('dark');
} else {
document.documentElement.classList.remove('dark');
}
});
}

setupDragAndDrop() {
const fileUploadAreas = document.querySelectorAll('.file-upload-area');
const chatArea = document.getElementById('chatArea');

// æ·»åŠ åˆ°èŠå¤©å€åŸŸçš„æ‹–æ‹½åŠŸèƒ½
[chatArea, ...fileUploadAreas].forEach(area => {
['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
area.addEventListener(eventName, this.preventDefaults, false);
});

['dragenter', 'dragover'].forEach(eventName => {
area.addEventListener(eventName, () => {
if (area.classList.contains('file-upload-area')) {
area.classList.add('drag-over');
}
}, false);
});

['dragleave', 'drop'].forEach(eventName => {
area.addEventListener(eventName, () => {
if (area.classList.contains('file-upload-area')) {
area.classList.remove('drag-over');
}
}, false);
});

area.addEventListener('drop', (e) => this.handleDrop(e), false);
});
}

preventDefaults(e) {
e.preventDefault();
e.stopPropagation();
}

handleDrop(e) {
const files = e.dataTransfer.files;
if (files.length > 0) {
this.handleFileSelection(Array.from(files));
}
}

createNewConversation() {
const newConversation = {
id: Date.now().toString(),
name: `å°è©± ${this.conversations.length + 1}`,
messages: [],
createdAt: new Date().toISOString(),
lastUpdated: new Date().toISOString()
};

this.conversations.unshift(newConversation);
this.currentConversationId = newConversation.id;
this.saveConversations();
this.loadConversations();
this.clearChat();
this.addWelcomeMessage();
this.closeSidebar();
this.showToast('âœ… å·²å»ºç«‹æ–°å°è©±', 'success');
}

loadConversations() {
const conversationList = document.getElementById('conversationList');
conversationList.innerHTML = '';

this.conversations.forEach((conv, index) => {
const item = document.createElement('div');
item.className = `conversation-item ${conv.id === this.currentConversationId ? 'active' : ''}`;

const lastUpdate = this.formatDateTime(new Date(conv.lastUpdated || conv.createdAt));

item.innerHTML = `
<div class="flex items-center justify-between">
<div class="flex-1 mr-3">
<span class="text-white font-black truncate text-base block">${conv.name}</span>
<span class="text-blue-200 font-bold text-sm">${lastUpdate}</span>
</div>
<div class="flex items-center space-x-2">
<button class="edit-conversation text-white hover:text-blue-200 p-2 rounded-xl transition-all duration-200 button-hover-lift" data-id="${conv.id}" title="ç·¨è¼¯åç¨±">
<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path>
</svg>
</button>
<button class="delete-conversation text-white hover:text-red-300 p-2 rounded-xl transition-all duration-200 button-hover-lift" data-id="${conv.id}" title="åˆªé™¤å°è©±">
<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
</svg>
</button>
</div>
</div>
`;

// é»æ“Šå°è©±é …ç›®
item.addEventListener('click', (e) => {
if (!e.target.closest('.edit-conversation') && !e.target.closest('.delete-conversation')) {
this.loadConversation(conv.id);
}
});

conversationList.appendChild(item);
});

// ç·¨è¼¯å’Œåˆªé™¤äº‹ä»¶
this.setupConversationActions();
}

setupConversationActions() {
document.addEventListener('click', (e) => {
if (e.target.closest('.edit-conversation')) {
e.preventDefault();
e.stopPropagation();
const id = e.target.closest('.edit-conversation').dataset.id;
this.editConversationName(id);
} else if (e.target.closest('.delete-conversation')) {
e.preventDefault();
e.stopPropagation();
const id = e.target.closest('.delete-conversation').dataset.id;
this.deleteConversation(id);
}
});
}

editConversationName(conversationId) {
const conversation = this.conversations.find(c => c.id === conversationId);
if (!conversation) return;

this.showCustomPrompt('ç·¨è¼¯å°è©±åç¨±', 'è«‹è¼¸å…¥æ–°çš„å°è©±åç¨±ï¼š', conversation.name, (newName) => {
if (newName && newName.trim()) {
conversation.name = newName.trim();
conversation.lastUpdated = new Date().toISOString();
this.saveConversations();
this.loadConversations();
this.showToast('âœ… å°è©±åç¨±å·²æ›´æ–°', 'success');
}
});
}

showCustomPrompt(title, message, defaultValue = '', onConfirm = () => {}) {
const modal = document.createElement('div');
modal.className = 'fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 animate-fade-in';

modal.innerHTML = `
<div class="bg-white dark:bg-gray-800 rounded-3xl shadow-2xl max-w-lg w-full mx-4 p-10 animate-scale-bounce border-2 border-gray-200 dark:border-gray-600">
<h3 class="text-xl font-black text-gray-900 dark:text-white mb-6">${title}</h3>
<p class="text-gray-700 dark:text-gray-300 font-bold mb-6 text-base">${message}</p>
<input type="text" id="customPromptInput" value="${defaultValue}" 
class="w-full p-5 border-2 border-gray-300 dark:border-gray-600 rounded-2xl 
bg-white dark:bg-gray-700 text-gray-900 dark:text-white 
font-bold text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500 
outline-none smooth-transition" placeholder="è¼¸å…¥å°è©±åç¨±...">
<div class="flex justify-end space-x-4 mt-8">
<button class="cancel-btn px-6 py-3 text-gray-600 dark:text-gray-400 
hover:bg-gray-100 dark:hover:bg-gray-700 rounded-2xl font-bold transition-all duration-200 button-hover-lift text-base">
å–æ¶ˆ
</button>
<button class="confirm-btn px-6 py-3 bg-blue-500 text-white 
hover:bg-blue-600 rounded-2xl font-bold transition-all duration-200 button-hover-lift text-base">
ç¢ºèª
</button>
</div>
</div>
`;

document.body.appendChild(modal);

const input = modal.querySelector('#customPromptInput');
const cancelBtn = modal.querySelector('.cancel-btn');
const confirmBtn = modal.querySelector('.confirm-btn');

setTimeout(() => {
input.focus();
input.select();
}, 100);

const closeModal = () => {
modal.style.opacity = '0';
modal.style.transform = 'scale(0.95)';
setTimeout(() => modal.remove(), 200);
};

const confirmAction = () => {
const value = input.value.trim();
closeModal();
onConfirm(value);
};

cancelBtn.addEventListener('click', closeModal);
confirmBtn.addEventListener('click', confirmAction);

modal.addEventListener('click', (e) => {
if (e.target === modal) {
closeModal();
}
});

input.addEventListener('keydown', (e) => {
if (e.key === 'Enter') {
e.preventDefault();
confirmAction();
} else if (e.key === 'Escape') {
e.preventDefault();
closeModal();
}
});
}

deleteConversation(conversationId) {
const conversation = this.conversations.find(c => c.id === conversationId);
if (!conversation) return;

if (this.conversations.length <= 1) {
this.showToast('âŒ è‡³å°‘éœ€è¦ä¿ç•™ä¸€å€‹å°è©±', 'error');
return;
}

this.showCustomConfirm('åˆªé™¤å°è©±', 'ç¢ºå®šè¦åˆªé™¤æ­¤å°è©±å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•æ’¤éŠ·ã€‚', () => {
this.conversations = this.conversations.filter(c => c.id !== conversationId);

if (this.currentConversationId === conversationId) {
this.currentConversationId = this.conversations[0]?.id || null;
if (this.currentConversationId) {
this.loadConversation(this.currentConversationId);
}
}

this.saveConversations();
this.loadConversations();
this.showToast('âœ… å°è©±å·²åˆªé™¤', 'info');
});
}

showCustomConfirm(title, message, onConfirm = () => {}) {
const modal = document.createElement('div');
modal.className = 'fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 animate-fade-in';

modal.innerHTML = `
<div class="bg-white dark:bg-gray-800 rounded-3xl shadow-2xl max-w-lg w-full mx-4 p-10 animate-scale-bounce border-2 border-gray-200 dark:border-gray-600">
<h3 class="text-xl font-black text-gray-900 dark:text-white mb-6">${title}</h3>
<p class="text-gray-700 dark:text-gray-300 font-bold mb-8 text-base">${message}</p>
<div class="flex justify-end space-x-4">
<button class="cancel-btn px-6 py-3 text-gray-600 dark:text-gray-400 
hover:bg-gray-100 dark:hover:bg-gray-700 rounded-2xl font-bold transition-all duration-200 button-hover-lift text-base">
å–æ¶ˆ
</button>
<button class="confirm-btn px-6 py-3 bg-red-500 text-white 
hover:bg-red-600 rounded-2xl font-bold transition-all duration-200 button-hover-lift text-base">
åˆªé™¤
</button>
</div>
</div>
`;

document.body.appendChild(modal);

const cancelBtn = modal.querySelector('.cancel-btn');
const confirmBtn = modal.querySelector('.confirm-btn');

const closeModal = () => {
modal.style.opacity = '0';
modal.style.transform = 'scale(0.95)';
setTimeout(() => modal.remove(), 200);
};

const confirmAction = () => {
closeModal();
onConfirm();
};

cancelBtn.addEventListener('click', closeModal);
confirmBtn.addEventListener('click', confirmAction);

modal.addEventListener('click', (e) => {
if (e.target === modal) {
closeModal();
}
});

document.addEventListener('keydown', function escapeHandler(e) {
if (e.key === 'Escape') {
closeModal();
document.removeEventListener('keydown', escapeHandler);
}
});
}

loadConversation(conversationId) {
const conversation = this.conversations.find(c => c.id === conversationId);
if (!conversation) return;

this.currentConversationId = conversationId;
this.saveCurrentConversationId(conversationId);

this.clearChat();
this.addWelcomeMessage();

// è¼‰å…¥å°è©±ç´€éŒ„
if (conversation.messages && conversation.messages.length > 0) {
setTimeout(() => {
conversation.messages.forEach((message, index) => {
setTimeout(() => {
this.addMessageToChat(message.content, message.isUser, false);
}, index * 300);
});
}, 1000); // ç­‰å¾…æ­¡è¿æ¶ˆæ¯å®Œæˆ
}

this.loadConversations();
this.closeSidebar();
}

clearChat() {
const messagesContainer = document.getElementById('messagesContainer');
messagesContainer.innerHTML = '';
this.typewriter.clear(); // æ¸…é™¤æ‰“å­—æ©ŸéšŠåˆ—
}

async addWelcomeMessage() {
const messagesContainer = document.getElementById('messagesContainer');
const welcomeText = `ğŸ¤– æ‚¨å¥½, æ­¡è¿ä¾†åˆ°Social_Innovate_AI çš„å°è©±åŠ©æ‰‹, æˆ‘å€‘å¹³å°æœƒé‹ç”¨å®Œæ•´è¨­è¨ˆæ€ç¶­çš„æ¦‚å¿µï¼Œä»¥äººç‚ºä¸­å¿ƒä¾†äº†è§£æ‚¨çš„éœ€è¦ã€åˆ†æå•é¡Œï¼Œä¸¦æä¾›æœ€å¥½çš„è§£æ±ºæ–¹æ¡ˆ, è«‹å•æœ‰ä»€éº¼å¯ä»¥å¹«åˆ°æ‚¨ï¼Ÿ`;

// ç¢ºä¿ç«‹å³é¡¯ç¤ºæ­¡è¿æ¶ˆæ¯ï¼Œçµ•ä¸ç©ºç™½
try {
const messageDiv = document.createElement('div');
messageDiv.className = 'flex justify-start animate-slide-up mb-4';

const bubbleDiv = document.createElement('div');
bubbleDiv.className = 'chat-bubble bot';
bubbleDiv.style.backgroundColor = '#ffffff';
bubbleDiv.style.color = '#1e293b';
bubbleDiv.style.border = '2px solid #3b82f6';
bubbleDiv.style.padding = '10px 14px';
bubbleDiv.style.maxWidth = 'fit-content';

const contentDiv = document.createElement('div');
contentDiv.className = 'font-bold text-base leading-relaxed break-words overflow-wrap-anywhere';
contentDiv.style.color = '#1e293b';
contentDiv.style.lineHeight = '1.5';

// æ ¼å¼åŒ–æ­¡è¿æ–‡å­—ä¸¦ç«‹å³é¡¯ç¤º
const formattedText = welcomeText
.replace(/\*\*(.*?)\*\*/g, '<strong style="color: #1e40af;">$1</strong>')
.replace(/â€¢/g, '<span style="color: #3b82f6;">â€¢</span>')
.replace(/\n\n/g, '<br><br>')
.replace(/\n/g, '<br>');

contentDiv.innerHTML = formattedText;
bubbleDiv.appendChild(contentDiv);
messageDiv.appendChild(bubbleDiv);
messagesContainer.appendChild(messageDiv);

// ç¢ºä¿å…§å®¹å¯è¦‹
console.log('æ­¡è¿è¨Šæ¯å·²æ·»åŠ åˆ°èŠå¤©å®¹å™¨');

// æ»¾å‹•åˆ°åº•éƒ¨
setTimeout(() => {
const chatArea = document.getElementById('chatArea');
if (chatArea) {
chatArea.scrollTop = chatArea.scrollHeight;
}
}, 100);

} catch (error) {
console.error('æ·»åŠ æ­¡è¿è¨Šæ¯å¤±æ•—:', error);
// å‚™ç”¨æ–¹æ¡ˆï¼šç›´æ¥åœ¨å®¹å™¨ä¸­æ·»åŠ æ–‡å­—
messagesContainer.innerHTML = `
<div class="flex justify-start mb-4">
<div class="chat-bubble bot" style="background-color: #ffffff; color: #1e293b; border: 2px solid #3b82f6; padding: 10px 14px; max-width: fit-content;">
<div class="font-bold text-base leading-relaxed" style="color: #1e293b;">
${welcomeText.replace(/\n/g, '<br>')}
</div>
</div>
</div>
`;
}
}

handleSendMessage(e) {
e.preventDefault();

const messageInput = document.getElementById('messageInput');
const message = messageInput.value.trim();
const hasFiles = this.uploadedFiles && this.uploadedFiles.size > 0;

if (!message && !hasFiles) {
this.showToast('è«‹è¼¸å…¥è¨Šæ¯æˆ–ä¸Šå‚³æª”æ¡ˆ', 'warning');
return;
}

let sendMessage = message;
let attachments = [];

if (hasFiles) {
const fileDescriptions = [];
this.uploadedFiles.forEach((file, fileId) => {
fileDescriptions.push(`${file.name} (${this.formatFileSize(file.size)})`);
attachments.push(file);
});

if (!message) {
sendMessage = 'æˆ‘ä¸Šå‚³äº†ä¸€äº›æª”æ¡ˆï¼Œè«‹å”åŠ©åˆ†æï¼š';
}

sendMessage += `\n\nğŸ“ é™„ä»¶æª”æ¡ˆï¼š\n${fileDescriptions.join('\n')}`;
}

this.addMessageToChat(sendMessage, true);
this.saveMessage(sendMessage, true);

messageInput.value = '';
this.clearUploadedFiles();
this.updateSendButton();

this.sendToAI(sendMessage, attachments);
}

clearUploadedFiles() {
const uploadedFiles = document.getElementById('uploadedFiles');
uploadedFiles.innerHTML = '';
uploadedFiles.classList.add('hidden');

this.uploadedFiles.clear();
}

async sendToAI(message, attachments = []) {
try {
console.log('ğŸš€ æ­£åœ¨ç™¼é€åˆ° Vercel å¾Œç«¯...');

// å‰µå»ºåˆå§‹AIæ¶ˆæ¯æ°£æ³¡
const aiBubble = this.createAndShowAIMessage('');
let fullResponse = '';

// æº–å‚™è«‹æ±‚æ•¸æ“š
const requestData = {
message: message
};

// å¦‚æœæœ‰é™„ä»¶ï¼Œè¨˜éŒ„å®ƒå€‘ï¼ˆå¾Œç«¯è™•ç†å¾…å¯¦ç¾ï¼‰
if (attachments.length > 0) {
console.log(`ğŸ“ ç™¼é€ ${attachments.length} å€‹é™„ä»¶åˆ°å¾Œç«¯`);
}

// ç™¼é€åˆ°Vercelå¾Œç«¯
const response = await fetch('/api/chat', {
method: 'POST',
headers: {
'Content-Type': 'application/json',
},
body: JSON.stringify(requestData)
});

if (!response.ok) {
throw new Error(`HTTP ${response.status}: ${response.statusText}`);
}

// è™•ç†æµå¼éŸ¿æ‡‰
const reader = response.body.getReader();
const decoder = new TextDecoder();

try {
while (true) {
const { done, value } = await reader.read();
if (done) break;

// è§£ç¢¼ä¸¦è™•ç†æ•¸æ“šå¡Š
const chunk = decoder.decode(value, { stream: true });
const lines = chunk.split('\n');

for (const line of lines) {
if (line.startsWith('data: ')) {
const data = line.slice(6); // ç§»é™¤ 'data: ' å‰ç¶´
if (data.trim() && data !== '[DONE]') {
try {
const parsed = JSON.parse(data);
if (parsed.content) {
fullResponse += parsed.content;
// æ›´æ–°AIæ¶ˆæ¯å…§å®¹
this.updateAIMessageContent(aiBubble, this.cleanAndFormatAIResponse(fullResponse));
}
} catch (e) {
// å¦‚æœä¸æ˜¯JSONï¼Œç›´æ¥è¿½åŠ æ–‡æœ¬
if (data.trim() !== '[DONE]') {
fullResponse += data;
this.updateAIMessageContent(aiBubble, this.cleanAndFormatAIResponse(fullResponse));
}
}
}
}
}
}
} finally {
reader.releaseLock();
}

// ä¿å­˜å®Œæˆçš„æ¶ˆæ¯
if (fullResponse.trim()) {
this.saveMessage(fullResponse, false);
console.log('âœ… AIå›æ‡‰å®Œæˆä¸¦å·²ä¿å­˜');
}

} catch (error) {
console.error('âŒ ç™¼é€åˆ°å¾Œç«¯å¤±æ•—:', error);

let errorMsg = 'å¾ˆæŠ±æ­‰ï¼Œé€£æ¥å¾Œç«¯æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚';

if (error.name === 'TypeError' && error.message.includes('fetch')) {
errorMsg = 'ç¶²çµ¡é€£æ¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥æ‚¨çš„ç¶²çµ¡é€£æ¥ã€‚';
} else if (error.message.includes('HTTP 4')) {
errorMsg = 'è«‹æ±‚æ ¼å¼ä¸æ­£ç¢ºï¼Œè«‹æª¢æŸ¥æ‚¨çš„è¼¸å…¥ã€‚';
} else if (error.message.includes('HTTP 5')) {
errorMsg = 'å¾Œç«¯æœå‹™æš«æ™‚ä¸å¯ç”¨ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚';
}

// æ›´æ–°éŒ¯èª¤æ¶ˆæ¯åˆ°ç¾æœ‰æ°£æ³¡
if (aiBubble) {
this.updateAIMessageContent(aiBubble, `âŒ ${errorMsg}`);
} else {
this.createAndShowAIMessage(`âŒ ${errorMsg}`);
}
}
}







async addMessageToChat(content, isUser, isStreaming = false) {
const messagesContainer = document.getElementById('messagesContainer');
const messageDiv = document.createElement('div');
messageDiv.className = `flex ${isUser ? 'justify-end' : 'justify-start'} animate-slide-up mb-4`;

const bubbleDiv = document.createElement('div');
bubbleDiv.className = `chat-bubble ${isUser ? 'user' : 'bot'}`;

// å»æ‰é»˜èªpaddingï¼Œä½¿ç”¨CSSæ§åˆ¶
bubbleDiv.style.padding = isUser ? '10px 14px' : '10px 14px';

if (isStreaming) {
bubbleDiv.classList.add('streaming');
}

const messageId = `msg_${Date.now()}_${this.messageCounter++}`;

if (isUser) {
// ç”¨æˆ¶æ¶ˆæ¯ç›´æ¥é¡¯ç¤ºï¼Œç¢ºä¿å…§å®¹åœ¨é‚Šç•Œå…§
bubbleDiv.innerHTML = `<div class="font-bold text-base leading-relaxed break-words overflow-wrap-anywhere">${this.formatMessage(content)}</div>`;
} else {
// AIæ¶ˆæ¯ä½¿ç”¨æ‰“å­—æ©Ÿæ•ˆæœå’Œé‚Šç•Œæ§åˆ¶
bubbleDiv.innerHTML = `<div id="${messageId}" class="font-bold text-base leading-relaxed break-words overflow-wrap-anywhere"></div><span class="typewriter-cursor">|</span>`;

if (!isStreaming && content) {
setTimeout(async () => {
// ç¢ºä¿å…§å®¹åœ¨é‚Šç•Œå…§é¡¯ç¤º
await this.typewriter.typeText(messageId, content, 15);
}, 300);
}
}

messageDiv.appendChild(bubbleDiv);
messagesContainer.appendChild(messageDiv);

// ç¢ºä¿æ»¾å‹•åˆ°åº•éƒ¨ä¸¦æª¢æŸ¥é‚Šç•Œ
setTimeout(() => {
this.ensureMessageVisibility();
const chatArea = document.getElementById('chatArea');
chatArea.scrollTop = chatArea.scrollHeight;
}, 100);

return bubbleDiv;
}

async updateMessageWithTypewriter(bubble, content, messageId) {
// é˜²è­·æ€§æª¢æŸ¥ï¼šç¢ºä¿ bubble æ˜¯æœ‰æ•ˆçš„ DOM å…ƒç´ 
if (!bubble || typeof bubble.querySelector !== 'function') {
console.error('updateMessageWithTypewriter: bubble ä¸æ˜¯æœ‰æ•ˆçš„ DOM å…ƒç´ ', bubble);
return;
}

const messageElement = bubble.querySelector(`#${messageId}`);
if (messageElement) {
// æ¸…é™¤ä¹‹å‰çš„å…§å®¹
messageElement.innerHTML = '';

// æ ¼å¼åŒ–ä¸¦ä½¿ç”¨æ‰“å­—æ©Ÿæ•ˆæœ
const formattedContent = this.formatMessage(content);
await this.typewriter.typeText(messageId, this.stripHtml(formattedContent), 10);

// ç„¶å¾Œæ‡‰ç”¨HTMLæ ¼å¼
setTimeout(() => {
if (messageElement && messageElement.parentNode) {
messageElement.innerHTML = formattedContent;
}
}, 100);
} else {
console.error('updateMessageWithTypewriter: æ‰¾ä¸åˆ°æ¶ˆæ¯å…ƒç´ ', messageId);
}
}

stripHtml(html) {
const tmp = document.createElement('div');
tmp.innerHTML = html;
return tmp.textContent || tmp.innerText || '';
}

formatMessage(text) {
// æ¸…ç†æ–‡å­—å’Œå„ªåŒ–æ ¼å¼
let formattedText = text
// ç§»é™¤ä¸å¿…è¦çš„ç¬¦è™Ÿå’Œç¢ºä¿é©ç•¶æ›è¡Œ
.replace(/\r\n/g, '\n')
.replace(/\r/g, '\n')
// åŸºæœ¬Markdownæ ¼å¼
.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
.replace(/\*(.*?)\*/g, '<em>$1</em>')
.replace(/`(.*?)`/g, '<code class="bg-blue-100 dark:bg-blue-900 px-2 py-1 rounded text-sm font-mono">$1</code>')
// è™•ç†æ›è¡Œå’Œæ®µè½ - ç¢ºä¿é©ç•¶çš„æ®µè½é–“è·
.replace(/\n\n+/g, '</p><p class="mb-4">')
.replace(/\n/g, '<br>')
// ç¢ºä¿æ¨™é»ç¬¦è™Ÿå¾Œæœ‰é©ç•¶é–“è·
.replace(/([ã€‚ï¼ï¼Ÿ])\s*/g, '$1 ')
.replace(/([ï¼Œã€ï¼šï¼›])\s*/g, '$1 ')
// ç§»é™¤å¤šé¤˜ç©ºæ ¼
.replace(/\s+/g, ' ')
.trim();

// å¦‚æœæœ‰æ®µè½åˆ†éš”ï¼ŒåŒ…è£æ®µè½
if (formattedText.includes('</p><p class="mb-4">')) {
formattedText = '<p class="mb-4">' + formattedText + '</p>';
}

return formattedText;
}

saveMessage(content, isUser) {
const conversation = this.conversations.find(c => c.id === this.currentConversationId);
if (conversation) {
conversation.messages.push({
content,
isUser,
timestamp: new Date().toISOString()
});
conversation.lastUpdated = new Date().toISOString();
this.saveConversations();
}
}

async saveConversations() {
try {
console.log('ğŸ’¾ é–‹å§‹ä¿å­˜å°è©±è¨˜éŒ„...');

// ç«‹å³åŸ·è¡Œå¤šé‡å‚™ä»½ä»¥ç¢ºä¿æ•¸æ“šå®‰å…¨
await this.createBackups(this.conversations);

// é¡å¤–çš„å®‰å…¨æªæ–½ï¼šä¿å­˜åˆ°å°ˆç”¨è¨­å‚™å­˜å„²
if (this.deviceFingerprint) {
const deviceSpecificKey = `conversations_device_${this.deviceFingerprint}`;
const backupData = {
conversations: this.conversations,
deviceFingerprint: this.deviceFingerprint,
timestamp: new Date().toISOString(),
version: '2.1',
totalMessages: this.conversations.reduce((total, conv) => total + conv.messages.length, 0)
};

if (this.storageAvailable.localStorage) {
localStorage.setItem(deviceSpecificKey, JSON.stringify(backupData));
localStorage.setItem('chatbot_last_save_timestamp', new Date().toISOString());
}
}

console.log('âœ… å°è©±è¨˜éŒ„ä¿å­˜å®Œæˆ');

} catch (error) {
console.error('âŒ ä¿å­˜å°è©±å¤±æ•—:', error);

// ç·Šæ€¥ä¿å­˜æ©Ÿåˆ¶
try {
const emergencyData = JSON.stringify(this.conversations);
localStorage.setItem('emergency_conversations_backup', emergencyData);
localStorage.setItem('emergency_backup_created', new Date().toISOString());
console.log('ğŸš¨ ç·Šæ€¥å‚™ä»½å·²å‰µå»º');
} catch (emergencyError) {
console.error('âŒ ç·Šæ€¥å‚™ä»½ä¹Ÿå¤±æ•—:', emergencyError);
this.showToast('âš ï¸ å­˜å„²å‡ºç¾å•é¡Œï¼Œè«‹æª¢æŸ¥ç€è¦½å™¨è¨­ç½®', 'warning');
}
}
}

saveCurrentConversationId(id) {
try {
if (this.storageAvailable === 'localStorage') {
localStorage.setItem('chatbot_current_conversation', id);
} else if (this.storageAvailable === 'sessionStorage') {
sessionStorage.setItem('chatbot_current_conversation', id);
} else {
if (!window.__chatbot_memory_storage) {
window.__chatbot_memory_storage = {};
}
window.__chatbot_memory_storage.currentConversationId = id;
}
} catch (error) {
console.error('ä¿å­˜ç•¶å‰å°è©±IDå¤±æ•—:', error);
}
}

handleInputChange(e) {
this.updateSendButton();
this.autoResize(e.target);
}

handleKeyDown(e) {
if (e.key === 'Enter' && !e.shiftKey) {
e.preventDefault();
document.getElementById('chatForm').dispatchEvent(new Event('submit'));
}
}

updateSendButton() {
const messageInput = document.getElementById('messageInput');
const sendBtn = document.getElementById('sendBtn');
const hasText = messageInput.value.trim().length > 0;
const hasFiles = this.uploadedFiles && this.uploadedFiles.size > 0;

sendBtn.disabled = !hasText && !hasFiles;

if (!sendBtn.disabled) {
sendBtn.classList.add('animate-glow-pulse');
} else {
sendBtn.classList.remove('animate-glow-pulse');
}
}

autoResize(textarea) {
textarea.style.height = 'auto';
textarea.style.height = Math.min(textarea.scrollHeight, 180) + 'px';
}

openSidebar() {
const sidebar = document.getElementById('sidebar');
const overlay = document.getElementById('sidebarOverlay');

sidebar.classList.add('open');

if (window.innerWidth < 768) {
overlay.classList.remove('hidden');
document.body.style.overflow = 'hidden';
}
}

closeSidebar() {
const sidebar = document.getElementById('sidebar');
const overlay = document.getElementById('sidebarOverlay');

sidebar.classList.remove('open');
overlay.classList.add('hidden');
document.body.style.overflow = '';
}

showLoading() {
document.getElementById('loadingIndicator').classList.remove('hidden');
}

hideLoading() {
document.getElementById('loadingIndicator').classList.add('hidden');
}

showToast(message, type = 'info') {
const existingToasts = document.querySelectorAll('.toast-notification');
existingToasts.forEach(toast => {
toast.style.transform = 'translateX(100%)';
toast.style.opacity = '0';
setTimeout(() => {
if (toast.parentNode) {
toast.parentNode.removeChild(toast);
}
}, 200);
});

const toast = document.createElement('div');
const colors = {
success: 'bg-green-500',
error: 'bg-red-500',
info: 'bg-blue-500',
warning: 'bg-yellow-500'
};

toast.className = `toast-notification fixed top-28 right-8 ${colors[type]} text-white px-8 py-4 rounded-2xl text-base font-bold z-50 animate-slide-left shadow-2xl border-2 border-white border-opacity-20`;
toast.textContent = message;

document.body.appendChild(toast);

setTimeout(() => {
toast.style.transform = 'translateX(100%)';
toast.style.opacity = '0';
setTimeout(() => {
if (toast.parentNode) {
toast.parentNode.removeChild(toast);
}
}, 300);
}, 4000);
}

toggleFileUploadOptions() {
const options = document.getElementById('fileUploadOptions');
const toggleBtn = document.getElementById('fileUploadToggle');

if (options.classList.contains('hidden')) {
options.classList.remove('hidden');
options.style.animation = 'slideDown 0.3s ease-out';
toggleBtn.style.backgroundColor = '#dc2626';
toggleBtn.querySelector('svg').style.transform = 'rotate(45deg)';
} else {
this.hideFileUploadOptions();
}
}

hideFileUploadOptions() {
const options = document.getElementById('fileUploadOptions');
const toggleBtn = document.getElementById('fileUploadToggle');

options.style.animation = 'slideUp 0.3s ease-out';
setTimeout(() => {
options.classList.add('hidden');
}, 300);

toggleBtn.style.backgroundColor = '#059669';
toggleBtn.querySelector('svg').style.transform = 'rotate(0deg)';
}

handleFileUpload(event, type) {
const files = Array.from(event.target.files);
this.handleFileSelection(files, type);
event.target.value = '';
}

handleFileSelection(files, type = 'auto') {
if (files.length === 0) return;

let validFiles = 0;
files.forEach(file => {
let fileType = type;
if (type === 'auto') {
// æ™ºèƒ½æª”æ¡ˆé¡å‹æª¢æ¸¬
if (file.type.startsWith('image/')) {
fileType = 'photo';
} else if (file.type.startsWith('video/')) {
fileType = 'video';
} else if (file.type.includes('document') || file.type.includes('pdf') || file.type.includes('text') || file.type.includes('sheet') || file.type.includes('excel') ||
['doc', 'docx', 'pdf', 'txt', 'xls', 'xlsx'].some(ext => file.name.toLowerCase().endsWith(ext))) {
fileType = 'document';
} else {
// æ ¹æ“šæª”æ¡ˆå‰¯æª”åé€²è¡Œå‚™ç”¨æª¢æ¸¬
const fileName = file.name.toLowerCase();
if (['jpg', 'jpeg', 'png', 'tiff', 'webp'].some(ext => fileName.endsWith(ext))) {
fileType = 'photo';
} else if (['mp4', 'mov', 'wmv', 'webm'].some(ext => fileName.endsWith(ext))) {
fileType = 'video';
} else if (['doc', 'docx', 'pdf', 'txt', 'xls', 'xlsx'].some(ext => fileName.endsWith(ext))) {
fileType = 'document';
} else {
fileType = 'document'; // é»˜èªç‚ºæ–‡ä»¶é¡å‹
}
}
}

if (!this.validateFileFormat(file, fileType)) {
this.showToast(`âŒ ä¸æ”¯æ´çš„æª”æ¡ˆæ ¼å¼ï¼š${file.name}`, 'error');
return;
}

this.addFileToPreview(file, fileType);
validFiles++;
});

if (validFiles > 0) {
this.hideFileUploadOptions();
this.showToast(`âœ… å·²æ·»åŠ  ${validFiles} å€‹æª”æ¡ˆ`, 'success');
this.updateSendButton();
}
}

validateFileFormat(file, type) {
const photoFormats = ['image/jpeg', 'image/jpg', 'image/png', 'image/tiff', 'image/webp'];
const videoFormats = ['video/mp4', 'video/quicktime', 'video/x-ms-wmv', 'video/webm'];
const documentFormats = [
'application/msword', 
'application/vnd.openxmlformats-officedocument.wordprocessingml.document', 
'application/pdf', 
'text/plain',
'application/vnd.ms-excel',
'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
];

if (type === 'photo') {
return photoFormats.some(format => file.type.toLowerCase().includes(format.split('/')[1])) ||
['jpg', 'jpeg', 'png', 'tiff', 'webp'].some(ext => file.name.toLowerCase().endsWith(ext));
} else if (type === 'video') {
return videoFormats.some(format => file.type.toLowerCase().includes(format.split('/')[1])) ||
['mp4', 'mov', 'wmv', 'webm'].some(ext => file.name.toLowerCase().endsWith(ext));
} else if (type === 'document') {
return documentFormats.some(format => file.type.toLowerCase().includes(format)) ||
['doc', 'docx', 'pdf', 'txt', 'xls', 'xlsx'].some(ext => file.name.toLowerCase().endsWith(ext));
}
return false;
}

addFileToPreview(file, type) {
const uploadedFiles = document.getElementById('uploadedFiles');
uploadedFiles.classList.remove('hidden');

const fileId = `file_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
const fileDiv = document.createElement('div');
fileDiv.className = 'p-6 bg-white bg-opacity-10 rounded-2xl border border-white border-opacity-20 mb-5 animate-scale-bounce';
fileDiv.dataset.fileId = fileId;

this.uploadedFiles.set(fileId, file);

let iconColor, iconPath, fileTypeLabel, fileTypeIcon;

if (type === 'photo') {
iconColor = 'blue';
iconPath = 'M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z';
fileTypeLabel = 'ç…§ç‰‡';
fileTypeIcon = 'ğŸ“·';
} else if (type === 'video') {
iconColor = 'purple';
iconPath = 'M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z';
fileTypeLabel = 'å½±ç‰‡';
fileTypeIcon = 'ğŸ¥';
} else if (type === 'document') {
iconColor = 'green';
iconPath = 'M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z';
fileTypeLabel = 'æ–‡å­—æª”æ¡ˆ';
fileTypeIcon = 'ğŸ“„';
} else {
iconColor = 'gray';
iconPath = 'M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z';
fileTypeLabel = 'æª”æ¡ˆ';
fileTypeIcon = 'ğŸ“„';
}

fileDiv.innerHTML = `
<div class="flex items-center justify-between">
<div class="flex items-center space-x-5">
<div class="w-16 h-16 bg-${iconColor}-500 bg-opacity-30 rounded-2xl flex items-center justify-center">
<svg class="w-9 h-9 text-${iconColor}-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${iconPath}"></path>
</svg>
</div>
<div class="flex-1">
<p class="text-white font-black text-base truncate" title="${file.name}">${file.name}</p>
<p class="text-blue-200 font-bold text-sm">
${fileTypeIcon} ${fileTypeLabel} â€¢ ${this.formatFileSize(file.size)}
</p>
</div>
</div>
<button onclick="chatBotApp.removeFile('${fileId}')" class="text-red-300 hover:text-red-200 p-3 rounded-2xl transition-all duration-200 button-hover-lift" title="ç§»é™¤æª”æ¡ˆ">
<svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
</svg>
</button>
</div>
`;

uploadedFiles.appendChild(fileDiv);
}

removeFile(fileId) {
const fileElement = document.querySelector(`[data-file-id="${fileId}"]`);
if (fileElement) {
fileElement.style.animation = 'slideUp 0.3s ease-out';
setTimeout(() => {
fileElement.remove();

this.uploadedFiles.delete(fileId);

const uploadedFiles = document.getElementById('uploadedFiles');
if (uploadedFiles.children.length === 0) {
uploadedFiles.classList.add('hidden');
}

this.updateSendButton();
}, 300);

this.showToast('âœ… æª”æ¡ˆå·²ç§»é™¤', 'info');
}
}

formatFileSize(bytes) {
if (bytes === 0) return '0 Bytes';
const k = 1024;
const sizes = ['Bytes', 'KB', 'MB', 'GB'];
const i = Math.floor(Math.log(bytes) / Math.log(k));
return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

handleResize() {
if (window.innerWidth >= 768) {
document.getElementById('sidebarOverlay').classList.add('hidden');
document.body.style.overflow = '';
}
}

setupAutoSave() {
// æ›´é »ç¹çš„è‡ªå‹•ä¿å­˜
setInterval(() => {
this.saveConversations();
if (this.currentConversationId) {
this.saveCurrentConversationId(this.currentConversationId);
}
}, 10000); // æ¯10ç§’ä¿å­˜ä¸€æ¬¡

// é é¢é—œé–‰æ™‚ä¿å­˜
window.addEventListener('beforeunload', () => {
this.saveConversations();
});

// é é¢éš±è—æ™‚ä¿å­˜
document.addEventListener('visibilitychange', () => {
if (document.hidden) {
this.saveConversations();
}
});
}

formatDateTime(date) {
const year = date.getFullYear();
const month = String(date.getMonth() + 1).padStart(2, '0');
const day = String(date.getDate()).padStart(2, '0');
const hours = String(date.getHours()).padStart(2, '0');
const minutes = String(date.getMinutes()).padStart(2, '0');

return `${year}.${month}.${day} ${hours}:${minutes}`;
}

handleGlobalError(e) {
console.error('æ‡‰ç”¨ç¨‹å¼éŒ¯èª¤:', e.error);
this.showToast('âŒ ç™¼ç”Ÿæœªé æœŸçš„éŒ¯èª¤', 'error');
}

handlePromiseRejection(e) {
console.error('æœªè™•ç†çš„PromiseéŒ¯èª¤:', e.reason);
e.preventDefault();
}

// å‰µå»ºAIæ°£æ³¡ - æ–°çš„ç©©å®šæ–¹æ³•
createAIBubble() {
const messagesContainer = document.getElementById('messagesContainer');
const messageDiv = document.createElement('div');
messageDiv.className = 'flex justify-start animate-slide-up mb-6';

const bubbleDiv = document.createElement('div');
bubbleDiv.className = 'chat-bubble bot p-6 streaming';

const messageId = `ai_msg_${Date.now()}_${this.messageCounter++}`;

bubbleDiv.innerHTML = `
<div id="${messageId}" class="font-bold text-xl break-words overflow-wrap-anywhere text-gray-800"></div>
`;

messageDiv.appendChild(bubbleDiv);
messagesContainer.appendChild(messageDiv);

// æ»¾å‹•åˆ°åº•éƒ¨
setTimeout(() => {
const chatArea = document.getElementById('chatArea');
chatArea.scrollTop = chatArea.scrollHeight;
}, 100);

return bubbleDiv;
}

// æ›´æ–°AIæ°£æ³¡å…§å®¹ - é¿å…DOMéŒ¯èª¤
updateAIBubbleContent(bubble, content, messageId) {
if (!bubble || !content) return;

try {
const messageElement = bubble.querySelector(`#${messageId}`);
if (messageElement) {
// æ¸…ç†ä¸¦æ ¼å¼åŒ–å…§å®¹
const cleanContent = this.cleanAIContent(content);
// ç›´æ¥è¨­ç½®å…§å®¹ï¼Œä¸ä½¿ç”¨è¤‡é›œçš„æ‰“å­—æ©Ÿæ•ˆæœ
messageElement.innerHTML = cleanContent;
// ç¢ºä¿æ–‡å­—é¡è‰²æ­£ç¢º
messageElement.style.color = '#1e293b';
messageElement.classList.add('animate-fade-in');
}
} catch (error) {
console.error('æ›´æ–°AIæ°£æ³¡å…§å®¹å¤±æ•—:', error);
}
}

// æ¸…ç†AIå…§å®¹
cleanAIContent(content) {
if (!content) return '';

return content
.replace(/\r\n/g, '\n')
.replace(/\r/g, '\n')
.replace(/\n\n+/g, '</p><p class="mb-3">')
.replace(/\n/g, '<br>')
.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
.replace(/\*(.*?)\*/g, '<em>$1</em>')
.trim();
}

// æ·»åŠ AIæ¶ˆæ¯ - å‚™ç”¨æ–¹æ³•
addAIMessage(content) {
const messagesContainer = document.getElementById('messagesContainer');
const messageDiv = document.createElement('div');
messageDiv.className = 'flex justify-start animate-slide-up mb-6';

const bubbleDiv = document.createElement('div');
bubbleDiv.className = 'chat-bubble bot p-6 complete';

const cleanContent = this.cleanAIContent(content);

bubbleDiv.innerHTML = `<div class="font-bold text-xl break-words overflow-wrap-anywhere text-gray-800">${cleanContent}</div>`;

messageDiv.appendChild(bubbleDiv);
messagesContainer.appendChild(messageDiv);

// æ»¾å‹•åˆ°åº•éƒ¨
setTimeout(() => {
const chatArea = document.getElementById('chatArea');
chatArea.scrollTop = chatArea.scrollHeight;
}, 100);

return bubbleDiv;
}

// å‰µå»ºä¸¦é¡¯ç¤ºAIå›æ‡‰çš„æ”¹è‰¯æ–¹æ³•
createAndShowAIMessage(content) {
console.log('é¡¯ç¤ºAIå›æ‡‰:', content);

const messagesContainer = document.getElementById('messagesContainer');
const messageDiv = document.createElement('div');
messageDiv.className = 'flex justify-start animate-slide-up mb-4';

const bubbleDiv = document.createElement('div');
bubbleDiv.className = 'chat-bubble bot';
bubbleDiv.style.backgroundColor = '#ffffff';
bubbleDiv.style.color = '#1e293b';
bubbleDiv.style.border = '2px solid #3b82f6';
bubbleDiv.style.padding = '10px 14px';
bubbleDiv.style.maxWidth = 'fit-content';
bubbleDiv.style.lineHeight = '1.5';

// å‰µå»ºå…§å®¹å®¹å™¨
const contentDiv = document.createElement('div');
contentDiv.className = 'font-bold text-base leading-relaxed break-words overflow-wrap-anywhere';
contentDiv.style.color = '#1e293b';
contentDiv.style.lineHeight = '1.5';

// åªæœ‰ç•¶æœ‰å¯¦éš›å…§å®¹æ™‚æ‰é¡¯ç¤ºï¼Œä¸é¡¯ç¤º"æ€è€ƒä¸­"
if (content && content.trim()) {
const formattedContent = this.cleanAndFormatAIResponse(content);
contentDiv.innerHTML = formattedContent;

bubbleDiv.appendChild(contentDiv);
messageDiv.appendChild(bubbleDiv);
messagesContainer.appendChild(messageDiv);

// ç¢ºä¿æ»¾å‹•åˆ°åº•éƒ¨
setTimeout(() => {
const chatArea = document.getElementById('chatArea');
chatArea.scrollTop = chatArea.scrollHeight;
}, 100);

return bubbleDiv;
}

// å¦‚æœæ²’æœ‰å…§å®¹ï¼Œå…ˆä¸é¡¯ç¤ºæ°£æ³¡ï¼Œç­‰æœ‰å…§å®¹æ™‚å†å‰µå»º
return null;
}

// æ¸…ç†ä¸¦æ ¼å¼åŒ–AIå›æ‡‰å…§å®¹
cleanAndFormatAIResponse(content) {
if (!content) return '';

// åœ¨AIå›æ‡‰å‰åŠ å…¥é©ç•¶çš„emoji
const processedContent = this.addEmojisToAIResponse(content);

let formattedContent = processedContent
.replace(/\r\n/g, '\n')
.replace(/\r/g, '\n')
// ç¢ºä¿æ®µè½é–“æœ‰é©ç•¶é–“è·
.replace(/\n\n+/g, '</p><p class="mb-4">')
.replace(/\n/g, '<br>')
// æ ¼å¼åŒ–ç²—é«”æ–‡å­—
.replace(/\*\*(.*?)\*\*/g, '<strong style="color: #1e40af;">$1</strong>')
.replace(/\*(.*?)\*/g, '<em>$1</em>')
// ç¢ºä¿æ¨™é»ç¬¦è™Ÿå¾Œæœ‰é©ç•¶é–“è·
.replace(/([ã€‚ï¼ï¼Ÿ])\s*/g, '$1 ')
.replace(/([ï¼Œã€ï¼šï¼›])\s*/g, '$1 ')
// ç§»é™¤å¤šé¤˜ç©ºæ ¼ä½†ä¿æŒæ®µè½çµæ§‹
.replace(/ +/g, ' ')
.trim();

// ç§»é™¤äº†åº•éƒ¨æç¤ºæ–‡å­— - ä¸éœ€è¦é¡å¤–çš„ç©ºç™½å’Œæç¤º
return formattedContent;
}

// æ™ºèƒ½æ·»åŠ emojiåˆ°AIå›æ‡‰
addEmojisToAIResponse(content) {
if (!content) return '';

// å›æ‡‰é–‹å§‹çš„æƒ…æ„Ÿemoji
const greetingEmojis = ['ğŸ˜Š', 'ğŸ‘‹', 'ğŸ¤–', 'ğŸ’­', 'âœ¨'];
const randomGreeting = greetingEmojis[Math.floor(Math.random() * greetingEmojis.length)];

// æ ¹æ“šå…§å®¹é¡å‹æ·»åŠ ç›¸é—œemoji
let enhancedContent = content;

// å•å€™èªé–‹é ­ - ä¿®æ­£emojiæª¢æ¸¬
if (!content.match(/^[\u{1F600}-\u{1F64F}\u{1F300}-\u{1F5FF}\u{1F680}-\u{1F6FF}\u{1F1E0}-\u{1F1FF}]/u) && content.length > 0) {
enhancedContent = `${randomGreeting} ${content}`;
}

// æ ¹æ“šå…§å®¹é—œéµè©æ·»åŠ ç›¸é—œemoji
const emojiMappings = {
// è¨­è¨ˆæ€ç¶­ç›¸é—œ
'è¨­è¨ˆæ€ç¶­': 'ğŸ¨',
'å‰µæ–°': 'ğŸ’¡',
'è§£æ±ºæ–¹æ¡ˆ': 'ğŸ”§',
'åˆ†æ': 'ğŸ“Š',
'å»ºè­°': 'ğŸ’­',
'å¹«åŠ©': 'ğŸ¤',
'å”åŠ©': 'ğŸ¤',

// æƒ…æ„Ÿå›æ‡‰
'å¾ˆå¥½': 'ğŸ‘',
'å„ªç§€': 'â­',
'å®Œç¾': 'âœ¨',
'å¤ªæ£’äº†': 'ğŸ‰',
'æˆåŠŸ': 'ğŸ†',
'è¬è¬': 'ğŸ™',
'æ„Ÿè¬': 'ğŸ™',

// å•é¡Œå’Œè§£ç­”
'å•é¡Œ': 'â“',
'ç­”æ¡ˆ': 'ğŸ’¡',
'èªªæ˜': 'ğŸ“',
'æ­¥é©Ÿ': 'ğŸ“‹',
'æ–¹æ³•': 'ğŸ”§',
'æŠ€å·§': 'âš¡',

// å­¸ç¿’å’Œæ•™è‚²
'å­¸ç¿’': 'ğŸ“š',
'æ•™å­¸': 'ğŸ“',
'çŸ¥è­˜': 'ğŸ§ ',
'è³‡è¨Š': 'ğŸ“°',
'è©³ç´°': 'ğŸ”',

// æ³¨æ„å’Œè­¦å‘Š
'æ³¨æ„': 'âš ï¸',
'é‡è¦': 'â€¼ï¸',
'æé†’': 'ğŸ“Œ',
'è¨˜ä½': 'ğŸ§ ',

// çµæŸå’Œç¸½çµ
'ç¸½çµ': 'ğŸ“',
'çµè«–': 'ğŸ¯',
'å®Œæˆ': 'âœ…',
'çµæŸ': 'ğŸ'
};

// åœ¨ç›¸é—œé—œéµè©å‰æ·»åŠ emoji
Object.entries(emojiMappings).forEach(([keyword, emoji]) => {
const regex = new RegExp(`\\b${keyword}\\b`, 'gi');
enhancedContent = enhancedContent.replace(regex, `${emoji} $&`);
});

return enhancedContent;
}

// æ›´æ–°AIæ¶ˆæ¯å…§å®¹
updateAIMessageContent(bubbleElement, content) {
if (!bubbleElement || !content) return;

try {
console.log('æ›´æ–°AIå›æ‡‰å…§å®¹:', content.substring(0, 100) + '...');

const contentDiv = bubbleElement.querySelector('div');
if (contentDiv) {
// è¨­ç½®æ ¼å¼åŒ–å¾Œçš„å…§å®¹
contentDiv.innerHTML = content;
contentDiv.style.color = '#1e293b';

// ç¢ºä¿æ°£æ³¡æ¨£å¼æ­£ç¢º
bubbleElement.style.backgroundColor = '#ffffff';
bubbleElement.style.border = '2px solid #3b82f6';

// æ»¾å‹•åˆ°åº•éƒ¨
setTimeout(() => {
const chatArea = document.getElementById('chatArea');
chatArea.scrollTop = chatArea.scrollHeight;
}, 50);
}
} catch (error) {
console.error('æ›´æ–°AIå…§å®¹å¤±æ•—:', error);
}
}

ensureMessageVisibility() {
// ç¢ºä¿æ‰€æœ‰æ¶ˆæ¯æ°£æ³¡éƒ½åœ¨å¯è¦–ç¯„åœå…§
const messagesContainer = document.getElementById('messagesContainer');
const chatBubbles = messagesContainer.querySelectorAll('.chat-bubble');

chatBubbles.forEach(bubble => {
// æª¢æŸ¥æ°£æ³¡æ˜¯å¦è¶…å‡ºå®¹å™¨é‚Šç•Œ
const rect = bubble.getBoundingClientRect();
const containerRect = messagesContainer.getBoundingClientRect();

// å¦‚æœæ°£æ³¡è¶…å‡ºå®¹å™¨ï¼Œèª¿æ•´å…¶æ¨£å¼
if (rect.width > containerRect.width * 0.9) {
bubble.style.maxWidth = '90%';
bubble.style.wordBreak = 'break-all';
bubble.style.overflowWrap = 'anywhere';
}
});

const chatArea = document.getElementById('chatArea');
chatArea.scrollTop = chatArea.scrollHeight;
}

// è¨­ç½®é»æ“ŠèŠå¤©å€åŸŸé—œé–‰å´é‚Šæ¬„çš„åŠŸèƒ½
setupChatAreaClick() {
const chatArea = document.getElementById('chatArea');
const mainContent = document.querySelector('.flex-1.flex.flex-col.h-screen');
const header = document.querySelector('header');
const inputArea = document.querySelector('.glass-effect.border-t');

// ç‚ºå¤šå€‹èŠå¤©ç›¸é—œå€åŸŸæ·»åŠ é»æ“Šäº‹ä»¶
[chatArea, header, inputArea].forEach(area => {
if (area) {
area.addEventListener('click', (e) => {
// æª¢æŸ¥å´é‚Šæ¬„æ˜¯å¦æ‰“é–‹
const sidebar = document.getElementById('sidebar');
if (sidebar && sidebar.classList.contains('open')) {
// æª¢æŸ¥é»æ“Šçš„ç›®æ¨™ï¼Œç¢ºä¿ä¸æ˜¯è¼¸å…¥æ¡†ã€æŒ‰éˆ•ç­‰äº¤äº’å…ƒç´ 
const clickedElement = e.target;
const isInteractiveElement = clickedElement.closest('input, textarea, button, select, a, [role="button"], .button-hover-lift') ||
clickedElement.tagName === 'INPUT' ||
clickedElement.tagName === 'TEXTAREA' ||
clickedElement.tagName === 'BUTTON' ||
clickedElement.tagName === 'SELECT' ||
clickedElement.tagName === 'A';

// å¦‚æœä¸æ˜¯äº¤äº’å…ƒç´ ï¼Œå‰‡é—œé–‰å´é‚Šæ¬„
if (!isInteractiveElement) {
e.preventDefault();
this.closeSidebar();
}
}
});
}
});

// ç‚ºæ•´å€‹ä¸»è¦å…§å®¹å€åŸŸæ·»åŠ é»æ“Šäº‹ä»¶ï¼ˆä½œç‚ºå‚™ç”¨ï¼‰
if (mainContent) {
mainContent.addEventListener('click', (e) => {
const sidebar = document.getElementById('sidebar');
if (sidebar && sidebar.classList.contains('open')) {
// æª¢æŸ¥é»æ“Šæ˜¯å¦åœ¨å´é‚Šæ¬„å¤–éƒ¨
const sidebarRect = sidebar.getBoundingClientRect();
const clickX = e.clientX;
const clickY = e.clientY;

// å¦‚æœé»æ“Šåœ¨å´é‚Šæ¬„å¤–éƒ¨ä¸”ä¸æ˜¯äº¤äº’å…ƒç´ 
if ((clickX < sidebarRect.left || clickX > sidebarRect.right ||
clickY < sidebarRect.top || clickY > sidebarRect.bottom)) {
const clickedElement = e.target;
const isInteractiveElement = clickedElement.closest('input, textarea, button, select, a, [role="button"], .button-hover-lift') ||
clickedElement.tagName === 'INPUT' ||
clickedElement.tagName === 'TEXTAREA' ||
clickedElement.tagName === 'BUTTON' ||
clickedElement.tagName === 'SELECT' ||
clickedElement.tagName === 'A';

if (!isInteractiveElement) {
e.preventDefault();
this.closeSidebar();
}
}
}
});
}
}
}

// åˆå§‹åŒ–é é¢ç®¡ç†å™¨
const pageManager = new PageManager();

// æ€§èƒ½ç›£æ§å’ŒéŒ¯èª¤è™•ç†
window.addEventListener('load', () => {
console.log('Design Thinking AI æ”¹è‰¯ç‰ˆæœ¬è¼‰å…¥å®Œæˆ');
});

// é˜²æ­¢å¸¸è¦‹éŒ¯èª¤
window.addEventListener('error', (e) => {
console.error('å…¨å±€éŒ¯èª¤:', e.error);
});

window.addEventListener('unhandledrejection', (e) => {
console.error('æœªè™•ç†çš„PromiseéŒ¯èª¤:', e.reason);
e.preventDefault();
});
</script>

</body>
</html>