<!DOCTYPE html>
<html lang="zh-TW" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="description" content="AI Sam - å°ˆæ¥­çš„äººå·¥æ™ºèƒ½å°è©±å¹³å°ï¼Œé‹ç”¨è¨­è¨ˆæ€ç¶­æ–¹æ³•ï¼Œæ”¯æ´å¤šå¹³å°ä½¿ç”¨">
    <meta name="keywords" content="AI,äººå·¥æ™ºèƒ½,æ™ºèƒ½åŠ©æ‰‹,èŠå¤©æ©Ÿå™¨äºº,è·¨å¹³å°,è¨­è¨ˆæ€ç¶­">
    <meta name="author" content="AI Sam Team">
    <meta name="theme-color" content="#1e3a8a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="AI Sam">
    
    <title>AI Sam - æ™ºèƒ½å°è©±åŠ©æ‰‹</title>
    
    <!-- å­—é«”å’ŒCSSæ¡†æ¶ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&family=Noto+Sans+TC:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <!-- Tailwind é…ç½® -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'sans': ['Inter', 'Noto Sans TC', 'system-ui', 'sans-serif'],
                    },
                    colors: {
                        primary: {
                            50: '#eff6ff',
                            100: '#dbeafe',
                            200: '#bfdbfe', 
                            300: '#93c5fd',
                            400: '#60a5fa',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8',
                            800: '#1e40af',
                            900: '#1e3a8a',
                        }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.6s ease-out',
                        'slide-up': 'slideUp 0.5s ease-out',
                        'slide-down': 'slideDown 0.5s ease-out',
                        'slide-left': 'slideLeft 0.4s ease-out',
                        'slide-right': 'slideRight 0.4s ease-out',
                        'bounce-subtle': 'bounceSubtle 2s ease-in-out infinite',
                        'pulse-glow': 'pulseGlow 2s ease-in-out infinite',
                        'char-pop': 'charPop 0.15s ease-out forwards',
                        'blink': 'blink 1s infinite',
                        'float': 'float 3s ease-in-out infinite',
                        'glow-pulse': 'glowPulse 2s ease-in-out infinite',
                        'shimmer': 'shimmer 2s linear infinite',
                        'scale-bounce': 'scaleBounce 0.6s ease-out',
                        'border-pulse': 'borderPulse 3s ease-in-out infinite',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(20px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' }
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(30px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' }
                        },
                        slideDown: {
                            '0%': { transform: 'translateY(-30px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' }
                        },
                        slideLeft: {
                            '0%': { transform: 'translateX(30px)', opacity: '0' },
                            '100%': { transform: 'translateX(0)', opacity: '1' }
                        },
                        slideRight: {
                            '0%': { transform: 'translateX(-30px)', opacity: '0' },
                            '100%': { transform: 'translateX(0)', opacity: '1' }
                        },
                        bounceSubtle: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-8px)' }
                        },
                        pulseGlow: {
                            '0%, 100%': { boxShadow: '0 0 8px rgba(59, 130, 246, 0.5)' },
                            '50%': { boxShadow: '0 0 25px rgba(59, 130, 246, 0.9)' }
                        },
                        charPop: {
                            '0%': { 
                                opacity: '0', 
                                transform: 'scale(0.3) translateY(20px)',
                                filter: 'blur(3px)'
                            },
                            '50%': { 
                                transform: 'scale(1.1) translateY(-5px)',
                                filter: 'blur(0px)'
                            },
                            '100%': { 
                                opacity: '1', 
                                transform: 'scale(1) translateY(0)',
                                filter: 'blur(0px)'
                            }
                        },
                        blink: {
                            '0%, 50%': { opacity: '1' },
                            '51%, 100%': { opacity: '0' }
                        },
                        float: {
                            '0%, 100%': { transform: 'translateY(0px)' },
                            '50%': { transform: 'translateY(-10px)' }
                        },
                        glowPulse: {
                            '0%, 100%': { 
                                boxShadow: '0 0 20px rgba(59, 130, 246, 0.4), 0 0 40px rgba(59, 130, 246, 0.2)' 
                            },
                            '50%': { 
                                boxShadow: '0 0 30px rgba(59, 130, 246, 0.6), 0 0 60px rgba(59, 130, 246, 0.4)' 
                            }
                        },
                        shimmer: {
                            '0%': { backgroundPosition: '-200px 0' },
                            '100%': { backgroundPosition: '200px 0' }
                        },
                        scaleBounce: {
                            '0%': { transform: 'scale(0.3)', opacity: '0' },
                            '50%': { transform: 'scale(1.1)' },
                            '100%': { transform: 'scale(1)', opacity: '1' }
                        },
                        borderPulse: {
                            '0%, 100%': { 
                                borderColor: '#3b82f6',
                                boxShadow: '0 8px 32px rgba(59, 130, 246, 0.3)'
                            },
                            '25%': { 
                                borderColor: '#8b5cf6',
                                boxShadow: '0 8px 32px rgba(139, 92, 246, 0.4)'
                            },
                            '50%': { 
                                borderColor: '#06b6d4',
                                boxShadow: '0 8px 32px rgba(6, 182, 212, 0.4)'
                            },
                            '75%': { 
                                borderColor: '#10b981',
                                boxShadow: '0 8px 32px rgba(16, 185, 129, 0.4)'
                            }
                        }
                    }
                }
            }
        }
    </script>
    
    <style>
        body {
            font-family: 'Inter', 'Noto Sans TC', system-ui, sans-serif;
            font-weight: 800;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        h1, h2, h3, h4, h5, h6 {
            font-weight: 900 !important;
        }
        
        button, .btn {
            font-weight: 800 !important;
        }
        
        p, span, div {
            font-weight: 700 !important;
        }
        
        .glass-effect {
            backdrop-filter: blur(20px);
            background: rgba(30, 58, 138, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.15);
        }
        
        .chat-bubble {
            max-width: 85%;
            width: auto;
            word-wrap: break-word;
            word-break: break-word;
            overflow-wrap: break-word;
            hyphens: auto;
            font-weight: 600;
            border-radius: 20px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            line-height: 1.5;
            display: inline-block;
            box-sizing: border-box;
            contain: layout style;
            padding: 12px 16px !important;
        }
        
        .chat-bubble::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
            transform: translateX(-100%);
            transition: transform 0.6s;
        }
        
        .chat-bubble:hover::before {
            transform: translateX(100%);
        }
        
        .chat-bubble.user {
            background: linear-gradient(135deg, #4f46e5, #7c3aed, #ec4899);
            color: white;
            margin-left: auto;
            margin-right: 0;
            border-radius: 18px 18px 6px 18px;
            font-weight: 700 !important;
            box-shadow: 0 4px 16px rgba(79, 70, 229, 0.3);
            border: 2px solid rgba(79, 70, 229, 0.5);
            max-width: fit-content;
            min-width: auto;
            flex-shrink: 0;
            white-space: pre-wrap;
            padding: 10px 14px !important;
        }
        
        .chat-bubble.bot {
            background: linear-gradient(135deg, #ffffff, #f8fafc, #e2e8f0);
            color: #1e293b;
            border-radius: 18px 18px 18px 6px;
            font-weight: 700 !important;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
            border: 2px solid #3b82f6;
            margin-right: auto;
            margin-left: 0;
            max-width: fit-content;
            min-width: auto;
            flex-shrink: 0;
            white-space: pre-wrap;
            animation: borderPulse 3s ease-in-out infinite;
            position: relative;
            overflow: visible;
            padding: 8px 12px !important;
            margin: 0 !important;
        }
        
        .chat-bubble.bot * {
            margin: 0 !important;
            padding: 0 !important;
        }
        
        .chat-bubble.bot p {
            margin: 0 !important;
            padding: 0 !important;
            line-height: 1.5 !important;
        }
        
        .chat-bubble.bot div {
            margin: 0 !important;
            padding: 0 !important;
            line-height: 1.5 !important;
        }
        
        .chat-bubble.bot p + p,
        .chat-bubble.bot div + div {
            margin-top: 8px !important;
        }
        
        .sidebar {
            width: 340px;
            background: linear-gradient(135deg, #1e3a8a, #1d4ed8, #2563eb);
            transform: translateX(-100%);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 8px 0 32px rgba(0, 0, 0, 0.3);
        }
        
        .sidebar.open {
            transform: translateX(0);
        }
        
        .conversation-item {
            padding: 16px 20px;
            margin: 8px 0;
            border-radius: 16px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            font-weight: 700;
            position: relative;
            overflow: hidden;
        }
        
        .conversation-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        
        .conversation-item:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateX(8px) scale(1.02);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }
        
        .conversation-item:hover::before {
            left: 100%;
        }
        
        .conversation-item.active {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
            box-shadow: 0 0 32px rgba(255, 255, 255, 0.3);
        }
        
        .scroll-area {
            scrollbar-width: thin;
            scrollbar-color: rgba(59, 130, 246, 0.6) transparent;
        }
        
        .scroll-area::-webkit-scrollbar {
            width: 8px;
        }
        
        .scroll-area::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }
        
        .scroll-area::-webkit-scrollbar-thumb {
            background: rgba(59, 130, 246, 0.6);
            border-radius: 4px;
            transition: background 0.3s;
        }
        
        .scroll-area::-webkit-scrollbar-thumb:hover {
            background: rgba(59, 130, 246, 0.8);
        }
        
        /* é–‹ç™¼è€…æ¨¡å¼å°ˆç”¨æ»¾å‹•æ¢ - æ›´æ˜é¡¯çš„æ¨£å¼ */
        .developer-scrollbar {
            scrollbar-width: thick;
            scrollbar-color: rgba(147, 51, 234, 0.8) rgba(55, 65, 81, 0.5);
        }
        
        .developer-scrollbar::-webkit-scrollbar {
            width: 14px;
        }
        
        .developer-scrollbar::-webkit-scrollbar-track {
            background: linear-gradient(to bottom, rgba(55, 65, 81, 0.5), rgba(75, 85, 99, 0.6));
            border-radius: 7px;
            border: 2px solid rgba(147, 51, 234, 0.3);
        }
        
        .developer-scrollbar::-webkit-scrollbar-thumb {
            background: linear-gradient(to bottom, rgba(147, 51, 234, 0.8), rgba(126, 34, 206, 0.9));
            border-radius: 7px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(147, 51, 234, 0.4);
        }
        
        .developer-scrollbar::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(to bottom, rgba(168, 85, 247, 0.9), rgba(147, 51, 234, 1));
            border-color: rgba(255, 255, 255, 0.2);
            box-shadow: 0 4px 12px rgba(147, 51, 234, 0.6);
            transform: scale(1.1);
        }
        
        .developer-scrollbar::-webkit-scrollbar-thumb:active {
            background: linear-gradient(to bottom, rgba(196, 181, 253, 0.9), rgba(168, 85, 247, 1));
            box-shadow: 0 2px 6px rgba(147, 51, 234, 0.8);
        }
        
        /* Firefox é–‹ç™¼è€…æ»¾å‹•æ¢ */
        .developer-scrollbar {
            scrollbar-width: thick;
            scrollbar-color: rgba(147, 51, 234, 0.9) rgba(75, 85, 99, 0.5);
        }
        
        .page {
            display: none;
            animation: fadeIn 0.6s ease-out;
        }
        
        .page.active {
            display: block;
        }
        
        .typewriter-cursor {
            animation: blink 1s infinite;
            font-weight: 100;
            color: #3b82f6;
        }
        
        .char-container {
            display: inline-block;
            opacity: 0;
        }
        
        .loading-dots {
            display: inline-block;
        }
        
        .loading-dots::after {
            content: '';
            animation: dots 1.5s infinite;
        }
        
        @keyframes dots {
            0%, 20% { content: ''; }
            40% { content: '.'; }
            60% { content: '..'; }
            80%, 100% { content: '...'; }
        }
        
        .file-upload-area {
            border: 3px dashed rgba(255, 255, 255, 0.3);
            border-radius: 16px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .file-upload-area:hover {
            border-color: rgba(59, 130, 246, 0.6);
            background: rgba(59, 130, 246, 0.1);
            transform: scale(1.02);
        }
        
        .file-upload-area.drag-over {
            border-color: #60a5fa;
            background: rgba(96, 165, 250, 0.2);
            transform: scale(1.05);
            box-shadow: 0 0 32px rgba(96, 165, 250, 0.4);
        }
        
        /* éŸ¿æ‡‰å¼è¨­è¨ˆ - ç¢ºä¿é›»è…¦å’Œæ‰‹æ©Ÿç‰ˆä¸€è‡´æ€§ */
        @media (max-width: 768px) {
            /* å´é‚Šæ¬„åœ¨æ‰‹æ©Ÿä¸Šå…¨è¢å¹•è¦†è“‹ */
            .sidebar {
                width: 100%;
                position: fixed;
                top: 0;
                left: 0;
                height: 100vh;
                z-index: 50;
                transform: translateX(-100%);
            }
            
            .sidebar.open {
                transform: translateX(0);
            }
            
            /* èŠå¤©æ°£æ³¡ä¿æŒæ¡Œé¢ç‰ˆç›¸åŒæ¨£å¼ */
            .chat-bubble {
                max-width: 85%;
                padding: 10px 14px !important;
                word-break: break-word;
                overflow-wrap: break-word;
                font-size: 16px; /* é˜²æ­¢ç¸®æ”¾ */
            }
            
            .chat-bubble.bot {
                max-width: 85%;
                margin-right: auto;
                margin-left: 0;
                border: 2px solid #3b82f6;
                background: linear-gradient(135deg, #ffffff, #f8fafc, #e2e8f0);
                padding: 10px 14px !important;
                font-size: 16px;
            }
            
            .chat-bubble.user {
                max-width: 85%;
                margin-left: auto;
                margin-right: 0;
                padding: 10px 14px !important;
                font-size: 16px;
            }
            
            /* èŠå¤©å®¹å™¨é©é…æ‰‹æ©Ÿ */
            #messagesContainer {
                padding: 0 16px;
                max-width: 100%;
                box-sizing: border-box;
            }
            
            #chatArea {
                padding: 16px;
            }
            
            /* è¼¸å…¥å€åŸŸå„ªåŒ– */
            #messageInput {
                font-size: 16px !important; /* é˜²æ­¢iOSç¸®æ”¾ */
                min-height: 44px; /* ç¬¦åˆè§¸æ§æ¨™æº– */
            }
            
            /* æŒ‰éˆ•å„ªåŒ– - ç¢ºä¿è§¸æ§å‹å¥½ */
            button, .btn {
                min-height: 44px;
                min-width: 44px;
                font-size: 16px;
                padding: 12px 16px;
            }
            
            /* æ–‡ä»¶ä¸Šå‚³å€åŸŸé©é… */
            #fileUploadOptions {
                max-height: 300px;
                overflow-y: auto;
            }
            
            .file-upload-area {
                padding: 16px;
                min-height: 60px;
            }
            
            /* æ¨™é¡Œå€åŸŸé©é… */
            header {
                padding: 16px;
            }
            
            header h1 {
                font-size: 18px;
            }
            
            header p {
                font-size: 14px;
            }
            
            /* ç¢ºä¿å´é‚Šæ¬„å°è©±é …ç›®è§¸æ§å‹å¥½ */
            .conversation-item {
                padding: 16px 20px;
                min-height: 60px;
            }
            
            /* Toasté€šçŸ¥é©é…æ‰‹æ©Ÿ */
            .toast-notification {
                top: 20px;
                right: 16px;
                left: 16px;
                width: auto;
                text-align: center;
                font-size: 14px;
                padding: 12px 16px;
            }
            
            /* æ¨¡æ…‹æ¡†é©é…æ‰‹æ©Ÿè¢å¹• */
            .fixed.inset-0.bg-black {
                padding: 16px;
            }
            
            /* ç¢ºä¿é–‹ç™¼è€…æ¨¡å¼åœ¨æ‰‹æ©Ÿä¸Šæ­£å¸¸é¡¯ç¤º */
            .developer-scrollbar {
                scrollbar-width: thick;
                scrollbar-color: rgba(147, 51, 234, 0.8) rgba(55, 65, 81, 0.5);
            }
            
            .developer-scrollbar::-webkit-scrollbar {
                width: 12px; /* æ‰‹æ©Ÿä¸Šç¨å¾®èª¿å°ä½†ä»ç„¶æ˜é¡¯ */
            }
            
            /* åé¥‹å°è©±æ¡†é©é… */
            .bg-gradient-to-br.from-blue-600.to-blue-800 {
                max-height: 85vh;
                overflow-y: auto;
            }
            
            /* é–‹ç™¼è€…æ¨¡å¼å°è©±æ¡†é©é… */
            .bg-gradient-to-br.from-gray-900.to-gray-800 {
                max-height: 90vh;
                margin: 8px;
            }
            
            /* ç¢ºä¿çµ±è¨ˆå¡ç‰‡åœ¨æ‰‹æ©Ÿä¸Šæ’åˆ—æ•´é½Š */
            .grid.grid-cols-4 {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }
            
            .grid.grid-cols-4 > div {
                min-height: 60px;
            }
            
            /* åé¥‹é …ç›®åœ¨æ‰‹æ©Ÿä¸Šçš„é©é… */
            .bg-white.bg-opacity-10.rounded-xl.p-6 {
                padding: 16px;
                margin-bottom: 16px;
            }
            
            /* ç¢ºä¿æŒ‰éˆ•ç¶²æ ¼åœ¨æ‰‹æ©Ÿä¸Šæ­£ç¢ºé¡¯ç¤º */
            .grid.grid-cols-2.md\\:grid-cols-4 {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }
            
            /* é ‚éƒ¨æ¨™é¡Œé©é… */
            .flex.items-center.space-x-6 {
                space-x: 12px;
            }
            
            /* AI Sam Logoåœ¨æ‰‹æ©Ÿä¸Šçš„å°ºå¯¸ */
            .w-16.h-16 {
                width: 48px;
                height: 48px;
            }
            
            /* ç¢ºä¿æ–‡å­—å¤§å°åœ¨æ‰‹æ©Ÿä¸Šé©ä¸­ */
            .text-xl.md\\:text-2xl {
                font-size: 18px;
            }
            
            .text-sm.md\\:text-base {
                font-size: 14px;
            }
            
            /* ç”¨æˆ¶æ¶ˆæ¯æ“ä½œæŒ‰éˆ•é©é… */
            .group-hover\\:opacity-100 {
                opacity: 1; /* æ‰‹æ©Ÿä¸Šç›´æ¥é¡¯ç¤ºï¼Œç„¡éœ€æ‡¸åœ */
            }
            
            /* åœæ­¢æŒ‰éˆ•é©é… */
            .stop-ai-button {
                font-size: 14px;
                padding: 8px 12px;
            }
            
            /* å¯†ç¢¼å°è©±æ¡†é©é… */
            .max-w-sm.w-full.mx-4.p-6 {
                margin: 16px;
                padding: 20px;
            }
            
            /* ç¢ºä¿æ‰€æœ‰è¼¸å…¥æ¡†éƒ½ç¬¦åˆè§¸æ§æ¨™æº– */
            input[type="text"], 
            input[type="password"], 
            textarea {
                font-size: 16px !important;
                min-height: 44px;
                border-radius: 12px;
            }
            
            /* æ–‡ä»¶é¸æ“‡å™¨é©é… */
            .file-upload-area label {
                font-size: 14px;
                cursor: pointer;
                display: block;
                width: 100%;
            }
            
            /* ç¢ºä¿èƒŒæ™¯åœ–ç‰‡åœ¨æ‰‹æ©Ÿä¸Šæ­£ç¢ºé¡¯ç¤º */
            body {
                background-attachment: scroll; /* æ‰‹æ©Ÿä¸Šä½¿ç”¨scrollè€Œéfixed */
            }
        }
        
        /* è¶…å°è¢å¹•é©é… (< 480px) */
        @media (max-width: 480px) {
            /* é€²ä¸€æ­¥å„ªåŒ–å°è¢å¹•é«”é©— */
            .chat-bubble {
                max-width: 90%;
                font-size: 15px;
            }
            
            #messagesContainer {
                padding: 0 12px;
            }
            
            #chatArea {
                padding: 12px;
            }
            
            header {
                padding: 12px;
            }
            
            /* é–‹ç™¼è€…æ¨¡å¼çµ±è¨ˆå¡ç‰‡å †ç–Š */
            .grid.grid-cols-4 {
                grid-template-columns: 1fr;
                gap: 8px;
            }
            
            /* åé¥‹å°è©±æ¡†æŒ‰éˆ•å †ç–Š */
            .grid.grid-cols-2 {
                grid-template-columns: 1fr;
                gap: 8px;
            }
        }
        
        /* æ©«å‘æ¨¡å¼é©é… */
        @media (max-width: 896px) and (orientation: landscape) {
            /* æ©«å‘æ¨¡å¼ä¸‹çš„ç‰¹æ®Šè™•ç† */
            .max-h-\\[90vh\\] {
                max-height: 80vh;
            }
            
            .max-h-\\[85vh\\] {
                max-height: 75vh;
            }
            
            .min-h-\\[400px\\] {
                min-height: 250px;
            }
        }
        
        .input-focus-glow:focus {
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3), 0 0 32px rgba(59, 130, 246, 0.2);
            border-color: #3b82f6;
        }
        
        .button-hover-lift:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }
        
        .smooth-transition {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .shimmer-effect {
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            background-size: 200px 100%;
            animation: shimmer 2s infinite;
        }
        
        .message-sending {
            opacity: 0.7;
            transform: scale(0.98);
            transition: all 0.3s ease;
        }
        
        .message-sent {
            opacity: 1;
            transform: scale(1);
        }
    </style>
</head>

<body class="text-white overflow-hidden" style="background: linear-gradient(rgba(30, 58, 138, 0.8), rgba(30, 58, 138, 0.9)), url('https://pfst.cf2.poecdn.net/base/image/acb6b82c57d244fe0e361d061d76c62c419e527784a779c1df54afcba879baca?w=1344&h=768'); background-size: cover; background-position: center; background-attachment: fixed; background-repeat: no-repeat;">
    
    <!-- ç¬¬ä¸€é ï¼šä¸»é ä»‹ç´¹ -->
    <div id="homePage" class="page active fixed inset-0 overflow-y-auto scroll-area">
        <div class="min-h-screen flex flex-col items-center justify-start py-8 px-4 pb-20">
            <!-- ä¸»æ¨™é¡Œå’ŒLogo -->
            <div class="text-center mb-12 animate-fade-in">
                <div class="flex flex-col md:flex-row items-center justify-center mb-10">
                    <!-- AI Sam Logo -->
                    <div class="w-28 h-28 md:w-32 md:h-32 rounded-full flex items-center justify-center animate-float shadow-2xl mb-8 md:mb-0 md:mr-10 relative overflow-hidden animate-glow-pulse">
                        <!-- AI Sam Logo Image -->
                        <img src="https://pfst.cf2.poecdn.net/base/image/c2a2e1e3ae9aa65d2e708d5fd6f992917d847aea6b6e5c26a7311b68f51dc4f0?w=504&h=594" 
                             alt="AI Sam Logo" 
                             class="w-full h-full object-contain rounded-full"
                             style="object-fit: contain; width: 100%; height: 100%;">
                        
                        <!-- å¢å¼·é–ƒçˆæ•ˆæœ -->
                        <div class="absolute inset-0 bg-gradient-to-br from-cyan-300 via-transparent to-blue-400 opacity-20 animate-pulse rounded-full"></div>
                        
                        <!-- ç™¼å…‰å…‰ç’°æ•ˆæœ -->
                        <div class="absolute -inset-2 bg-gradient-to-r from-cyan-400 to-blue-500 rounded-full blur opacity-30 animate-pulse"></div>
                    </div>
                    <div class="text-center md:text-left">
                        <div class="flex items-center justify-center md:justify-start mb-4">
                            <h1 class="text-4xl md:text-5xl font-black text-white tracking-wide animate-slide-right">AI Sam</h1>
                        </div>
                        <p class="text-2xl md:text-3xl text-blue-200 font-bold animate-slide-left">æ™ºèƒ½å°è©±åŠ©æ‰‹å¹³å°</p>
                    </div>
                </div>
            </div>
            
            <!-- æ­¡è¿å…§å®¹å¡ç‰‡ -->
            <div class="max-w-6xl w-full bg-white bg-opacity-10 backdrop-blur-lg rounded-3xl border border-white border-opacity-20 p-10 md:p-16 shadow-2xl mb-12 animate-slide-up smooth-transition hover:bg-opacity-15">
                <!-- æ­¡è¿æ¨™é¡Œ -->
                <div class="text-center mb-12">
                    <h2 class="text-3xl md:text-4xl font-black text-white mb-6">ğŸŒŸ æ­¡è¿ä¾†åˆ° AI SamåŠ©ç†ï¼</h2>
                    <div class="w-48 h-2 bg-gradient-to-r from-blue-400 via-purple-500 to-pink-500 mx-auto rounded-full"></div>
                </div>
                
                <!-- æ­¡è¿èªå’Œå¹³å°ç°¡ä»‹ -->
                <div class="text-center mb-14">
                    <p class="text-lg md:text-xl text-white font-bold leading-loose mb-10 max-w-5xl mx-auto">
                        AI Sam æ˜¯æ‚¨çš„æ™ºèƒ½åŠ©ç†ï¼Œé‹ç”¨è¨­è¨ˆæ€ç¶­æ–¹æ³•ä¾†è§£æ±ºå„ç¨®å•é¡Œã€‚æ¶µè“‹å»£æ³›çš„æ‡‰ç”¨ åŒ…æ‹¬, æœå‹™æˆ–å•†æ¥­è¨­è¨ˆã€æ—¥å¸¸ç”Ÿæ´»ã€æ•™è‚²ç­‰å„é ˜åŸŸã€‚
                        <br><br>
                        AI Sam ç‰¹åˆ¥é©ç”¨æ–¼å­¸æ¥­ç¯„ç–‡æ–¹é¢ã€‚éš¨è‘—äººå·¥æ™ºèƒ½çš„ç™¼é”~ æœƒæŒçºŒå„ªåŒ–è§£æ±ºæ–¹æ¡ˆï¼Œæœ€çµ‚å‰µé€ æ›´ç¬¦åˆä½¿ç”¨è€…çš„éœ€æ±‚ã€‚
                    </p>
                    
                    <!-- å¹³å°æ ¸å¿ƒåŠŸèƒ½ç°¡ä»‹ -->
                    <div class="bg-white bg-opacity-5 rounded-3xl p-10 border-2 border-white border-opacity-20 smooth-transition hover:bg-opacity-10 shadow-lg">
                        <h3 class="text-white font-black text-lg mb-8">ğŸ¤– æˆ‘å€‘çš„AIåŠ©æ‰‹èƒ½å¤ ï¼š</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 text-blue-100 font-bold text-base">
                            <div class="flex items-start space-x-4 smooth-transition hover:transform hover:scale-105 p-4 rounded-xl hover:bg-white hover:bg-opacity-10">
                                <span class="text-green-400 text-2xl">ğŸ¤–</span>
                                <span class="leading-relaxed">å¼·å‹çš„AIåŠ©æ‰‹ï¼Œçµ¦äºˆæœ€é©åˆçš„å»ºè­°å’Œç­”æ¡ˆ</span>
                            </div>
                            <div class="flex items-start space-x-4 smooth-transition hover:transform hover:scale-105 p-4 rounded-xl hover:bg-white hover:bg-opacity-10">
                                <span class="text-purple-400 text-2xl">ğŸ¯</span>
                                <span class="leading-relaxed">ç·Šè²¼ç”¨å®¶çš„éœ€æ±‚ï¼ŒæŒçºŒæ”¹å–„å¹³å°çš„æº–ç¢ºæ€§</span>
                            </div>
                            <div class="flex items-start space-x-4 smooth-transition hover:transform hover:scale-105 p-4 rounded-xl hover:bg-white hover:bg-opacity-10">
                                <span class="text-blue-400 text-2xl">âš¡</span>
                                <span class="leading-relaxed">å¹³å°çš„ç‰ˆé¢ç°¡å–®æ•´æ½”ï¼Œæ“ä½œå¿«é€Ÿ</span>
                            </div>
                            <div class="flex items-start space-x-4 smooth-transition hover:transform hover:scale-105 p-4 rounded-xl hover:bg-white hover:bg-opacity-10">
                                <span class="text-yellow-400 text-2xl">ğŸ“</span>
                                <span class="leading-relaxed">å¯ä»¥æ”¯æ´ä¸åŒæ ¼å¼çš„æª”æ¡ˆ å¼·å¤§çš„æª”æ¡ˆåˆ†æåŠŸèƒ½</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- æ¨™é¡Œï¼šæ•¸æ“šå®‰å…¨æ‰¿è«¾ -->
                <div class="text-center mb-12">
                    <div class="w-24 h-24 bg-green-500 rounded-full flex items-center justify-center mx-auto mb-6 animate-glow-pulse">
                        <svg class="w-12 h-12 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path>
                        </svg>
                    </div>
                    <h3 class="text-2xl md:text-3xl font-black text-white mb-6">ğŸ”’ æ•¸æ“šå®‰å…¨æ‰¿è«¾</h3>
                </div>
                
                <!-- çµ±ä¸€çš„å®‰å…¨ä¿éšœé …ç›®å®¹å™¨ -->
                <div class="bg-white bg-opacity-5 rounded-3xl p-8 md:p-12 border-2 border-white border-opacity-30 smooth-transition hover:bg-opacity-10 shadow-2xl mb-12">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 md:gap-8">
                        <!-- ä¿å­˜å°è©±ç´€éŒ„ -->
                        <div class="flex flex-col items-center text-center p-6 rounded-2xl bg-white bg-opacity-10 border border-white border-opacity-20 smooth-transition hover:bg-opacity-20 hover:transform hover:scale-105 shadow-lg">
                            <div class="w-16 h-16 bg-blue-500 bg-opacity-30 rounded-full flex items-center justify-center mb-4 animate-float">
                                <svg class="w-8 h-8 text-blue-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path>
                                </svg>
                            </div>
                            <h3 class="text-white font-black text-base mb-3 flex items-center justify-center">
                                <span class="mr-2">ğŸ’¾</span>ä¿å­˜å°è©±ç´€éŒ„
                            </h3>
                            <p class="text-blue-100 font-bold text-sm leading-relaxed">æ‰€æœ‰èˆ‡AIçš„å°è©±ç´€éŒ„éƒ½æœƒå®‰å…¨ä¿å­˜ï¼Œæ–¹ä¾¿æ‚¨éš¨æ™‚æŸ¥é–±å’Œç®¡ç†</p>
                        </div>
                        
                        <!-- é«˜å¼·åº¦åŠ å¯† -->
                        <div class="flex flex-col items-center text-center p-6 rounded-2xl bg-white bg-opacity-10 border border-white border-opacity-20 smooth-transition hover:bg-opacity-20 hover:transform hover:scale-105 shadow-lg">
                            <div class="w-16 h-16 bg-yellow-500 bg-opacity-30 rounded-full flex items-center justify-center mb-4 animate-float" style="animation-delay: 0.2s;">
                                <svg class="w-8 h-8 text-yellow-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                                </svg>
                            </div>
                            <h3 class="text-white font-black text-base mb-3 flex items-center justify-center">
                                <span class="mr-2">ğŸ”</span>é«˜å¼·åº¦åŠ å¯†
                            </h3>
                            <p class="text-blue-100 font-bold text-sm leading-relaxed">æ¡ç”¨æ¥­ç•Œæœ€é«˜æ¨™æº–çš„åŠ å¯†æŠ€è¡“ï¼Œç¢ºä¿æ‚¨çš„æ•¸æ“šçµ•å°å®‰å…¨</p>
                        </div>
                        
                        <!-- æ¬Šé™å­˜å– -->
                        <div class="flex flex-col items-center text-center p-6 rounded-2xl bg-white bg-opacity-10 border border-white border-opacity-20 smooth-transition hover:bg-opacity-20 hover:transform hover:scale-105 shadow-lg">
                            <div class="w-16 h-16 bg-cyan-500 bg-opacity-30 rounded-full flex items-center justify-center mb-4 animate-float" style="animation-delay: 0.4s;">
                                <svg class="w-8 h-8 text-cyan-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                                </svg>
                            </div>
                            <h3 class="text-white font-black text-base mb-3 flex items-center justify-center">
                                <span class="mr-2">ğŸ‘¥</span>æ¬Šé™å­˜å–
                            </h3>
                            <p class="text-blue-100 font-bold text-sm leading-relaxed">åš´æ ¼æ§åˆ¶æ•¸æ“šå­˜å–æ¬Šé™ï¼Œåªæœ‰æˆæ¬Šäººå“¡æ‰èƒ½æŸ¥çœ‹ç›¸é—œè³‡æ–™</p>
                        </div>
                        
                        <!-- æœ€å®‰å…¨é˜²è­·ç´šåˆ¥ -->
                        <div class="flex flex-col items-center text-center p-6 rounded-2xl bg-white bg-opacity-10 border border-white border-opacity-20 smooth-transition hover:bg-opacity-20 hover:transform hover:scale-105 shadow-lg lg:col-span-1 md:col-span-1">
                            <div class="w-16 h-16 bg-purple-500 bg-opacity-30 rounded-full flex items-center justify-center mb-4 animate-float" style="animation-delay: 0.6s;">
                                <svg class="w-8 h-8 text-purple-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
                                </svg>
                            </div>
                            <h3 class="text-white font-black text-base mb-3 flex items-center justify-center">
                                <span class="mr-2">ğŸ›¡ï¸</span>æœ€å®‰å…¨é˜²è­·ç´šåˆ¥
                            </h3>
                            <p class="text-blue-100 font-bold text-sm leading-relaxed">æä¾›æœ€é«˜ç­‰ç´šçš„å®‰å…¨é˜²è­·ï¼Œå…¨æ–¹ä½ä¿éšœæ‚¨çš„éš±ç§å’Œæ•¸æ“šå®‰å…¨</p>
                        </div>
                        
                        <!-- å°è©±æ•¸æ“šéš±ç§ - è·¨å…©åˆ—åœ¨æ¡Œé¢ç‰ˆ -->
                        <div class="flex flex-col items-center text-center p-6 rounded-2xl bg-gradient-to-br from-blue-600 from-opacity-20 to-cyan-600 to-opacity-30 border-2 border-blue-400 border-opacity-40 smooth-transition hover:bg-opacity-30 hover:transform hover:scale-105 shadow-lg lg:col-span-2 md:col-span-2">
                            <div class="w-16 h-16 bg-blue-500 bg-opacity-40 rounded-full flex items-center justify-center mb-4 animate-float" style="animation-delay: 0.8s;">
                                <svg class="w-8 h-8 text-blue-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                            <h3 class="text-white font-black text-base mb-3 flex items-center justify-center">
                                <span class="mr-2">ğŸ”’</span>å°è©±æ•¸æ“šéš±ç§
                            </h3>
                            <p class="text-blue-100 font-bold text-sm leading-relaxed max-w-3xl">åš´æ ¼ä¿è­·æ‚¨çš„å°è©±éš±ç§ï¼Œçµ•ä¸æœƒæ´©éœ²æˆ–æ¿«ç”¨å€‹äººè³‡æ–™ï¼Œç¢ºä¿æ‰€æœ‰äº¤æµå…§å®¹å®Œå…¨ä¿å¯†</p>
                        </div>
                    </div>
                </div>
                
                <!-- é€²å…¥æŒ‰éµ -->
                <div class="text-center mb-10">
                    <button id="enterChatBotBtn" class="group relative px-12 md:px-20 py-6 bg-white bg-opacity-20 hover:bg-opacity-30 border-3 border-white border-opacity-50 rounded-3xl transition-all duration-500 transform hover:scale-110 hover:shadow-2xl w-full md:w-auto button-hover-lift animate-glow-pulse">
                        <div class="absolute inset-0 bg-gradient-to-r from-blue-400 via-purple-500 to-pink-500 rounded-3xl opacity-0 group-hover:opacity-25 transition-opacity duration-500"></div>
                        <span class="relative text-white font-black text-2xl md:text-3xl tracking-wide">ğŸ¤– ç«‹å³é€²å…¥ChatBotç‰ˆé¢</span>
                        <div class="absolute -inset-1 bg-gradient-to-r from-blue-400 via-purple-500 to-pink-500 rounded-3xl blur opacity-20 group-hover:opacity-50 transition-opacity duration-500"></div>
                    </button>
                </div>
            </div>
            

        </div>
        

    </div>

    <!-- åŠ è¼‰éæ¸¡é é¢ -->
    <div id="loadingPage" class="page fixed inset-0 overflow-hidden">
        <div class="min-h-screen flex flex-col items-center justify-center" style="background: linear-gradient(135deg, #e0f2fe, #b3e5fc, #81d4fa, #4fc3f7);">
            <!-- åŠ è¼‰åœ–æ¨™ -->
            <div class="mb-8 animate-bounce-subtle">
                <div class="w-28 h-28 bg-white bg-opacity-25 rounded-2xl flex items-center justify-center animate-glow-pulse shadow-xl">
                    <!-- ChatBot åœ–æ¨™ -->
                    <div class="w-16 h-16 bg-white rounded-xl flex items-center justify-center animate-float">
                        <svg class="w-10 h-10 text-blue-600" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                        </svg>
                    </div>
                </div>
            </div>
            
            <!-- åŠ è¼‰æ¨™é¡Œ -->
            <div class="text-center mb-8 animate-fade-in">
                <h2 class="text-xl md:text-2xl font-medium text-slate-700 mb-3 tracking-normal">
                    æ­£åœ¨é€²å…¥ ChatBot å°è©±æ¨¡å¼...
                </h2>
                <p class="text-base text-slate-600 font-normal">
                    AI Sam æ­£åœ¨ç‚ºæ‚¨æº–å‚™æ™ºèƒ½å°è©±ç’°å¢ƒ
                </p>
            </div>
            
            <!-- é€²åº¦æ¢ -->
            <div class="w-full max-w-sm mb-8 animate-slide-up">
                <div class="bg-white bg-opacity-30 rounded-full h-3 overflow-hidden shadow-md">
                    <div id="loadingProgress" class="bg-gradient-to-r from-blue-400 to-cyan-500 h-full rounded-full transition-all duration-1000 ease-out animate-shimmer" style="width: 0%"></div>
                </div>
                <div class="flex justify-between mt-3 text-slate-600 font-normal text-xs">
                    <span>åˆå§‹åŒ–ä¸­...</span>
                    <span id="loadingPercentage">0%</span>
                </div>
            </div>
            
            <!-- åŠ è¼‰ç‹€æ…‹æ–‡å­— -->
            <div class="text-center animate-pulse">
                <p id="loadingStatus" class="text-sm text-slate-600 font-normal">
                    è«‹ç¨å€™...
                </p>
            </div>
            

        </div>
    </div>

    <!-- ç¬¬äºŒé ï¼šChatBotåŠ©æ‰‹ç‰ˆé¢ -->
    <div id="chatPage" class="page">
        <!-- å´é‚Šæ¬„é®ç½© -->
        <div id="sidebarOverlay" class="fixed inset-0 bg-black bg-opacity-70 z-40 hidden md:hidden smooth-transition"></div>
        
        <!-- å´é‚Šæ¬„ -->
        <div id="sidebar" class="sidebar fixed top-0 left-0 h-full z-50 flex flex-col">
            <!-- å´é‚Šæ¬„æ¨™é¡Œ -->
            <div class="p-8 border-b border-white border-opacity-20">
                <div class="flex items-center justify-between">
                    <h2 class="text-xl font-black text-white">ğŸ’¬ å°è©±ç´€éŒ„</h2>
                    <!-- é—œé–‰æŒ‰éˆ• -->
                    <button id="closeSidebar" class="text-white hover:bg-white hover:bg-opacity-20 p-3 rounded-xl transition-all duration-200 button-hover-lift" title="é—œé–‰å°è©±ç´€éŒ„">
                        <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>
            
            <!-- æ–°å°è©±æŒ‰éˆ• -->
            <div class="p-6">
                <button id="newChatBtn" class="w-full bg-white bg-opacity-20 hover:bg-opacity-30 text-white font-black py-4 px-6 rounded-2xl transition-all duration-300 flex items-center justify-center space-x-4 button-hover-lift animate-glow-pulse">
                    <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                    </svg>
                    <span class="text-lg">æ–°å°è©±</span>
                </button>
            </div>
            
            <!-- å°è©±ç´€éŒ„åˆ—è¡¨ -->
            <div class="flex-1 overflow-y-auto scroll-area px-6 pb-4">
                <div id="conversationList">
                    <!-- å°è©±é …ç›®å°‡åœ¨é€™è£¡å‹•æ…‹ç”Ÿæˆ -->
                </div>
            </div>
            
            <!-- åº•éƒ¨æŒ‰éˆ• - æ”¹ç‚ºè¿”å›åˆ°ChatBot -->
            <div class="p-6 border-t border-white border-opacity-20">
                <div class="grid grid-cols-1 gap-4">
                    <!-- ç”¨æˆ¶åé¥‹æŒ‰éˆ• -->
                    <button id="userFeedbackBtn" class="border-2 border-orange-400 bg-transparent hover:bg-orange-500 hover:bg-opacity-20 text-white font-bold py-4 px-5 rounded-2xl transition-all duration-300 flex items-center justify-center space-x-3 text-sm button-hover-lift">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                        </svg>
                        <span>â­ ç”¨å®¶åæ˜ </span>
                    </button>
                    <button id="backToChatBotBtn" class="border-2 border-purple-400 bg-transparent hover:bg-purple-500 hover:bg-opacity-20 text-white font-bold py-4 px-5 rounded-2xl transition-all duration-300 flex items-center justify-center space-x-3 text-base button-hover-lift">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                        </svg>
                        <span>è¿”å›åˆ°åŠ©æ‰‹é é¢</span>
                    </button>
                    <button id="backToHomeBtn" class="border-2 border-blue-400 bg-transparent hover:bg-blue-500 hover:bg-opacity-20 text-white font-bold py-4 px-5 rounded-2xl transition-all duration-300 flex items-center justify-center space-x-3 text-base button-hover-lift">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m0-11l7 7m0-5v5a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-1a1 1 0 011-1h2a1 1 0 011 1v1a1 1 0 001 1m-6 0h6"></path>
                        </svg>
                        <span>è¿”å›é¦–é </span>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- ä¸»è¦å…§å®¹å€ -->
        <div class="flex-1 flex flex-col h-screen ml-0 md:ml-0">
            <!-- é ‚éƒ¨æ¨™é¡Œæ¬„ -->
            <header class="glass-effect p-6 flex items-center justify-between border-b border-white border-opacity-10">
                <div class="flex items-center space-x-6">
                    <button id="openSidebar" class="text-white hover:bg-white hover:bg-opacity-20 p-3 rounded-xl transition-all duration-200 button-hover-lift">
                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                        </svg>
                    </button>
                    
                    <div class="flex items-center space-x-5">
                        <!-- AI Sam Logo - ChatBotç‰ˆæœ¬ -->
                        <div class="w-16 h-16 rounded-full flex items-center justify-center shadow-lg relative overflow-hidden">
                            <!-- AI Sam Logo Image -->
                            <img src="https://pfst.cf2.poecdn.net/base/image/c2a2e1e3ae9aa65d2e708d5fd6f992917d847aea6b6e5c26a7311b68f51dc4f0?w=504&h=594" 
                                 alt="AI Sam Logo" 
                                 class="w-full h-full object-contain rounded-full"
                                 style="object-fit: contain; width: 100%; height: 100%;">
                            
                            <!-- å¢å¼·é–ƒçˆæ•ˆæœ -->
                            <div class="absolute inset-0 bg-gradient-to-br from-cyan-300 via-transparent to-blue-400 opacity-15 rounded-full"></div>
                            
                            <!-- ç™¼å…‰å…‰ç’°æ•ˆæœ -->
                            <div class="absolute -inset-1 bg-gradient-to-r from-cyan-400 to-blue-500 rounded-full blur opacity-25"></div>
                        </div>
                        <div>
                            <h1 class="text-xl md:text-2xl font-black text-white">AI Samæ™ºèƒ½åŠ©ç† ğŸ¤–</h1>
                            <p class="text-sm md:text-base text-blue-200 font-bold">æ™ºèƒ½å°è©±åŠ©æ‰‹ â€¢ AI Samåœ¨ç·šä¸­...</p>
                        </div>
                    </div>
                </div>
            </header>
            
            <!-- èŠå¤©å€åŸŸ -->
            <div class="flex-1 overflow-y-auto scroll-area p-6" id="chatArea">
                <div id="messagesContainer" class="space-y-8 max-w-6xl mx-auto">
                    <!-- æ­¡è¿æ¶ˆæ¯æœƒåœ¨é€™è£¡å‹•æ…‹åŠ è¼‰ -->
                </div>
            </div>
            
            <!-- è¼¸å…¥å€åŸŸ - é€²ä¸€æ­¥ç¸®å° -->
            <div class="glass-effect border-t border-white border-opacity-10 p-2">
                <!-- æ–‡ä»¶ä¸Šå‚³é¸é … -->
                <div id="fileUploadOptions" class="hidden max-w-6xl mx-auto mb-2 p-3 bg-white bg-opacity-10 rounded-xl border border-white border-opacity-20 animate-slide-down overflow-y-auto scroll-area max-h-80">
                    <div class="flex items-center justify-between mb-2">
                        <h4 class="text-white font-black text-sm">ğŸ“ æ–°å¢æª”æ¡ˆ</h4>
                        <button id="closeFileOptions" class="text-white hover:text-red-300 p-1 rounded-lg transition-all duration-200 button-hover-lift">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-1 gap-2">
                        <!-- ç…§ç‰‡ä¸Šå‚³ -->
                        <div class="file-upload-area flex items-center space-x-2 p-2 bg-white bg-opacity-10 rounded-xl hover:bg-opacity-20 transition-all duration-300">
                            <div class="w-8 h-8 bg-blue-500 bg-opacity-30 rounded-xl flex items-center justify-center">
                                <svg class="w-5 h-5 text-blue-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                </svg>
                            </div>
                            <div class="flex-1">
                                <label for="photoUpload" class="cursor-pointer">
                                    <span class="text-white font-black text-xs">ä¸Šå‚³ç…§ç‰‡</span>
                                    <p class="text-blue-200 font-bold text-xs">æ”¯æ´æ ¼å¼ï¼šJPEG, JPG, PNG, TIFF, WebP, BMP, GIF</p>
                                </label>
                                <input type="file" id="photoUpload" class="hidden" accept=".jpeg,.jpg,.png,.tiff,.tif,.webp,.bmp,.gif,image/*" multiple>
                            </div>
                        </div>
                        
                        <!-- å½±ç‰‡ä¸Šå‚³ -->
                        <div class="file-upload-area flex items-center space-x-2 p-2 bg-white bg-opacity-10 rounded-xl hover:bg-opacity-20 transition-all duration-300">
                            <div class="w-8 h-8 bg-purple-500 bg-opacity-30 rounded-xl flex items-center justify-center">
                                <svg class="w-5 h-5 text-purple-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                </svg>
                            </div>
                            <div class="flex-1">
                                <label for="videoUpload" class="cursor-pointer">
                                    <span class="text-white font-black text-xs">ä¸Šå‚³å½±ç‰‡</span>
                                    <p class="text-blue-200 font-bold text-xs">æ”¯æ´æ ¼å¼ï¼šMP4, MOV, WMV, WebM, AVI, MKV</p>
                                </label>
                                <input type="file" id="videoUpload" class="hidden" accept=".mp4,.mov,.wmv,.webm,.avi,.mkv,.flv,.3gp,video/*" multiple>
                            </div>
                        </div>
                        
                        <!-- æ–‡å­—æª”æ¡ˆä¸Šå‚³ -->
                        <div class="file-upload-area flex items-center space-x-2 p-2 bg-white bg-opacity-10 rounded-xl hover:bg-opacity-20 transition-all duration-300" onclick="document.getElementById('documentUpload').click()">
                            <div class="w-8 h-8 bg-green-500 bg-opacity-30 rounded-xl flex items-center justify-center">
                                <svg class="w-5 h-5 text-green-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                            </div>
                            <div class="flex-1 cursor-pointer">
                                <span class="text-white font-black text-xs">ä¸Šå‚³æ–‡å­—æª”æ¡ˆ</span>
                                <p class="text-blue-200 font-bold text-xs">æ”¯æ´æ ¼å¼ï¼šDOC, DOCX, PDF, TXT, XLS, XLSX, RTF, ODT, ODS</p>
                                <input type="file" id="documentUpload" class="hidden" accept=".doc,.docx,.pdf,.txt,.xls,.xlsx,.rtf,.odt,.ods,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document,application/pdf,text/plain,application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,application/rtf" multiple>
                            </div>
                        </div>
                        
                        <!-- ä»£ç¢¼æª”æ¡ˆä¸Šå‚³ -->
                        <div class="file-upload-area flex items-center space-x-2 p-2 bg-white bg-opacity-10 rounded-xl hover:bg-opacity-20 transition-all duration-300" onclick="document.getElementById('codeUpload').click()">
                            <div class="w-8 h-8 bg-amber-500 bg-opacity-30 rounded-xl flex items-center justify-center">
                                <svg class="w-5 h-5 text-amber-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"></path>
                                </svg>
                            </div>
                            <div class="flex-1 cursor-pointer">
                                <span class="text-white font-black text-xs">ä¸Šå‚³ä»£ç¢¼æª”æ¡ˆ</span>
                                <p class="text-blue-200 font-bold text-xs">æ”¯æ´æ ¼å¼ï¼šHTML, CSS, JS, JSON, C++, Python, SQL, PHP, Java, XML</p>
                                <input type="file" id="codeUpload" class="hidden" accept=".html,.htm,.css,.js,.json,.cpp,.c,.h,.hpp,.py,.pyw,.sql,.php,.java,.xml,.yaml,.yml,text/*" multiple>
                            </div>
                        </div>
                        
                        <!-- éŸ³é »æª”æ¡ˆä¸Šå‚³ -->
                        <div class="file-upload-area flex items-center space-x-2 p-2 bg-white bg-opacity-10 rounded-xl hover:bg-opacity-20 transition-all duration-300" onclick="document.getElementById('audioUpload').click()">
                            <div class="w-8 h-8 bg-pink-500 bg-opacity-30 rounded-xl flex items-center justify-center">
                                <svg class="w-5 h-5 text-pink-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"></path>
                                </svg>
                            </div>
                            <div class="flex-1 cursor-pointer">
                                <span class="text-white font-black text-xs">ä¸Šå‚³éŸ³é »æª”æ¡ˆ</span>
                                <p class="text-blue-200 font-bold text-xs">æ”¯æ´æ ¼å¼ï¼šMP3, WAV, M4A, AAC, OGG, FLAC, WMA</p>
                                <input type="file" id="audioUpload" class="hidden" accept=".mp3,.wav,.m4a,.aac,.ogg,.flac,.wma,audio/*" multiple>
                            </div>
                        </div>
                        
                        <!-- ç°¡å ±æª”æ¡ˆä¸Šå‚³ -->
                        <div class="file-upload-area flex items-center space-x-2 p-2 bg-white bg-opacity-10 rounded-xl hover:bg-opacity-20 transition-all duration-300" onclick="document.getElementById('presentationUpload').click()">
                            <div class="w-8 h-8 bg-orange-500 bg-opacity-30 rounded-xl flex items-center justify-center">
                                <svg class="w-5 h-5 text-orange-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 4V2a1 1 0 011-1h8a1 1 0 011 1v2m0 0V3a1 1 0 011 1v9a1 1 0 01-1 1H8a1 1 0 01-1-1V4h10z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 10h10M7 14h10"></path>
                                </svg>
                            </div>
                            <div class="flex-1 cursor-pointer">
                                <span class="text-white font-black text-xs">ä¸Šå‚³ç°¡å ±æª”æ¡ˆ</span>
                                <p class="text-blue-200 font-bold text-xs">æ”¯æ´æ ¼å¼ï¼šPPT, PPTX, KEY, ODP</p>
                                <input type="file" id="presentationUpload" class="hidden" accept=".ppt,.pptx,.key,.odp,application/vnd.ms-powerpoint,application/vnd.openxmlformats-officedocument.presentationml.presentation,application/vnd.apple.keynote" multiple>
                            </div>
                        </div>
                        
                        <!-- å£“ç¸®æª”æ¡ˆä¸Šå‚³ -->
                        <div class="file-upload-area flex items-center space-x-2 p-2 bg-white bg-opacity-10 rounded-xl hover:bg-opacity-20 transition-all duration-300" onclick="document.getElementById('archiveUpload').click()">
                            <div class="w-8 h-8 bg-indigo-500 bg-opacity-30 rounded-xl flex items-center justify-center">
                                <svg class="w-5 h-5 text-indigo-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                                </svg>
                            </div>
                            <div class="flex-1 cursor-pointer">
                                <span class="text-white font-black text-xs">ä¸Šå‚³å£“ç¸®æª”æ¡ˆ</span>
                                <p class="text-blue-200 font-bold text-xs">æ”¯æ´æ ¼å¼ï¼šZIP, RAR, 7Z, TAR, GZ, BZ2, XZ</p>
                                <input type="file" id="archiveUpload" class="hidden" accept=".zip,.rar,.7z,.tar,.gz,.bz2,.xz,application/zip,application/x-rar-compressed,application/x-7z-compressed" multiple>
                            </div>
                        </div>
                        
                        <!-- å¯åŸ·è¡Œæª”æ¡ˆ/å…¶ä»–æª”æ¡ˆä¸Šå‚³ -->
                        <div class="file-upload-area flex items-center space-x-2 p-2 bg-white bg-opacity-10 rounded-xl hover:bg-opacity-20 transition-all duration-300" onclick="document.getElementById('executableUpload').click()">
                            <div class="w-8 h-8 bg-red-500 bg-opacity-30 rounded-xl flex items-center justify-center">
                                <svg class="w-5 h-5 text-red-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"></path>
                                </svg>
                            </div>
                            <div class="flex-1 cursor-pointer">
                                <span class="text-white font-black text-xs">ä¸Šå‚³åŸ·è¡Œæª”/å…¶ä»–</span>
                                <p class="text-blue-200 font-bold text-xs">æ”¯æ´æ ¼å¼ï¼šEXE, ATT, MSI, DEB, DMG, APK, APP, BIN</p>
                                <input type="file" id="executableUpload" class="hidden" accept=".exe,.att,.msi,.deb,.dmg,.apk,.app,.bin,application/octet-stream,application/x-msdownload" multiple>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- å·²ä¸Šå‚³æ–‡ä»¶é è¦½ -->
                <div id="uploadedFiles" class="hidden max-w-6xl mx-auto mb-2"></div>
                
                <form id="chatForm" class="flex items-end space-x-2 max-w-6xl mx-auto">
                    <!-- æ–‡ä»¶ä¸Šå‚³æŒ‰éˆ• -->
                    <button type="button" id="fileUploadToggle" class="bg-green-600 hover:bg-green-700 text-white p-2 rounded-xl transition-all duration-300 flex-shrink-0 button-hover-lift animate-glow-pulse">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                        </svg>
                    </button>
                    
                    <div class="flex-1">
                        <textarea 
                            id="messageInput" 
                            placeholder="è¼¸å…¥æ‚¨çš„è¨Šæ¯ï¼ˆç„¡å­—æ•¸é™åˆ¶ï¼‰..." 
                            class="w-full p-3 bg-white bg-opacity-10 border-2 border-white border-opacity-20 rounded-xl text-white placeholder-blue-200 resize-none focus:outline-none focus:ring-2 focus:ring-blue-400 font-bold text-base input-focus-glow smooth-transition"
                            rows="1"
                        ></textarea>
                    </div>
                    
                    <button 
                        type="submit" 
                        id="sendBtn"
                        disabled
                        class="bg-blue-600 hover:bg-blue-700 disabled:bg-gray-600 disabled:cursor-not-allowed text-white p-2 rounded-xl transition-all duration-300 animate-glow-pulse shadow-lg border-2 border-blue-400 button-hover-lift"
                        title="ğŸ“¤ ç™¼é€è¨Šæ¯"
                    >
                        <div class="flex items-center justify-center">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                            </svg>
                            <span class="sr-only">ç™¼é€è¨Šæ¯</span>
                        </div>
                    </button>
                </form>
            </div>
        </div>

        <!-- LoadingæŒ‡ç¤ºå™¨å®Œå…¨éš±è— -->
        <div id="loadingIndicator" style="display: none !important;" class="hidden"></div>
    </div>

    <script>
        // å…¨å±€è®Šé‡
        let typewriterQueue = [];
        let isTyping = false;
        
        // é é¢å°èˆªç³»çµ±
        class PageManager {
            constructor() {
                this.currentPage = 'homePage';
                this.setupNavigation();
            }
            
            setupNavigation() {
                // é€²å…¥ChatBotæŒ‰éˆ•
                document.getElementById('enterChatBotBtn').addEventListener('click', () => {
                    this.showLoadingThenChatBot();
                });
                
                // è¿”å›ä¸»é æŒ‰éˆ•
                document.getElementById('backToHomeBtn').addEventListener('click', () => {
                    this.showPage('homePage');
                });
                
                // è¿”å›åˆ°ChatBotæŒ‰éˆ•
                document.getElementById('backToChatBotBtn').addEventListener('click', () => {
                    if (window.chatBotApp) {
                        window.chatBotApp.closeSidebar();
                    }
                });
            }
            
            showLoadingThenChatBot() {
                // å…ˆé¡¯ç¤ºåŠ è¼‰é é¢
                this.showPage('loadingPage');
                
                // é–‹å§‹åŠ è¼‰å‹•ç•«
                this.animateLoading().then(() => {
                    // åŠ è¼‰å®Œæˆå¾Œè·³è½‰åˆ°ChatBoté é¢
                    this.showPage('chatPage');
                    // åˆå§‹åŒ–ChatBotæ‡‰ç”¨
                    if (!window.chatBotApp) {
                        window.chatBotApp = new ChatBotApp();
                    }
                });
            }
            
            async animateLoading() {
                const progressBar = document.getElementById('loadingProgress');
                const percentage = document.getElementById('loadingPercentage');
                const status = document.getElementById('loadingStatus');
                
                const steps = [
                    { progress: 0, text: 'æ­£åœ¨åˆå§‹åŒ–ç³»çµ±...', delay: 200 },
                    { progress: 15, text: 'è¼‰å…¥AI Samæ¨¡å‹...', delay: 400 },
                    { progress: 35, text: 'æº–å‚™æ™ºèƒ½å°è©±ç’°å¢ƒ...', delay: 300 },
                    { progress: 50, text: 'è¼‰å…¥å°è©±è¨˜éŒ„...', delay: 250 },
                    { progress: 70, text: 'é…ç½®ç”¨æˆ¶ç•Œé¢...', delay: 200 },
                    { progress: 85, text: 'å»ºç«‹é€£ç·š...', delay: 300 },
                    { progress: 95, text: 'æœ€å¾Œæº–å‚™...', delay: 250 },
                    { progress: 100, text: 'æº–å‚™å®Œæˆï¼', delay: 300 }
                ];
                
                for (const step of steps) {
                    await new Promise(resolve => {
                        setTimeout(() => {
                            progressBar.style.width = `${step.progress}%`;
                            percentage.textContent = `${step.progress}%`;
                            status.textContent = step.text;
                            resolve();
                        }, step.delay);
                    });
                }
                
                // é¡å¤–å»¶é²è®“ç”¨æˆ¶çœ‹åˆ°100%å®Œæˆ
                await new Promise(resolve => setTimeout(resolve, 500));
            }
            
            showPage(pageId) {
                // éš±è—æ‰€æœ‰é é¢
                document.querySelectorAll('.page').forEach(page => {
                    page.classList.remove('active');
                });
                
                // é¡¯ç¤ºæŒ‡å®šé é¢
                document.getElementById(pageId).classList.add('active');
                this.currentPage = pageId;
                
                // é‡ç½®æ»¾å‹•ä½ç½®
                document.body.scrollTop = 0;
                document.documentElement.scrollTop = 0;
            }
        }

        // å¢å¼·ç‰ˆæ‰“å­—æ©Ÿæ•ˆæœé¡
        class TypewriterEffect {
            constructor() {
                this.queue = [];
                this.isProcessing = false;
            }
            
            async typeText(elementId, text, speed = 20) {
                return new Promise((resolve) => {
                    this.queue.push({
                        elementId,
                        text,
                        speed,
                        resolve
                    });
                    
                    if (!this.isProcessing) {
                        this.processQueue();
                    }
                });
            }
            
            async processQueue() {
                if (this.queue.length === 0) {
                    this.isProcessing = false;
                    return;
                }
                
                this.isProcessing = true;
                const { elementId, text, speed, resolve } = this.queue.shift();
                
                const element = document.getElementById(elementId);
                if (!element) {
                    resolve();
                    this.processQueue();
                    return;
                }
                
                element.innerHTML = '';
                let charIndex = 0;
                
                const typeChar = () => {
                    if (charIndex < text.length) {
                        const char = text.charAt(charIndex);
                        const span = document.createElement('span');
                        span.textContent = char;
                        span.className = 'char-container';
                        span.style.animationDelay = `${charIndex * 0.02}s`;
                        element.appendChild(span);
                        
                        // è§¸ç™¼å‹•ç•«
                        setTimeout(() => {
                            span.style.animation = 'char-pop 0.15s ease-out forwards';
                        }, 10);
                        
                        charIndex++;
                        setTimeout(typeChar, speed);
                    } else {
                        // ç§»é™¤å…‰æ¨™
                        const cursor = element.nextSibling;
                        if (cursor && cursor.classList && cursor.classList.contains('typewriter-cursor')) {
                            cursor.style.display = 'none';
                        }
                        resolve();
                        this.processQueue();
                    }
                };
                
                typeChar();
            }
            
            clear() {
                this.queue = [];
                this.isProcessing = false;
            }
        }

        // ChatBotæ‡‰ç”¨é¡
        class ChatBotApp {
            constructor() {
                this.typewriter = new TypewriterEffect();
                this.storageAvailable = this.checkStorageAvailability();
                this.conversations = this.loadConversationsFromStorage();
                this.currentConversationId = this.loadCurrentConversationId();
                this.uploadedFiles = new Map();
                this.messageCounter = 0;
                this.init();
            }
            
            checkStorageAvailability() {
                const capabilities = {
                    localStorage: false,
                    sessionStorage: false,
                    indexedDB: false,
                    memory: true
                };
                
                // æª¢æ¸¬ localStorage
                try {
                    const testKey = '__storage_test__';
                    localStorage.setItem(testKey, 'test');
                    localStorage.removeItem(testKey);
                    capabilities.localStorage = true;
                } catch (e) {
                    console.warn('localStorage ä¸å¯ç”¨:', e);
                }
                
                // æª¢æ¸¬ sessionStorage  
                try {
                    const testKey = '__session_test__';
                    sessionStorage.setItem(testKey, 'test');
                    sessionStorage.removeItem(testKey);
                    capabilities.sessionStorage = true;
                } catch (e) {
                    console.warn('sessionStorage ä¸å¯ç”¨:', e);
                }
                
                // æª¢æ¸¬ IndexedDB
                try {
                    if ('indexedDB' in window) {
                        capabilities.indexedDB = true;
                    }
                } catch (e) {
                    console.warn('IndexedDB ä¸å¯ç”¨:', e);
                }
                
                return capabilities;
            }
            
            async loadConversationsFromStorage() {
                console.log('ğŸ”„ é–‹å§‹è¼‰å…¥å°è©±è¨˜éŒ„...');
                
                try {
                    // ç”Ÿæˆè¨­å‚™æŒ‡ç´‹
                    this.deviceFingerprint = await this.generateDeviceFingerprint();
                    console.log('ğŸ”’ è¨­å‚™æŒ‡ç´‹:', this.deviceFingerprint);
                    
                    // å¤šé‡å­˜å„²è¼‰å…¥ç­–ç•¥
                    let conversations = [];
                    
                    // ç¬¬ä¸€å„ªå…ˆç´šï¼šlocalStorage
                    if (this.storageAvailable.localStorage) {
                        const localData = localStorage.getItem(`chatbot_conversations_${this.deviceFingerprint}`);
                        if (localData) {
                            try {
                                conversations = JSON.parse(localData);
                                console.log('âœ… å¾ localStorage è¼‰å…¥å°è©±è¨˜éŒ„:', conversations.length, 'å€‹å°è©±');
                            } catch (e) {
                                console.warn('localStorage æ•¸æ“šè§£æå¤±æ•—:', e);
                            }
                        }
                        
                        // å˜—è©¦è¼‰å…¥å…¨å±€å‚™ä»½
                        if (conversations.length === 0) {
                            const globalData = localStorage.getItem('chatbot_conversations');
                            if (globalData) {
                                try {
                                    conversations = JSON.parse(globalData);
                                    console.log('âœ… å¾å…¨å±€ localStorage è¼‰å…¥å°è©±è¨˜éŒ„:', conversations.length, 'å€‹å°è©±');
                                } catch (e) {
                                    console.warn('å…¨å±€ localStorage æ•¸æ“šè§£æå¤±æ•—:', e);
                                }
                            }
                        }
                    }
                    
                    // ç¬¬äºŒå„ªå…ˆç´šï¼šsessionStorage
                    if (conversations.length === 0 && this.storageAvailable.sessionStorage) {
                        const sessionData = sessionStorage.getItem(`chatbot_conversations_${this.deviceFingerprint}`);
                        if (sessionData) {
                            try {
                                conversations = JSON.parse(sessionData);
                                console.log('âœ… å¾ sessionStorage è¼‰å…¥å°è©±è¨˜éŒ„:', conversations.length, 'å€‹å°è©±');
                            } catch (e) {
                                console.warn('sessionStorage æ•¸æ“šè§£æå¤±æ•—:', e);
                            }
                        }
                    }
                    
                    // ç¬¬ä¸‰å„ªå…ˆç´šï¼šIndexedDB
                    if (conversations.length === 0 && this.storageAvailable.indexedDB) {
                        try {
                            conversations = await this.loadFromIndexedDB();
                            console.log('âœ… å¾ IndexedDB è¼‰å…¥å°è©±è¨˜éŒ„:', conversations.length, 'å€‹å°è©±');
                        } catch (e) {
                            console.warn('IndexedDB è¼‰å…¥å¤±æ•—:', e);
                        }
                    }
                    
                    // ç¬¬å››å„ªå…ˆç´šï¼šå…§å­˜å­˜å„²
                    if (conversations.length === 0) {
                        if (!window.__chatbot_memory_storage) {
                            window.__chatbot_memory_storage = {};
                        }
                        conversations = window.__chatbot_memory_storage.conversations || [];
                        console.log('âœ… å¾å…§å­˜è¼‰å…¥å°è©±è¨˜éŒ„:', conversations.length, 'å€‹å°è©±');
                    }
                    
                    // æ•¸æ“šå®Œæ•´æ€§æª¢æŸ¥å’Œä¿®å¾©
                    conversations = this.validateAndRepairConversations(conversations);
                    
                    // å¦‚æœæˆåŠŸè¼‰å…¥æ•¸æ“šï¼Œç«‹å³ä¿å­˜åˆ°å…¶ä»–å­˜å„²ä½ç½®ä½œç‚ºå‚™ä»½
                    if (conversations.length > 0) {
                        this.createBackups(conversations);
                    }
                    
                    console.log('ğŸ‰ å°è©±è¨˜éŒ„è¼‰å…¥å®Œæˆï¼Œç¸½è¨ˆ:', conversations.length, 'å€‹å°è©±');
                    return conversations;
                    
                } catch (error) {
                    console.error('âŒ è¼‰å…¥å°è©±ç´€éŒ„å¤±æ•—:', error);
                    this.showToast('âš ï¸ éƒ¨åˆ†å°è©±è¨˜éŒ„è¼‰å…¥å¤±æ•—ï¼Œä½†ç³»çµ±ä»å¯æ­£å¸¸ä½¿ç”¨', 'warning');
                    return [];
                }
            }
            
            loadCurrentConversationId() {
                try {
                    if (this.storageAvailable === 'localStorage') {
                        return localStorage.getItem('chatbot_current_conversation');
                    } else if (this.storageAvailable === 'sessionStorage') {
                        return sessionStorage.getItem('chatbot_current_conversation');
                    } else {
                        if (!window.__chatbot_memory_storage) {
                            window.__chatbot_memory_storage = {};
                        }
                        return window.__chatbot_memory_storage.currentConversationId || null;
                    }
                } catch (error) {
                    console.error('è¼‰å…¥ç•¶å‰å°è©±IDå¤±æ•—:', error);
                    return null;
                }
            }
            
            async init() {
                console.log('ğŸš€ åˆå§‹åŒ– Design Thinking AI è¶…ç´šå¼·åŒ–å­˜å„²ç³»çµ±...');
                
                this.setupEventListeners();
                this.setupDarkModeDetection();
                
                // ç•°æ­¥è¼‰å…¥å°è©±è¨˜éŒ„
                this.conversations = await this.loadConversationsFromStorage();
                this.loadConversations();
                
                this.registerPoeHandler();
                this.setupAutoSave();
                this.setupDragAndDrop();
                this.setupAdvancedStorageSystem();
                
                // å¦‚æœæ²’æœ‰å°è©±ï¼Œå‰µå»ºç¬¬ä¸€å€‹
                if (this.conversations.length === 0) {
                    this.createNewConversation();
                } else {
                    // è¼‰å…¥æ­¡è¿æ¶ˆæ¯
                    this.addWelcomeMessage();
                    this.showToast('âœ… æˆåŠŸè¼‰å…¥æ‚¨çš„å°è©±è¨˜éŒ„', 'success');
                }
                
                console.log('ğŸ‰ Design Thinking AI åˆå§‹åŒ–å®Œæˆï¼');
            }
            
            // ç”Ÿæˆå…¨å±€å…±äº«çš„æ‡‰ç”¨IDï¼ˆè·¨è¨­å‚™å…±äº«ï¼‰
            async generateDeviceFingerprint() {
                // ä½¿ç”¨å›ºå®šçš„å…¨å±€æ‡‰ç”¨IDï¼Œç¢ºä¿æ‰€æœ‰è¨­å‚™å…±äº«åŒä¸€å€‹æ•¸æ“šæ± 
                const globalAppId = 'AI_SAM_GLOBAL_FEEDBACKS';
                
                // åŒæ™‚ç”Ÿæˆå”¯ä¸€çš„ç”¨æˆ¶æœƒè©±IDï¼Œç”¨æ–¼å€åˆ†ä¸åŒçš„ç”¨æˆ¶/è¨­å‚™
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                ctx.textBaseline = 'top';
                ctx.font = '14px Arial';
                ctx.fillText('AI Sam User Session', 2, 2);
                
                const sessionInfo = {
                    screen: `${screen.width}x${screen.height}`,
                    timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                    language: navigator.language,
                    platform: navigator.platform,
                    canvas: canvas.toDataURL().slice(-20), // åªå–æœ€å¾Œ20å­—ç¬¦
                    timestamp: Date.now(),
                    randomId: Math.random().toString(36).substr(2, 9)
                };
                
                // ç”Ÿæˆç”¨æˆ¶æœƒè©±å“ˆå¸Œ
                const sessionString = JSON.stringify(sessionInfo);
                let hash = 0;
                for (let i = 0; i < sessionString.length; i++) {
                    const char = sessionString.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash;
                }
                
                // è¿”å›å…¨å±€IDï¼ˆç”¨æ–¼å…±äº«æ•¸æ“šï¼‰
                this.globalAppId = globalAppId;
                this.userSessionId = Math.abs(hash).toString(36);
                
                console.log('ğŸŒ ä½¿ç”¨å…¨å±€æ‡‰ç”¨ID:', this.globalAppId);
                console.log('ğŸ‘¤ ç”¨æˆ¶æœƒè©±ID:', this.userSessionId);
                
                return this.userSessionId;
            }
            
            // å¾IndexedDBè¼‰å…¥æ•¸æ“š
            async loadFromIndexedDB() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open('DesignThinkingAI_ChatBot', 1);
                    
                    request.onerror = () => reject(request.error);
                    
                    request.onsuccess = () => {
                        const db = request.result;
                        const transaction = db.transaction(['conversations'], 'readonly');
                        const store = transaction.objectStore('conversations');
                        const getRequest = store.get(`conversations_${this.deviceFingerprint}`);
                        
                        getRequest.onsuccess = () => {
                            resolve(getRequest.result ? getRequest.result.data : []);
                        };
                        
                        getRequest.onerror = () => reject(getRequest.error);
                    };
                    
                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        if (!db.objectStoreNames.contains('conversations')) {
                            db.createObjectStore('conversations', { keyPath: 'id' });
                        }
                    };
                });
            }
            
            // ä¿å­˜åˆ°IndexedDB
            async saveToIndexedDB(conversations) {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open('DesignThinkingAI_ChatBot', 1);
                    
                    request.onerror = () => reject(request.error);
                    
                    request.onsuccess = () => {
                        const db = request.result;
                        const transaction = db.transaction(['conversations'], 'readwrite');
                        const store = transaction.objectStore('conversations');
                        
                        const data = {
                            id: `conversations_${this.deviceFingerprint}`,
                            data: conversations,
                            timestamp: new Date().toISOString(),
                            version: '2.0'
                        };
                        
                        const putRequest = store.put(data);
                        
                        putRequest.onsuccess = () => resolve();
                        putRequest.onerror = () => reject(putRequest.error);
                    };
                    
                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        if (!db.objectStoreNames.contains('conversations')) {
                            db.createObjectStore('conversations', { keyPath: 'id' });
                        }
                    };
                });
            }
            
            // æ•¸æ“šå®Œæ•´æ€§æª¢æŸ¥å’Œä¿®å¾©
            validateAndRepairConversations(conversations) {
                if (!Array.isArray(conversations)) {
                    console.warn('å°è©±æ•¸æ“šæ ¼å¼éŒ¯èª¤ï¼Œé‡æ–°åˆå§‹åŒ–');
                    return [];
                }
                
                const repairedConversations = conversations.map(conv => {
                    // ç¢ºä¿å°è©±å°è±¡æœ‰å¿…è¦çš„å±¬æ€§
                    const repaired = {
                        id: conv.id || Date.now().toString(),
                        name: conv.name || 'æœªå‘½åå°è©±',
                        messages: Array.isArray(conv.messages) ? conv.messages : [],
                        createdAt: conv.createdAt || new Date().toISOString(),
                        lastUpdated: conv.lastUpdated || conv.createdAt || new Date().toISOString()
                    };
                    
                    // é©—è­‰å’Œä¿®å¾©è¨Šæ¯
                    repaired.messages = repaired.messages.map(msg => ({
                        content: msg.content || '',
                        isUser: Boolean(msg.isUser),
                        timestamp: msg.timestamp || new Date().toISOString()
                    }));
                    
                    return repaired;
                }).filter(conv => conv.id); // ç§»é™¤ç„¡æ•ˆçš„å°è©±
                
                console.log(`âœ… æ•¸æ“šå®Œæ•´æ€§æª¢æŸ¥å®Œæˆï¼Œä¿®å¾©äº† ${conversations.length - repairedConversations.length} å€‹æå£çš„å°è©±`);
                return repairedConversations;
            }
            
            // å‰µå»ºå¤šé‡å‚™ä»½
            async createBackups(conversations) {
                const backupPromises = [];
                
                // localStorage å‚™ä»½
                if (this.storageAvailable.localStorage) {
                    try {
                        localStorage.setItem(`chatbot_conversations_${this.deviceFingerprint}`, JSON.stringify(conversations));
                        localStorage.setItem('chatbot_conversations', JSON.stringify(conversations)); // å…¨å±€å‚™ä»½
                        localStorage.setItem('chatbot_backup_timestamp', new Date().toISOString());
                    } catch (e) {
                        console.warn('localStorage å‚™ä»½å¤±æ•—:', e);
                    }
                }
                
                // sessionStorage å‚™ä»½
                if (this.storageAvailable.sessionStorage) {
                    try {
                        sessionStorage.setItem(`chatbot_conversations_${this.deviceFingerprint}`, JSON.stringify(conversations));
                    } catch (e) {
                        console.warn('sessionStorage å‚™ä»½å¤±æ•—:', e);
                    }
                }
                
                // IndexedDB å‚™ä»½
                if (this.storageAvailable.indexedDB) {
                    backupPromises.push(
                        this.saveToIndexedDB(conversations).catch(e => {
                            console.warn('IndexedDB å‚™ä»½å¤±æ•—:', e);
                        })
                    );
                }
                
                // å…§å­˜å‚™ä»½
                if (!window.__chatbot_memory_storage) {
                    window.__chatbot_memory_storage = {};
                }
                window.__chatbot_memory_storage.conversations = conversations;
                window.__chatbot_memory_storage.timestamp = new Date().toISOString();
                
                await Promise.all(backupPromises);
                console.log('ğŸ”„ å¤šé‡å‚™ä»½å‰µå»ºå®Œæˆ');
            }
            
            // è¨­ç½®é«˜ç´šå­˜å„²ç³»çµ±
            setupAdvancedStorageSystem() {
                // æ¯30ç§’è‡ªå‹•å‚™ä»½
                setInterval(() => {
                    if (this.conversations && this.conversations.length > 0) {
                        this.createBackups(this.conversations);
                    }
                }, 30000);
                
                // æ¯5åˆ†é˜é€²è¡Œæ•¸æ“šå®Œæ•´æ€§æª¢æŸ¥
                setInterval(() => {
                    this.performIntegrityCheck();
                }, 300000);
                
                // æª¢æ¸¬ç€è¦½å™¨é—œé–‰/åˆ·æ–°
                window.addEventListener('beforeunload', () => {
                    console.log('ğŸ”„ ç€è¦½å™¨é—œé–‰å‰è‡ªå‹•ä¿å­˜...');
                    this.performEmergencyBackup();
                });
                
                // æª¢æ¸¬é é¢å¯è¦‹æ€§è®ŠåŒ–
                document.addEventListener('visibilitychange', () => {
                    if (document.visibilityState === 'hidden') {
                        console.log('ğŸ”„ é é¢éš±è—æ™‚è‡ªå‹•ä¿å­˜...');
                        this.performEmergencyBackup();
                    }
                });
                
                // æª¢æ¸¬ç¶²è·¯ç‹€æ…‹è®ŠåŒ–
                window.addEventListener('online', () => {
                    console.log('ğŸŒ ç¶²è·¯æ¢å¾©ï¼ŒåŸ·è¡Œæ•¸æ“šåŒæ­¥...');
                    this.performDataSync();
                });
                
                window.addEventListener('offline', () => {
                    console.log('ğŸ“¡ ç¶²è·¯ä¸­æ–·ï¼Œå•Ÿç”¨é›¢ç·šæ¨¡å¼...');
                    this.enableOfflineMode();
                });
            }
            
            // åŸ·è¡Œæ•¸æ“šå®Œæ•´æ€§æª¢æŸ¥
            async performIntegrityCheck() {
                try {
                    const originalCount = this.conversations.length;
                    this.conversations = this.validateAndRepairConversations(this.conversations);
                    
                    if (this.conversations.length !== originalCount) {
                        console.log('âš ï¸ ç™¼ç¾æ•¸æ“šå•é¡Œï¼Œå·²è‡ªå‹•ä¿®å¾©');
                        this.saveConversations();
                    }
                    
                    // æª¢æŸ¥å­˜å„²å®¹é‡
                    if (this.storageAvailable.localStorage) {
                        const usage = this.calculateStorageUsage();
                        if (usage > 0.8) { // è¶…é80%ä½¿ç”¨ç‡
                            console.warn('âš ï¸ å­˜å„²ç©ºé–“ä¸è¶³ï¼Œé–‹å§‹æ¸…ç†èˆŠæ•¸æ“š');
                            this.cleanupOldData();
                        }
                    }
                } catch (error) {
                    console.error('âŒ æ•¸æ“šå®Œæ•´æ€§æª¢æŸ¥å¤±æ•—:', error);
                }
            }
            
            // è¨ˆç®—å­˜å„²ä½¿ç”¨ç‡
            calculateStorageUsage() {
                try {
                    let total = 0;
                    for (let key in localStorage) {
                        if (localStorage.hasOwnProperty(key)) {
                            total += localStorage[key].length;
                        }
                    }
                    // å‡è¨­ localStorage é™åˆ¶ç‚º 5MB
                    return total / (5 * 1024 * 1024);
                } catch (e) {
                    return 0;
                }
            }
            
            // æ¸…ç†èˆŠæ•¸æ“š
            cleanupOldData() {
                try {
                    // åªä¿ç•™æœ€è¿‘30å¤©çš„å°è©±
                    const thirtyDaysAgo = new Date();
                    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                    
                    const originalLength = this.conversations.length;
                    this.conversations = this.conversations.filter(conv => {
                        const convDate = new Date(conv.lastUpdated || conv.createdAt);
                        return convDate > thirtyDaysAgo;
                    });
                    
                    const removedCount = originalLength - this.conversations.length;
                    if (removedCount > 0) {
                        console.log(`ğŸ§¹ æ¸…ç†äº† ${removedCount} å€‹èˆŠå°è©±`);
                        this.saveConversations();
                        this.showToast(`å·²æ¸…ç† ${removedCount} å€‹èˆŠå°è©±ä»¥é‡‹æ”¾ç©ºé–“`, 'info');
                    }
                } catch (error) {
                    console.error('âŒ æ¸…ç†èˆŠæ•¸æ“šå¤±æ•—:', error);
                }
            }
            
            // ç·Šæ€¥å‚™ä»½
            performEmergencyBackup() {
                try {
                    // åŒæ­¥åŸ·è¡Œå¿«é€Ÿå‚™ä»½
                    const data = JSON.stringify(this.conversations);
                    
                    if (this.storageAvailable.localStorage) {
                        localStorage.setItem(`emergency_backup_${this.deviceFingerprint}`, data);
                        localStorage.setItem('emergency_backup_timestamp', new Date().toISOString());
                    }
                    
                    // å…§å­˜å‚™ä»½
                    window.__chatbot_emergency_backup = {
                        conversations: this.conversations,
                        timestamp: new Date().toISOString(),
                        deviceFingerprint: this.deviceFingerprint
                    };
                    
                    console.log('ğŸš¨ ç·Šæ€¥å‚™ä»½å®Œæˆ');
                } catch (error) {
                    console.error('âŒ ç·Šæ€¥å‚™ä»½å¤±æ•—:', error);
                }
            }
            
            // æ•¸æ“šåŒæ­¥
            async performDataSync() {
                try {
                    // æª¢æŸ¥æ˜¯å¦æœ‰ç·Šæ€¥å‚™ä»½éœ€è¦æ¢å¾©
                    const emergencyBackup = localStorage.getItem(`emergency_backup_${this.deviceFingerprint}`);
                    if (emergencyBackup) {
                        const backupData = JSON.parse(emergencyBackup);
                        const backupTimestamp = localStorage.getItem('emergency_backup_timestamp');
                        
                        if (backupData.length > this.conversations.length) {
                            console.log('ğŸ”„ ç™¼ç¾ç·Šæ€¥å‚™ä»½æ•¸æ“šï¼Œæ­£åœ¨æ¢å¾©...');
                            this.conversations = this.validateAndRepairConversations(backupData);
                            this.loadConversations();
                            this.showToast('âœ… å·²æ¢å¾©ç·Šæ€¥å‚™ä»½æ•¸æ“š', 'success');
                        }
                        
                        // æ¸…ç†ç·Šæ€¥å‚™ä»½
                        localStorage.removeItem(`emergency_backup_${this.deviceFingerprint}`);
                        localStorage.removeItem('emergency_backup_timestamp');
                    }
                    
                    // åŸ·è¡Œæ­£å¸¸å‚™ä»½
                    await this.createBackups(this.conversations);
                } catch (error) {
                    console.error('âŒ æ•¸æ“šåŒæ­¥å¤±æ•—:', error);
                }
            }
            
            // å•Ÿç”¨é›¢ç·šæ¨¡å¼
            enableOfflineMode() {
                // å¢åŠ å…§å­˜å‚™ä»½é »ç‡
                if (this.offlineBackupInterval) {
                    clearInterval(this.offlineBackupInterval);
                }
                
                this.offlineBackupInterval = setInterval(() => {
                    window.__chatbot_memory_storage.conversations = this.conversations;
                    window.__chatbot_memory_storage.timestamp = new Date().toISOString();
                }, 10000); // æ¯10ç§’å‚™ä»½åˆ°å…§å­˜
                
                this.showToast('ğŸ“¡ å·²åˆ‡æ›åˆ°é›¢ç·šæ¨¡å¼ï¼Œæ•¸æ“šå°‡ä¿å­˜åœ¨æœ¬åœ°', 'info');
            }
            
            setupEventListeners() {
                // å´é‚Šæ¬„æ§åˆ¶
                document.getElementById('openSidebar').addEventListener('click', () => this.openSidebar());
                document.getElementById('closeSidebar').addEventListener('click', () => this.closeSidebar());
                document.getElementById('sidebarOverlay').addEventListener('click', () => this.closeSidebar());
                
                // é»æ“Šä¸»è¦èŠå¤©å€åŸŸé—œé–‰å´é‚Šæ¬„
                this.setupChatAreaClick();
                
                // èŠå¤©åŠŸèƒ½
                document.getElementById('chatForm').addEventListener('submit', (e) => this.handleSendMessage(e));
                document.getElementById('messageInput').addEventListener('input', (e) => this.handleInputChange(e));
                document.getElementById('messageInput').addEventListener('keydown', (e) => this.handleKeyDown(e));
                
                // å°è©±ç®¡ç†
                document.getElementById('newChatBtn').addEventListener('click', () => this.createNewConversation());
                
                // ç”¨æˆ¶åé¥‹åŠŸèƒ½
                document.getElementById('userFeedbackBtn').addEventListener('click', () => this.showUserFeedbackModal());
                
                // æ–‡ä»¶ä¸Šå‚³åŠŸèƒ½
                document.getElementById('fileUploadToggle').addEventListener('click', () => this.toggleFileUploadOptions());
                document.getElementById('closeFileOptions').addEventListener('click', () => this.hideFileUploadOptions());
                document.getElementById('photoUpload').addEventListener('change', (e) => this.handleFileUpload(e, 'photo'));
                document.getElementById('videoUpload').addEventListener('change', (e) => this.handleFileUpload(e, 'video'));
                document.getElementById('documentUpload').addEventListener('change', (e) => this.handleFileUpload(e, 'document'));
                document.getElementById('codeUpload').addEventListener('change', (e) => this.handleFileUpload(e, 'code'));
                document.getElementById('audioUpload').addEventListener('change', (e) => this.handleFileUpload(e, 'audio'));
                document.getElementById('presentationUpload').addEventListener('change', (e) => this.handleFileUpload(e, 'presentation'));
                document.getElementById('archiveUpload').addEventListener('change', (e) => this.handleFileUpload(e, 'archive'));
                document.getElementById('executableUpload').addEventListener('change', (e) => this.handleFileUpload(e, 'executable'));
                
                // éŸ¿æ‡‰å¼è¨­è¨ˆ
                window.addEventListener('resize', () => this.handleResize());
                
                // éŒ¯èª¤è™•ç†
                window.addEventListener('error', (e) => this.handleGlobalError(e));
                window.addEventListener('unhandledrejection', (e) => this.handlePromiseRejection(e));
            }
            
            setupDarkModeDetection() {
                if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    document.documentElement.classList.add('dark');
                }
                
                window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
                    if (event.matches) {
                        document.documentElement.classList.add('dark');
                    } else {
                        document.documentElement.classList.remove('dark');
                    }
                });
            }
            
            setupDragAndDrop() {
                const fileUploadAreas = document.querySelectorAll('.file-upload-area');
                const chatArea = document.getElementById('chatArea');
                
                // æ·»åŠ åˆ°èŠå¤©å€åŸŸçš„æ‹–æ‹½åŠŸèƒ½
                [chatArea, ...fileUploadAreas].forEach(area => {
                    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                        area.addEventListener(eventName, this.preventDefaults, false);
                    });
                    
                    ['dragenter', 'dragover'].forEach(eventName => {
                        area.addEventListener(eventName, () => {
                            if (area.classList.contains('file-upload-area')) {
                                area.classList.add('drag-over');
                            }
                        }, false);
                    });
                    
                    ['dragleave', 'drop'].forEach(eventName => {
                        area.addEventListener(eventName, () => {
                            if (area.classList.contains('file-upload-area')) {
                                area.classList.remove('drag-over');
                            }
                        }, false);
                    });
                    
                    area.addEventListener('drop', (e) => this.handleDrop(e), false);
                });
            }
            
            preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            handleDrop(e) {
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    this.handleFileSelection(Array.from(files));
                }
            }
            
            createNewConversation() {
                const newConversation = {
                    id: Date.now().toString(),
                    name: `å°è©± ${this.conversations.length + 1}`,
                    messages: [],
                    createdAt: new Date().toISOString(),
                    lastUpdated: new Date().toISOString()
                };
                
                this.conversations.unshift(newConversation);
                this.currentConversationId = newConversation.id;
                this.saveConversations();
                this.loadConversations();
                this.clearChat();
                this.addWelcomeMessage();
                this.closeSidebar();
                this.showToast('âœ… å·²å»ºç«‹æ–°å°è©±', 'success');
            }
            
            loadConversations() {
                const conversationList = document.getElementById('conversationList');
                conversationList.innerHTML = '';
                
                this.conversations.forEach((conv, index) => {
                    const item = document.createElement('div');
                    item.className = `conversation-item ${conv.id === this.currentConversationId ? 'active' : ''}`;
                    
                    const lastUpdate = this.formatDateTime(new Date(conv.lastUpdated || conv.createdAt));
                    
                    item.innerHTML = `
                        <div class="flex items-center justify-between">
                            <div class="flex-1 mr-3">
                                <span class="text-white font-black truncate text-base block">${conv.name}</span>
                                <span class="text-blue-200 font-bold text-sm">${lastUpdate}</span>
                            </div>
                            <div class="flex items-center space-x-2">
                                <button class="edit-conversation text-white hover:text-blue-200 p-2 rounded-xl transition-all duration-200 button-hover-lift" data-id="${conv.id}" title="ç·¨è¼¯åç¨±">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path>
                                    </svg>
                                </button>
                                <button class="delete-conversation text-white hover:text-red-300 p-2 rounded-xl transition-all duration-200 button-hover-lift" data-id="${conv.id}" title="åˆªé™¤å°è©±">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    `;
                    
                    // é»æ“Šå°è©±é …ç›®
                    item.addEventListener('click', (e) => {
                        if (!e.target.closest('.edit-conversation') && !e.target.closest('.delete-conversation')) {
                            this.loadConversation(conv.id);
                        }
                    });
                    
                    conversationList.appendChild(item);
                });
                
                // ç·¨è¼¯å’Œåˆªé™¤äº‹ä»¶
                this.setupConversationActions();
            }
            
            setupConversationActions() {
                document.addEventListener('click', (e) => {
                    if (e.target.closest('.edit-conversation')) {
                        e.preventDefault();
                        e.stopPropagation();
                        const id = e.target.closest('.edit-conversation').dataset.id;
                        this.editConversationName(id);
                    } else if (e.target.closest('.delete-conversation')) {
                        e.preventDefault();
                        e.stopPropagation();
                        const id = e.target.closest('.delete-conversation').dataset.id;
                        this.deleteConversation(id);
                    }
                });
            }
            
            editConversationName(conversationId) {
                const conversation = this.conversations.find(c => c.id === conversationId);
                if (!conversation) return;
                
                this.showCustomPrompt('ç·¨è¼¯å°è©±åç¨±', 'è«‹è¼¸å…¥æ–°çš„å°è©±åç¨±ï¼š', conversation.name, (newName) => {
                    if (newName && newName.trim()) {
                        // ç«‹å³æ›´æ–°å°è©±åç¨±
                        conversation.name = newName.trim();
                        conversation.lastUpdated = new Date().toISOString();
                        
                        console.log('ğŸ”„ é–‹å§‹æ›´æ–°å°è©±åç¨±:', newName.trim());
                        
                        // ç«‹å³ä¿å­˜ä¸¦åˆ·æ–°å°è©±åˆ—è¡¨
                        this.saveConversations();
                        this.loadConversations();
                        
                        console.log('âœ… å°è©±åˆ—è¡¨å·²åˆ·æ–°');
                        
                        // ç«‹å³å¼·åˆ¶æ‰“é–‹å´é‚Šæ¬„ï¼Œä¸ä½¿ç”¨å»¶é²
                        this.forceOpenSidebar();
                        
                        // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
                        this.showToast('âœ… å°è©±åç¨±å·²æ›´æ–°', 'success');
                        
                        console.log('âœ… ç·¨è¼¯å°è©±åç¨±æµç¨‹å®Œæˆ');
                    }
                });
            }
            
            // å¼·åˆ¶æ‰“é–‹å´é‚Šæ¬„çš„æ–¹æ³•
            forceOpenSidebar() {
                console.log('ğŸ”„ å¼·åˆ¶æ‰“é–‹å´é‚Šæ¬„');
                
                const sidebar = document.getElementById('sidebar');
                const overlay = document.getElementById('sidebarOverlay');
                
                if (sidebar) {
                    // ç«‹å³æ·»åŠ opené¡åˆ¥
                    sidebar.classList.add('open');
                    
                    // ç¢ºä¿åœ¨æ‰‹æ©Ÿç‰ˆä¹Ÿèƒ½æ­£ç¢ºé¡¯ç¤º
                    if (window.innerWidth < 768) {
                        if (overlay) {
                            overlay.classList.remove('hidden');
                        }
                        document.body.style.overflow = 'hidden';
                    }
                    
                    // å¼·åˆ¶è§¸ç™¼é‡ç¹ªä»¥ç¢ºä¿æ¨£å¼ç”Ÿæ•ˆ
                    sidebar.offsetHeight; // å¼·åˆ¶é‡ç¹ª
                    
                    console.log('âœ… å´é‚Šæ¬„å·²å¼·åˆ¶æ‰“é–‹');
                } else {
                    console.error('âŒ æ‰¾ä¸åˆ°å´é‚Šæ¬„å…ƒç´ ');
                }
            }
            
            showCustomPrompt(title, message, defaultValue = '', onConfirm = () => {}) {
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 animate-fade-in';
                modal.innerHTML = `
                    <div class="bg-white dark:bg-gray-800 rounded-3xl shadow-2xl max-w-lg w-full mx-4 p-10 animate-scale-bounce border-2 border-gray-200 dark:border-gray-600">
                        <h3 class="text-xl font-black text-gray-900 dark:text-white mb-6">${title}</h3>
                        <p class="text-gray-700 dark:text-gray-300 font-bold mb-6 text-base">${message}</p>
                        <input type="text" id="customPromptInput" value="${defaultValue}" 
                               class="w-full p-5 border-2 border-gray-300 dark:border-gray-600 rounded-2xl 
                                      bg-white dark:bg-gray-700 text-gray-900 dark:text-white 
                                      font-bold text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500 
                                      outline-none smooth-transition" placeholder="è¼¸å…¥å°è©±åç¨±...">
                        <div class="flex justify-end space-x-4 mt-8">
                            <button class="cancel-btn px-6 py-3 text-gray-600 dark:text-gray-400 
                                           hover:bg-gray-100 dark:hover:bg-gray-700 rounded-2xl font-bold transition-all duration-200 button-hover-lift text-base">
                                å–æ¶ˆ
                            </button>
                            <button class="confirm-btn px-6 py-3 bg-blue-500 text-white 
                                           hover:bg-blue-600 rounded-2xl font-bold transition-all duration-200 button-hover-lift text-base">
                                ç¢ºèª
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                const input = modal.querySelector('#customPromptInput');
                const cancelBtn = modal.querySelector('.cancel-btn');
                const confirmBtn = modal.querySelector('.confirm-btn');
                
                setTimeout(() => {
                    input.focus();
                    input.select();
                }, 100);
                
                const closeModal = () => {
                    modal.style.opacity = '0';
                    modal.style.transform = 'scale(0.95)';
                    setTimeout(() => modal.remove(), 200);
                };
                
                const confirmAction = () => {
                    const value = input.value.trim();
                    closeModal();
                    onConfirm(value);
                };
                
                cancelBtn.addEventListener('click', closeModal);
                confirmBtn.addEventListener('click', confirmAction);
                
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        closeModal();
                    }
                });
                
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        confirmAction();
                    } else if (e.key === 'Escape') {
                        e.preventDefault();
                        closeModal();
                    }
                });
            }
            
            deleteConversation(conversationId) {
                const conversation = this.conversations.find(c => c.id === conversationId);
                if (!conversation) return;
                
                if (this.conversations.length <= 1) {
                    this.showToast('âŒ è‡³å°‘éœ€è¦ä¿ç•™ä¸€å€‹å°è©±', 'error');
                    return;
                }
                
                this.showCustomConfirm('åˆªé™¤å°è©±', 'ç¢ºå®šè¦åˆªé™¤æ­¤å°è©±å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•æ’¤éŠ·ã€‚', () => {
                    this.conversations = this.conversations.filter(c => c.id !== conversationId);
                    
                    if (this.currentConversationId === conversationId) {
                        this.currentConversationId = this.conversations[0]?.id || null;
                        if (this.currentConversationId) {
                            this.loadConversation(this.currentConversationId);
                        }
                    }
                    
                    this.saveConversations();
                    this.loadConversations();
                    this.showToast('âœ… å°è©±å·²åˆªé™¤', 'info');
                });
            }
            
            showCustomConfirm(title, message, onConfirm = () => {}) {
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 animate-fade-in';
                modal.innerHTML = `
                    <div class="bg-white dark:bg-gray-800 rounded-3xl shadow-2xl max-w-lg w-full mx-4 p-10 animate-scale-bounce border-2 border-gray-200 dark:border-gray-600">
                        <h3 class="text-xl font-black text-gray-900 dark:text-white mb-6">${title}</h3>
                        <p class="text-gray-700 dark:text-gray-300 font-bold mb-8 text-base">${message}</p>
                        <div class="flex justify-end space-x-4">
                            <button class="cancel-btn px-6 py-3 text-gray-600 dark:text-gray-400 
                                           hover:bg-gray-100 dark:hover:bg-gray-700 rounded-2xl font-bold transition-all duration-200 button-hover-lift text-base">
                                å–æ¶ˆ
                            </button>
                            <button class="confirm-btn px-6 py-3 bg-red-500 text-white 
                                           hover:bg-red-600 rounded-2xl font-bold transition-all duration-200 button-hover-lift text-base">
                                åˆªé™¤
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                const cancelBtn = modal.querySelector('.cancel-btn');
                const confirmBtn = modal.querySelector('.confirm-btn');
                
                const closeModal = () => {
                    modal.style.opacity = '0';
                    modal.style.transform = 'scale(0.95)';
                    setTimeout(() => modal.remove(), 200);
                };
                
                const confirmAction = () => {
                    closeModal();
                    onConfirm();
                };
                
                cancelBtn.addEventListener('click', closeModal);
                confirmBtn.addEventListener('click', confirmAction);
                
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        closeModal();
                    }
                });
                
                document.addEventListener('keydown', function escapeHandler(e) {
                    if (e.key === 'Escape') {
                        closeModal();
                        document.removeEventListener('keydown', escapeHandler);
                    }
                });
            }
            
            loadConversation(conversationId) {
                const conversation = this.conversations.find(c => c.id === conversationId);
                if (!conversation) return;
                
                this.currentConversationId = conversationId;
                this.saveCurrentConversationId(conversationId);
                
                this.clearChat();
                this.addWelcomeMessage();
                
                // è¼‰å…¥å°è©±ç´€éŒ„
                if (conversation.messages && conversation.messages.length > 0) {
                    setTimeout(() => {
                        conversation.messages.forEach((message, index) => {
                            setTimeout(() => {
                                this.addMessageToChat(message.content, message.isUser, false);
                            }, index * 300);
                        });
                    }, 1000); // ç­‰å¾…æ­¡è¿æ¶ˆæ¯å®Œæˆ
                }
                
                this.loadConversations();
                this.closeSidebar();
            }
            
            clearChat() {
                const messagesContainer = document.getElementById('messagesContainer');
                messagesContainer.innerHTML = '';
                this.typewriter.clear(); // æ¸…é™¤æ‰“å­—æ©ŸéšŠåˆ—
            }
            
            async addWelcomeMessage() {
                const messagesContainer = document.getElementById('messagesContainer');
                const welcomeText = `ğŸ‘‹æ‚¨å¥½ï¼Œæˆ‘å«ğŸ¤–AI Samï¼Œä¿‚ä½ AIçš„å°è©±åŠ©æ‰‹ğŸ‘
è«‹èªªå‡ºä½ çš„éœ€è¦å’Œç–‘å•ï¼Œæˆ‘å¥½æ¨‚æ„å¹«åŠ©æ‚¨ğŸ˜„ï¼Œå¹³å°æœƒæä¾›æœ€é©åˆçš„å»ºè­°å’Œç­”æ¡ˆï¼Œä¸¦æä¾›æœ€å¥½çš„è§£æ±ºæ–¹æ¡ˆï¼Œè«‹å•æœ‰ä»€éº¼å¯ä»¥å¹«åŠ©åˆ°æ‚¨ï¼Ÿ`;
                
                // ç¢ºä¿ç«‹å³é¡¯ç¤ºæ­¡è¿æ¶ˆæ¯ï¼Œçµ•ä¸ç©ºç™½
                try {
                    const messageDiv = document.createElement('div');
                    messageDiv.className = 'flex justify-start animate-slide-up mb-4';
                    
                    const bubbleDiv = document.createElement('div');
                    bubbleDiv.className = 'chat-bubble bot';
                    bubbleDiv.style.backgroundColor = '#ffffff';
                    bubbleDiv.style.color = '#1e293b';
                    bubbleDiv.style.border = '2px solid #3b82f6';
                    bubbleDiv.style.padding = '10px 14px';
                    bubbleDiv.style.maxWidth = 'fit-content';
                    
                    const contentDiv = document.createElement('div');
                    contentDiv.className = 'font-bold text-base leading-relaxed break-words overflow-wrap-anywhere';
                    contentDiv.style.color = '#1e293b';
                    contentDiv.style.lineHeight = '1.5';
                    
                    // æ ¼å¼åŒ–æ­¡è¿æ–‡å­—ä¸¦ç«‹å³é¡¯ç¤º
                    const formattedText = welcomeText
                        .replace(/\*\*(.*?)\*\*/g, '<strong style="color: #1e40af;">$1</strong>')
                        .replace(/â€¢/g, '<span style="color: #3b82f6;">â€¢</span>')
                        .replace(/\n\n/g, '<br><br>')
                        .replace(/\n/g, '<br>');
                    
                    contentDiv.innerHTML = formattedText;
                    bubbleDiv.appendChild(contentDiv);
                    messageDiv.appendChild(bubbleDiv);
                    messagesContainer.appendChild(messageDiv);
                    
                    // ç¢ºä¿å…§å®¹å¯è¦‹
                    console.log('æ­¡è¿è¨Šæ¯å·²æ·»åŠ åˆ°èŠå¤©å®¹å™¨');
                    
                    // æ»¾å‹•åˆ°åº•éƒ¨
                    setTimeout(() => {
                        const chatArea = document.getElementById('chatArea');
                        if (chatArea) {
                            chatArea.scrollTop = chatArea.scrollHeight;
                        }
                    }, 100);
                    
                } catch (error) {
                    console.error('æ·»åŠ æ­¡è¿è¨Šæ¯å¤±æ•—:', error);
                    // å‚™ç”¨æ–¹æ¡ˆï¼šç›´æ¥åœ¨å®¹å™¨ä¸­æ·»åŠ æ–‡å­—
                    messagesContainer.innerHTML = `
                        <div class="flex justify-start mb-4">
                            <div class="chat-bubble bot" style="background-color: #ffffff; color: #1e293b; border: 2px solid #3b82f6; padding: 10px 14px; max-width: fit-content;">
                                <div class="font-bold text-base leading-relaxed" style="color: #1e293b;">
                                    ${welcomeText.replace(/\n/g, '<br>')}
                                </div>
                            </div>
                        </div>
                    `;
                }
            }
            
            handleSendMessage(e) {
                e.preventDefault();
                const messageInput = document.getElementById('messageInput');
                const message = messageInput.value.trim();
                
                const hasFiles = this.uploadedFiles && this.uploadedFiles.size > 0;
                
                if (!message && !hasFiles) {
                    this.showToast('è«‹è¼¸å…¥è¨Šæ¯æˆ–ä¸Šå‚³æª”æ¡ˆ', 'warning');
                    return;
                }
                
                let sendMessage = message;
                let attachments = [];
                
                if (hasFiles) {
                    const fileDescriptions = [];
                    this.uploadedFiles.forEach((file, fileId) => {
                        fileDescriptions.push(`${file.name} (${this.formatFileSize(file.size)})`);
                        attachments.push(file);
                    });
                    
                    if (!message) {
                        sendMessage = 'æˆ‘ä¸Šå‚³äº†ä¸€äº›æª”æ¡ˆï¼Œè«‹å”åŠ©åˆ†æï¼š';
                    }
                    
                    sendMessage += `\n\nğŸ“ é™„ä»¶æª”æ¡ˆï¼š\n${fileDescriptions.join('\n')}`;
                }
                
                this.addMessageToChat(sendMessage, true);
                this.saveMessage(sendMessage, true);
                
                messageInput.value = '';
                this.clearUploadedFiles();
                this.updateSendButton();
                
                this.sendToAI(sendMessage, attachments);
            }
            
            clearUploadedFiles() {
                const uploadedFiles = document.getElementById('uploadedFiles');
                uploadedFiles.innerHTML = '';
                uploadedFiles.classList.add('hidden');
                
                this.uploadedFiles.clear();
            }
            
            async sendToAI(message, attachments = []) {
                try {
                    console.log(`ğŸ“¤ æº–å‚™ç™¼é€æ¶ˆæ¯åˆ°AI: "${message.substring(0, 50)}..."`);
                    console.log(`ğŸ“ é™„ä»¶æ•¸é‡: ${attachments.length}`);
                    
                    // çµ±ä¸€ä½¿ç”¨ GPT-5-mini è™•ç†æ‰€æœ‰è¨Šæ¯ï¼Œä¸¦å„ªåŒ–æŒ‡ä»¤è®“å›è¦†æ›´å¿«é€Ÿæœ‰æ¢ç†
                    let aiInstruction = message;
                    if (!message.startsWith('@')) {
                        // å¼·åŒ–AIæŒ‡ä»¤ï¼šè¦æ±‚å¿«é€Ÿã€æœ‰æ¢ç†ã€ç›´æ¥çš„å›è¦†
                        aiInstruction = `@GPT-5-mini ã€AI Samå°ˆæ¥­å›æ‡‰æ¨¡å¼ã€‘ç”¨ç¹é«”ä¸­æ–‡æŒ‰ç…§ä»¥ä¸‹ç¯„æœ¬æ ¼å¼å›ç­”ï¼š

**ç–‘å•/éœ€æ±‚ï¼š**
[é‡è¿°å’Œç¢ºèªç”¨æˆ¶çš„å…·é«”å•é¡Œæˆ–éœ€æ±‚]

**ç¯„ç–‡é¡åˆ¥ï¼š**
[æŒ‡å‡ºå•é¡Œæ‰€å±¬çš„é ˜åŸŸ/é¡åˆ¥ï¼Œå¦‚ï¼šè¨­è¨ˆæ€ç¶­ã€å•†æ¥­ç­–ç•¥ã€æ•™è‚²å­¸ç¿’ã€æŠ€è¡“å•é¡Œã€æ—¥å¸¸ç”Ÿæ´»ç­‰]

**è¦é»ï¼š**
[åˆ—å‡ºé—œéµè¦é»å’Œæ ¸å¿ƒæ¦‚å¿µ]

**å®šç¾©ï¼š**
[æä¾›ç›¸é—œé‡è¦æ¦‚å¿µçš„æ¸…æ™°å®šç¾©]

**æ­¥é©Ÿ/åˆ—è¡¨/æ®µè½ï¼š**
[æ ¹æ“šå•é¡Œæ€§è³ªé¸æ“‡æœ€é©åˆçš„çµ„ç¹”æ–¹å¼ï¼š
- å¦‚æœæ˜¯æµç¨‹å•é¡Œï¼šæä¾›æ¸…æ™°æ­¥é©Ÿ
- å¦‚æœæ˜¯çŸ¥è­˜å•é¡Œï¼šç”¨åˆ—è¡¨é‡é»
- å¦‚æœæ˜¯è¤‡é›œæ¦‚å¿µï¼šç”¨æ®µè½è©³è¿°]

**(å¦‚éœ€ï¼‰ä¾‹å­ï¼š**
[å¦‚éœ€è¦ï¼Œæä¾›å…·é«”å¯¦ç”¨çš„ä¾‹å­ä¾†èªªæ˜]

**âš¡æ•´åˆå¯¦ç”¨å»ºè­°(ç¶œåˆå»ºè­°å’Œæœ€ä½³åšæ³•)ï¼š**
[æä¾›ç¶œåˆæ€§çš„å»ºè­°å’Œæœ€ä½³åšæ³•]

**â“ å»¶ä¼¸æ€è€ƒï¼š**
[ç›¸é—œçš„å»¶ä¼¸æ€è€ƒå’Œé€²ä¸€æ­¥æ¢è¨çš„æ–¹å‘]

**ğŸ’¡è£œå……èªªæ˜ï¼š**
[é¡å¤–çš„é‡è¦è³‡è¨Šã€æ³¨æ„äº‹é …æˆ–å»¶ä¼¸æ€è€ƒ]

ã€é‡è¦æé†’ã€‘è¦–ä¹å•é¡Œè€Œå®šï¼Œéˆæ´»é‹ç”¨ç¯„æœ¬ï¼Œç›´æ¥å›ç­”ä¸åå•ï¼Œæä¾›å®Œæ•´å¯¦ç”¨çš„è§£æ±ºæ–¹æ¡ˆã€‚

ã€ç”¨æˆ¶å•é¡Œã€‘${message}`;
                        console.log('ğŸ¤– ä½¿ç”¨å„ªåŒ–ç‰ˆ GPT-5-mini å¿«é€Ÿå›è¦†æ¨¡å¼');
                    }
                    
                    const options = {
                        handler: 'ai-chat-handler',
                        stream: true,
                        openChat: false,
                        handlerContext: { 
                            userMessage: message,
                            directCall: true,
                            hasAttachments: attachments.length > 0,
                            attachmentCount: attachments.length
                        }
                    };
                    
                    // æ·»åŠ æ–‡ä»¶é™„ä»¶ - ç¢ºä¿æ ¼å¼æ­£ç¢º
                    if (attachments.length > 0) {
                        // é©—è­‰é™„ä»¶æ ¼å¼
                        const validAttachments = attachments.filter(file => {
                            if (!(file instanceof File)) {
                                console.warn('ç„¡æ•ˆçš„é™„ä»¶æ ¼å¼:', file);
                                return false;
                            }
                            return true;
                        });
                        
                        if (validAttachments.length > 0) {
                            options.attachments = validAttachments;
                            console.log(`âœ… æˆåŠŸæº–å‚™ ${validAttachments.length} å€‹æœ‰æ•ˆé™„ä»¶`);
                            
                            // è©³ç´°æ—¥èªŒæ¯å€‹é™„ä»¶
                            validAttachments.forEach((file, index) => {
                                console.log(`ğŸ“„ é™„ä»¶ ${index + 1}: ${file.name} (${this.formatFileSize(file.size)}) - ${file.type || 'unknown type'}`);
                            });
                        } else {
                            console.warn('âš ï¸ æ²’æœ‰æœ‰æ•ˆçš„é™„ä»¶å¯ç™¼é€');
                        }
                    }
                    
                    // ç™¼é€åˆ°Poe API
                    console.log('ğŸš€ æ­£åœ¨ç™¼é€åˆ° Poe API...');
                    const result = await window.Poe?.sendUserMessage(aiInstruction, options);
                    
                    if (result && result.success) {
                        console.log('âœ… æ¶ˆæ¯æˆåŠŸç™¼é€åˆ°AI');
                    } else {
                        console.warn('âš ï¸ ç™¼é€çµæœæœªç¢ºèª:', result);
                    }
                    
                } catch (error) {
                    console.error('âŒ ç™¼é€æ¶ˆæ¯éŒ¯èª¤:', error);
                    
                    let errorMsg = 'å¾ˆæŠ±æ­‰ï¼Œç™¼é€è¨Šæ¯æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚';
                    
                    // æ ¹æ“šéŒ¯èª¤é¡å‹æä¾›å…·é«”çš„éŒ¯èª¤ä¿¡æ¯
                    if (error.errorType === 'USER_REJECTED_CONFIRMATION') {
                        errorMsg = 'æ‚¨å–æ¶ˆäº†æ“ä½œï¼Œå¦‚éœ€è¦è«‹é‡æ–°å˜—è©¦ã€‚';
                    } else if (error.errorType === 'INVALID_INPUT') {
                        errorMsg = 'è¼¸å…¥æ ¼å¼ä¸æ­£ç¢ºï¼Œè«‹æª¢æŸ¥æ‚¨çš„è¨Šæ¯å’Œé™„ä»¶æ ¼å¼ã€‚';
                    } else if (error.errorType === 'ANOTHER_CONFIRMATION_IS_OPEN') {
                        errorMsg = 'å·²æœ‰å…¶ä»–ç¢ºèªå°è©±æ¡†é–‹å•Ÿï¼Œè«‹å…ˆè™•ç†å®Œæˆã€‚';
                    } else if (error.message && error.message.includes('attachment')) {
                        errorMsg = 'é™„ä»¶ä¸Šå‚³å‡ºç¾å•é¡Œï¼Œè«‹æª¢æŸ¥æª”æ¡ˆæ ¼å¼å’Œå¤§å°ã€‚';
                    }
                    
                    // é¡¯ç¤ºéŒ¯èª¤æ¶ˆæ¯
                    this.createAndShowAIMessage(`âŒ ${errorMsg}`);
                    
                    // é¡¯ç¤ºè©³ç´°éŒ¯èª¤ä¿¡æ¯çš„toast
                    this.showToast(`ç™¼é€å¤±æ•—: ${error.message || 'æœªçŸ¥éŒ¯èª¤'}`, 'error');
                }
            }

            
            registerPoeHandler() {
                console.log('è¨»å†Šæ¥µé€ŸAIè™•ç†å™¨...');
                
                window.Poe?.registerHandler('ai-chat-handler', (result, context) => {
                    console.log('å³æ™‚æ”¶åˆ°AIå›æ‡‰:', result);
                    
                    // æª¢æŸ¥æ˜¯å¦å·²è¢«ç”¨æˆ¶åœæ­¢
                    if (context.isStopped) {
                        console.log('ğŸ›‘ AIå›æ‡‰å·²è¢«ç”¨æˆ¶åœæ­¢ï¼Œå¿½ç•¥å¾ŒçºŒå…§å®¹');
                        return;
                    }
                    
                    if (!result || !result.responses || result.responses.length === 0) {
                        this.createAndShowAIMessage('âŒ æœªæ”¶åˆ°AIå›æ‡‰ï¼Œè«‹é‡è©¦ã€‚');
                        return;
                    }
                    
                    const message = result.responses[0];
                    console.log('AIæ¶ˆæ¯ç‹€æ…‹:', message.status, 'å…§å®¹é•·åº¦:', message.content?.length || 0);
                    
                    if (message.status === 'error') {
                        this.createAndShowAIMessage(`âŒ AIå›è¦†å‡ºç¾éŒ¯èª¤ï¼š${message.statusText || 'æœªçŸ¥éŒ¯èª¤'}ï¼Œè«‹é‡æ–°å˜—è©¦ã€‚`);
                        return;
                    }
                    
                    // å†æ¬¡æª¢æŸ¥æ˜¯å¦å·²åœæ­¢ï¼ˆé›™é‡ä¿è­·ï¼‰
                    if (context.isStopped) {
                        console.log('ğŸ›‘ AIå›æ‡‰è™•ç†æœŸé–“è¢«åœæ­¢');
                        return;
                    }
                    
                    // å³æ™‚è™•ç†AIå›æ‡‰ï¼Œä¸ç­‰å¾…ç‹€æ…‹
                    if (message.content && message.content.trim()) {
                        if (!context.aiResponseElement) {
                            // ç«‹å³å‰µå»ºAIå›æ‡‰å…ƒç´ 
                            context.aiResponseElement = this.createAndShowAIMessage(message.content);
                            context.isFirstUpdate = true;
                            
                            // ç‚ºåœæ­¢æŒ‰éˆ•æ·»åŠ contextå¼•ç”¨ï¼Œä»¥ä¾¿åœæ­¢æ™‚ä½¿ç”¨
                            const stopButton = context.aiResponseElement.querySelector('.stop-ai-button');
                            if (stopButton) {
                                stopButton.addEventListener('click', () => {
                                    context.isStopped = true; // æ¨™è¨˜ç‚ºå·²åœæ­¢
                                    this.stopAIResponse(context.aiResponseElement, context);
                                });
                            }
                        } else {
                            // æª¢æŸ¥æ˜¯å¦åœ¨æ›´æ–°éç¨‹ä¸­è¢«åœæ­¢
                            if (!context.isStopped) {
                                // æ›´æ–°ç¾æœ‰å…§å®¹
                                const cleanContent = this.cleanAndFormatAIResponse(message.content);
                                this.updateAIMessageContent(context.aiResponseElement, cleanContent);
                            }
                        }
                        
                        // å¦‚æœæ˜¯å®Œæˆç‹€æ…‹ä¸”æœªè¢«åœæ­¢ï¼Œéš±è—åœæ­¢æŒ‰éˆ•ä¸¦ä¿å­˜æ¶ˆæ¯
                        if (message.status === 'complete' && !context.isStopped) {
                            this.hideStopButton(context.aiResponseElement);
                            this.saveMessage(message.content, false);
                            console.log('AIå›æ‡‰å®Œæˆä¸¦å·²ä¿å­˜');
                        }
                    }
                });
            }
            
            async addMessageToChat(content, isUser, isStreaming = false) {
                const messagesContainer = document.getElementById('messagesContainer');
                const messageDiv = document.createElement('div');
                messageDiv.className = `flex ${isUser ? 'justify-end' : 'justify-start'} animate-slide-up mb-4`;
                
                const bubbleDiv = document.createElement('div');
                bubbleDiv.className = `chat-bubble ${isUser ? 'user' : 'bot'}`;
                
                // å»æ‰é»˜èªpaddingï¼Œä½¿ç”¨CSSæ§åˆ¶
                bubbleDiv.style.padding = isUser ? '10px 14px' : '10px 14px';
                
                if (isStreaming) {
                    bubbleDiv.classList.add('streaming');
                }
                
                const messageId = `msg_${Date.now()}_${this.messageCounter++}`;
                
                if (isUser) {
                    // ç‚ºç”¨æˆ¶æ¶ˆæ¯å‰µå»ºåŒ…å«æ“ä½œæŒ‰éˆ•çš„å®¹å™¨
                    const userMessageContainer = document.createElement('div');
                    userMessageContainer.className = 'flex items-center space-x-2 group';
                    
                    // ç”¨æˆ¶æ¶ˆæ¯æ°£æ³¡
                    const userBubble = document.createElement('div');
                    userBubble.className = 'chat-bubble user';
                    userBubble.style.padding = '10px 14px';
                    userBubble.innerHTML = `<div class="font-bold text-base leading-relaxed break-words overflow-wrap-anywhere">${this.formatMessage(content)}</div>`;
                    
                    // æ“ä½œæŒ‰éˆ•å®¹å™¨
                    const actionsContainer = document.createElement('div');
                    actionsContainer.className = 'flex flex-col space-y-1 opacity-0 group-hover:opacity-100 transition-opacity duration-300';
                    
                    // é‡æ–°ç™¼é€æŒ‰éˆ•
                    const resendButton = document.createElement('button');
                    resendButton.className = 'bg-blue-500 hover:bg-blue-600 text-white p-2 rounded-xl transition-all duration-200 button-hover-lift animate-glow-pulse';
                    resendButton.title = 'é‡æ–°ç™¼é€æ­¤è¨Šæ¯';
                    resendButton.innerHTML = `
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                        </svg>
                    `;
                    resendButton.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        this.resendMessage(content);
                    });
                    
                    // åˆªé™¤æŒ‰éˆ•
                    const deleteButton = document.createElement('button');
                    deleteButton.className = 'bg-red-500 hover:bg-red-600 text-white p-2 rounded-xl transition-all duration-200 button-hover-lift';
                    deleteButton.title = 'åˆªé™¤æ­¤è¨Šæ¯';
                    deleteButton.innerHTML = `
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                        </svg>
                    `;
                    deleteButton.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        this.deleteMessage(messageDiv, content);
                    });
                    
                    actionsContainer.appendChild(resendButton);
                    actionsContainer.appendChild(deleteButton);
                    
                    userMessageContainer.appendChild(userBubble);
                    userMessageContainer.appendChild(actionsContainer);
                    
                    // å°‡å®¹å™¨è€Œä¸æ˜¯æ°£æ³¡æ·»åŠ åˆ°messageDiv
                    messageDiv.appendChild(userMessageContainer);
                    
                    // å­˜å„²æ¶ˆæ¯å…§å®¹ä»¥ä¾¿å¾ŒçºŒæ“ä½œ
                    messageDiv.dataset.messageContent = content;
                    messageDiv.dataset.messageType = 'user';
                } else {
                    // AIæ¶ˆæ¯ä½¿ç”¨æ‰“å­—æ©Ÿæ•ˆæœå’Œé‚Šç•Œæ§åˆ¶
                    bubbleDiv.innerHTML = `<div id="${messageId}" class="font-bold text-base leading-relaxed break-words overflow-wrap-anywhere"></div><span class="typewriter-cursor">|</span>`;
                    
                    if (!isStreaming && content) {
                        setTimeout(async () => {
                            // ç¢ºä¿å…§å®¹åœ¨é‚Šç•Œå…§é¡¯ç¤º
                            await this.typewriter.typeText(messageId, content, 15);
                        }, 300);
                    }
                    
                    messageDiv.appendChild(bubbleDiv);
                    
                    // å­˜å„²AIæ¶ˆæ¯å…§å®¹
                    messageDiv.dataset.messageContent = content;
                    messageDiv.dataset.messageType = 'bot';
                }
                
                messagesContainer.appendChild(messageDiv);
                
                // ç¢ºä¿æ»¾å‹•åˆ°åº•éƒ¨ä¸¦æª¢æŸ¥é‚Šç•Œ
                setTimeout(() => {
                    this.ensureMessageVisibility();
                    const chatArea = document.getElementById('chatArea');
                    chatArea.scrollTop = chatArea.scrollHeight;
                }, 100);
                
                return isUser ? messageDiv.querySelector('.chat-bubble.user') : bubbleDiv;
            }
            
            async updateMessageWithTypewriter(bubble, content, messageId) {
                // é˜²è­·æ€§æª¢æŸ¥ï¼šç¢ºä¿ bubble æ˜¯æœ‰æ•ˆçš„ DOM å…ƒç´ 
                if (!bubble || typeof bubble.querySelector !== 'function') {
                    console.error('updateMessageWithTypewriter: bubble ä¸æ˜¯æœ‰æ•ˆçš„ DOM å…ƒç´ ', bubble);
                    return;
                }
                
                const messageElement = bubble.querySelector(`#${messageId}`);
                if (messageElement) {
                    // æ¸…é™¤ä¹‹å‰çš„å…§å®¹
                    messageElement.innerHTML = '';
                    // æ ¼å¼åŒ–ä¸¦ä½¿ç”¨æ‰“å­—æ©Ÿæ•ˆæœ
                    const formattedContent = this.formatMessage(content);
                    await this.typewriter.typeText(messageId, this.stripHtml(formattedContent), 10);
                    // ç„¶å¾Œæ‡‰ç”¨HTMLæ ¼å¼
                    setTimeout(() => {
                        if (messageElement && messageElement.parentNode) {
                            messageElement.innerHTML = formattedContent;
                        }
                    }, 100);
                } else {
                    console.error('updateMessageWithTypewriter: æ‰¾ä¸åˆ°æ¶ˆæ¯å…ƒç´ ', messageId);
                }
            }
            
            stripHtml(html) {
                const tmp = document.createElement('div');
                tmp.innerHTML = html;
                return tmp.textContent || tmp.innerText || '';
            }
            
            formatMessage(text) {
                // æ¸…ç†æ–‡å­—å’Œå„ªåŒ–æ ¼å¼
                let formattedText = text
                    // ç§»é™¤ä¸å¿…è¦çš„ç¬¦è™Ÿå’Œç¢ºä¿é©ç•¶æ›è¡Œ
                    .replace(/\r\n/g, '\n')
                    .replace(/\r/g, '\n')
                    // åŸºæœ¬Markdownæ ¼å¼
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\*(.*?)\*/g, '<em>$1</em>')
                    .replace(/`(.*?)`/g, '<code class="bg-blue-100 dark:bg-blue-900 px-2 py-1 rounded text-sm font-mono">$1</code>')
                    // è™•ç†æ›è¡Œå’Œæ®µè½ - ç¢ºä¿é©ç•¶çš„æ®µè½é–“è·
                    .replace(/\n\n+/g, '</p><p class="mb-4">')
                    .replace(/\n/g, '<br>')
                    // ç¢ºä¿æ¨™é»ç¬¦è™Ÿå¾Œæœ‰é©ç•¶é–“è·
                    .replace(/([ã€‚ï¼ï¼Ÿ])\s*/g, '$1 ')
                    .replace(/([ï¼Œã€ï¼šï¼›])\s*/g, '$1 ')
                    // ç§»é™¤å¤šé¤˜ç©ºæ ¼
                    .replace(/\s+/g, ' ')
                    .trim();
                
                // å¦‚æœæœ‰æ®µè½åˆ†éš”ï¼ŒåŒ…è£æ®µè½
                if (formattedText.includes('</p><p class="mb-4">')) {
                    formattedText = '<p class="mb-4">' + formattedText + '</p>';
                }
                
                return formattedText;
            }
            
            saveMessage(content, isUser) {
                const conversation = this.conversations.find(c => c.id === this.currentConversationId);
                if (conversation) {
                    conversation.messages.push({
                        content,
                        isUser,
                        timestamp: new Date().toISOString()
                    });
                    conversation.lastUpdated = new Date().toISOString();
                    this.saveConversations();
                }
            }
            
            async saveConversations() {
                try {
                    console.log('ğŸ’¾ é–‹å§‹ä¿å­˜å°è©±è¨˜éŒ„...');
                    
                    // ç«‹å³åŸ·è¡Œå¤šé‡å‚™ä»½ä»¥ç¢ºä¿æ•¸æ“šå®‰å…¨
                    await this.createBackups(this.conversations);
                    
                    // é¡å¤–çš„å®‰å…¨æªæ–½ï¼šä¿å­˜åˆ°å°ˆç”¨è¨­å‚™å­˜å„²
                    if (this.deviceFingerprint) {
                        const deviceSpecificKey = `conversations_device_${this.deviceFingerprint}`;
                        const backupData = {
                            conversations: this.conversations,
                            deviceFingerprint: this.deviceFingerprint,
                            timestamp: new Date().toISOString(),
                            version: '2.1',
                            totalMessages: this.conversations.reduce((total, conv) => total + conv.messages.length, 0)
                        };
                        
                        if (this.storageAvailable.localStorage) {
                            localStorage.setItem(deviceSpecificKey, JSON.stringify(backupData));
                            localStorage.setItem('chatbot_last_save_timestamp', new Date().toISOString());
                        }
                    }
                    
                    console.log('âœ… å°è©±è¨˜éŒ„ä¿å­˜å®Œæˆ');
                    
                } catch (error) {
                    console.error('âŒ ä¿å­˜å°è©±å¤±æ•—:', error);
                    
                    // ç·Šæ€¥ä¿å­˜æ©Ÿåˆ¶
                    try {
                        const emergencyData = JSON.stringify(this.conversations);
                        localStorage.setItem('emergency_conversations_backup', emergencyData);
                        localStorage.setItem('emergency_backup_created', new Date().toISOString());
                        console.log('ğŸš¨ ç·Šæ€¥å‚™ä»½å·²å‰µå»º');
                    } catch (emergencyError) {
                        console.error('âŒ ç·Šæ€¥å‚™ä»½ä¹Ÿå¤±æ•—:', emergencyError);
                        this.showToast('âš ï¸ å­˜å„²å‡ºç¾å•é¡Œï¼Œè«‹æª¢æŸ¥ç€è¦½å™¨è¨­ç½®', 'warning');
                    }
                }
            }
            
            saveCurrentConversationId(id) {
                try {
                    if (this.storageAvailable === 'localStorage') {
                        localStorage.setItem('chatbot_current_conversation', id);
                    } else if (this.storageAvailable === 'sessionStorage') {
                        sessionStorage.setItem('chatbot_current_conversation', id);
                    } else {
                        if (!window.__chatbot_memory_storage) {
                            window.__chatbot_memory_storage = {};
                        }
                        window.__chatbot_memory_storage.currentConversationId = id;
                    }
                } catch (error) {
                    console.error('ä¿å­˜ç•¶å‰å°è©±IDå¤±æ•—:', error);
                }
            }
            
            handleInputChange(e) {
                this.updateSendButton();
                this.autoResize(e.target);
            }
            
            handleKeyDown(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    document.getElementById('chatForm').dispatchEvent(new Event('submit'));
                }
            }
            
            updateSendButton() {
                const messageInput = document.getElementById('messageInput');
                const sendBtn = document.getElementById('sendBtn');
                const hasText = messageInput.value.trim().length > 0;
                const hasFiles = this.uploadedFiles && this.uploadedFiles.size > 0;
                
                sendBtn.disabled = !hasText && !hasFiles;
                
                if (!sendBtn.disabled) {
                    sendBtn.classList.add('animate-glow-pulse');
                } else {
                    sendBtn.classList.remove('animate-glow-pulse');
                }
            }
            
            autoResize(textarea) {
                textarea.style.height = 'auto';
                textarea.style.height = Math.min(textarea.scrollHeight, 180) + 'px';
            }
            
            openSidebar() {
                const sidebar = document.getElementById('sidebar');
                const overlay = document.getElementById('sidebarOverlay');
                
                sidebar.classList.add('open');
                if (window.innerWidth < 768) {
                    overlay.classList.remove('hidden');
                    document.body.style.overflow = 'hidden';
                }
            }
            
            closeSidebar() {
                const sidebar = document.getElementById('sidebar');
                const overlay = document.getElementById('sidebarOverlay');
                
                sidebar.classList.remove('open');
                overlay.classList.add('hidden');
                document.body.style.overflow = '';
            }
            
            showLoading() {
                document.getElementById('loadingIndicator').classList.remove('hidden');
            }
            
            hideLoading() {
                document.getElementById('loadingIndicator').classList.add('hidden');
            }
            
            showToast(message, type = 'info') {
                const existingToasts = document.querySelectorAll('.toast-notification');
                existingToasts.forEach(toast => {
                    toast.style.transform = 'translateX(100%)';
                    toast.style.opacity = '0';
                    setTimeout(() => {
                        if (toast.parentNode) {
                            toast.parentNode.removeChild(toast);
                        }
                    }, 200);
                });
                
                const toast = document.createElement('div');
                const colors = {
                    success: 'bg-green-500',
                    error: 'bg-red-500',
                    info: 'bg-blue-500',
                    warning: 'bg-yellow-500'
                };
                
                toast.className = `toast-notification fixed top-28 right-8 ${colors[type]} text-white px-8 py-4 rounded-2xl text-base font-bold z-50 animate-slide-left shadow-2xl border-2 border-white border-opacity-20`;
                toast.textContent = message;
                document.body.appendChild(toast);
                
                setTimeout(() => {
                    toast.style.transform = 'translateX(100%)';
                    toast.style.opacity = '0';
                    setTimeout(() => {
                        if (toast.parentNode) {
                            toast.parentNode.removeChild(toast);
                        }
                    }, 300);
                }, 4000);
            }
            
            toggleFileUploadOptions() {
                const options = document.getElementById('fileUploadOptions');
                const toggleBtn = document.getElementById('fileUploadToggle');
                
                if (options.classList.contains('hidden')) {
                    options.classList.remove('hidden');
                    options.style.animation = 'slideDown 0.3s ease-out';
                    toggleBtn.style.backgroundColor = '#dc2626';
                    toggleBtn.querySelector('svg').style.transform = 'rotate(45deg)';
                } else {
                    this.hideFileUploadOptions();
                }
            }
            
            hideFileUploadOptions() {
                const options = document.getElementById('fileUploadOptions');
                const toggleBtn = document.getElementById('fileUploadToggle');
                
                options.style.animation = 'slideUp 0.3s ease-out';
                setTimeout(() => {
                    options.classList.add('hidden');
                }, 300);
                
                toggleBtn.style.backgroundColor = '#059669';
                toggleBtn.querySelector('svg').style.transform = 'rotate(0deg)';
            }
            
            handleFileUpload(event, type) {
                const files = Array.from(event.target.files);
                this.handleFileSelection(files, type);
                event.target.value = '';
            }
            
            handleFileSelection(files, type = 'auto') {
                if (files.length === 0) return;
                
                let validFiles = 0;
                files.forEach(file => {
                    let fileType = type;
                    if (type === 'auto') {
                        // æ™ºèƒ½æª”æ¡ˆé¡å‹æª¢æ¸¬
                        if (file.type.startsWith('image/')) {
                            fileType = 'photo';
                        } else if (file.type.startsWith('video/')) {
                            fileType = 'video';
                        } else if (file.type.includes('document') || file.type.includes('pdf') || file.type.includes('text') ||
                                   ['doc', 'docx', 'pdf', 'txt'].some(ext => file.name.toLowerCase().endsWith(ext))) {
                            fileType = 'document';
                        } else if (this.isCodeFile(file.name)) {
                            fileType = 'code';
                        } else if (this.isAudioFile(file.name)) {
                            fileType = 'audio';
                        } else if (this.isPresentationFile(file.name)) {
                            fileType = 'presentation';
                        } else if (this.isArchiveFile(file.name)) {
                            fileType = 'archive';
                        } else if (this.isExecutableFile(file.name)) {
                            fileType = 'executable';
                        } else {
                            // æ ¹æ“šæª”æ¡ˆå‰¯æª”åé€²è¡Œå‚™ç”¨æª¢æ¸¬
                            const fileName = file.name.toLowerCase();
                            if (['jpg', 'jpeg', 'png', 'tiff', 'webp'].some(ext => fileName.endsWith(ext))) {
                                fileType = 'photo';
                            } else if (['mp4', 'mov', 'wmv', 'webm'].some(ext => fileName.endsWith(ext))) {
                                fileType = 'video';
                            } else if (['doc', 'docx', 'pdf', 'txt', 'xls', 'xlsx'].some(ext => fileName.endsWith(ext))) {
                                fileType = 'document';
                            } else if (['mp3', 'wav', 'm4a', 'aac'].some(ext => fileName.endsWith(ext))) {
                                fileType = 'audio';
                            } else if (['ppt', 'pptx', 'key'].some(ext => fileName.endsWith(ext))) {
                                fileType = 'presentation';
                            } else if (['zip', 'rar', '7z', 'tar', 'gz'].some(ext => fileName.endsWith(ext))) {
                                fileType = 'archive';
                            } else if (['exe', 'att', 'msi', 'deb', 'dmg', 'apk'].some(ext => fileName.endsWith(ext))) {
                                fileType = 'executable';
                            } else {
                                fileType = 'executable'; // é»˜èªç‚ºå…¶ä»–åŸ·è¡Œæª”æ¡ˆé¡å‹
                            }
                        }
                    }
                    
                    if (!this.validateFileFormat(file, fileType)) {
                        this.showToast(`âŒ ä¸æ”¯æ´çš„æª”æ¡ˆæ ¼å¼ï¼š${file.name}`, 'error');
                        return;
                    }
                    
                    this.addFileToPreview(file, fileType);
                    validFiles++;
                });
                
                if (validFiles > 0) {
                    this.hideFileUploadOptions();
                    this.showToast(`âœ… å·²æ·»åŠ  ${validFiles} å€‹æª”æ¡ˆ`, 'success');
                    this.updateSendButton();
                }
            }
            
            isCodeFile(filename) {
                const codeExtensions = ['html', 'htm', 'css', 'js', 'json', 'cpp', 'c', 'h', 'hpp', 'py', 'pyw', 'sql'];
                const ext = filename.toLowerCase().split('.').pop();
                return codeExtensions.includes(ext);
            }
            
            isAudioFile(filename) {
                const audioExtensions = ['mp3', 'wav', 'm4a', 'aac'];
                const ext = filename.toLowerCase().split('.').pop();
                return audioExtensions.includes(ext);
            }
            
            isPresentationFile(filename) {
                const presentationExtensions = ['ppt', 'pptx', 'key'];
                const ext = filename.toLowerCase().split('.').pop();
                return presentationExtensions.includes(ext);
            }
            
            isArchiveFile(filename) {
                const archiveExtensions = ['zip', 'rar', '7z', 'tar', 'gz'];
                const ext = filename.toLowerCase().split('.').pop();
                return archiveExtensions.includes(ext);
            }
            
            isExecutableFile(filename) {
                const executableExtensions = ['exe', 'att', 'msi', 'deb', 'dmg', 'apk'];
                const ext = filename.toLowerCase().split('.').pop();
                return executableExtensions.includes(ext);
            }
            

            
            validateFileFormat(file, type) {
                // ç²å–æª”æ¡ˆå‰¯æª”å
                const fileName = file.name.toLowerCase();
                const fileExtension = fileName.split('.').pop();
                const mimeType = file.type.toLowerCase();
                
                console.log(`ğŸ” æª”æ¡ˆé©—è­‰é–‹å§‹ - æª”å: ${file.name}, é¡å‹: ${type}, å‰¯æª”å: ${fileExtension}, MIME: ${mimeType}`);
                
                // å®Œæ•´çš„æª”æ¡ˆæ ¼å¼æ”¯æ´å®šç¾© - ç¢ºä¿æ‰€æœ‰å®£ç¨±æ”¯æ´çš„æ ¼å¼éƒ½åŒ…å«
                const supportedFormats = {
                    photo: {
                        extensions: ['jpg', 'jpeg', 'png', 'tiff', 'tif', 'webp', 'bmp', 'gif', 'svg', 'ico', 'heic', 'heif', 'raw', 'cr2', 'nef', 'arw'],
                        mimeTypes: [
                            'image/jpeg', 'image/jpg', 'image/png', 'image/tiff', 'image/webp', 'image/bmp', 'image/gif',
                            'image/svg+xml', 'image/x-icon', 'image/vnd.microsoft.icon', 'image/heic', 'image/heif',
                            'image/x-canon-cr2', 'image/x-nikon-nef', 'image/x-sony-arw', 'image/x-adobe-dng'
                        ]
                    },
                    video: {
                        extensions: ['mp4', 'mov', 'wmv', 'webm', 'avi', 'mkv', 'flv', '3gp', 'ogv', 'm4v', 'f4v', 'asf', 'rm', 'rmvb', 'vob', 'ts', 'mts', 'divx', 'xvid'],
                        mimeTypes: [
                            'video/mp4', 'video/quicktime', 'video/x-ms-wmv', 'video/webm', 'video/avi', 'video/x-msvideo',
                            'video/x-flv', 'video/3gpp', 'video/ogg', 'video/x-m4v', 'video/x-f4v', 'video/x-ms-asf',
                            'video/vnd.rn-realvideo', 'video/x-ms-vob', 'video/mp2t', 'video/divx', 'video/x-msvideo'
                        ]
                    },
                    document: {
                        extensions: [
                            'doc', 'docx', 'pdf', 'txt', 'xls', 'xlsx', 'rtf', 'odt', 'ods', 'odp', 'pages', 'numbers', 'keynote',
                            'csv', 'tsv', 'xlsm', 'xlsb', 'xltx', 'xltm', 'docm', 'dotx', 'dotm', 'pptx', 'pptm', 'potx', 'potm',
                            'ppsx', 'ppsm', 'sldx', 'sldm', 'thmx', 'epub', 'mobi', 'azw', 'azw3', 'fb2', 'lit', 'pdb', 'tcr'
                        ],
                        mimeTypes: [
                            'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
                            'application/pdf', 'text/plain', 'application/vnd.ms-excel', 'text/csv', 'text/tab-separated-values',
                            'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', 'application/rtf',
                            'application/vnd.oasis.opendocument.text', 'application/vnd.oasis.opendocument.spreadsheet',
                            'application/vnd.oasis.opendocument.presentation', 'application/vnd.apple.pages',
                            'application/vnd.apple.numbers', 'application/vnd.apple.keynote', 'application/epub+zip',
                            'application/x-mobipocket-ebook', 'application/vnd.amazon.ebook', 'application/x-fictionbook+xml'
                        ]
                    },
                    code: {
                        extensions: [
                            'html', 'htm', 'css', 'js', 'json', 'cpp', 'c', 'h', 'hpp', 'py', 'pyw', 'sql', 'php', 'java', 'xml',
                            'yaml', 'yml', 'ts', 'tsx', 'jsx', 'vue', 'go', 'rs', 'rb', 'pl', 'sh', 'bat', 'ps1', 'r', 'scala',
                            'm', 'swift', 'kt', 'cs', 'vb', 'f', 'fs', 'fsx', 'ml', 'mli', 'hs', 'lhs', 'elm', 'clj', 'cljs',
                            'edn', 'lisp', 'scm', 'rkt', 'jl', 'nim', 'cr', 'd', 'dart', 'hx', 'lua', 'tcl', 'awk', 'sed',
                            'vim', 'cfg', 'conf', 'ini', 'properties', 'toml', 'lock', 'gitignore', 'dockerfile', 'makefile',
                            'cmake', 'gradle', 'ant', 'maven', 'pom', 'sbt', 'cabal', 'stack', 'cargo', 'package', 'composer'
                        ],
                        mimeTypes: [
                            'text/html', 'text/css', 'application/javascript', 'text/javascript', 'application/json',
                            'text/x-c', 'text/x-c++', 'text/x-python', 'text/x-sql', 'application/x-php', 'text/x-java',
                            'text/xml', 'application/xml', 'text/yaml', 'application/x-yaml', 'text/x-typescript',
                            'text/x-go', 'text/x-rust', 'text/x-ruby', 'text/x-perl', 'text/x-shellscript',
                            'text/x-bat', 'text/x-powershell', 'text/x-r', 'text/x-scala', 'text/x-objective-c',
                            'text/x-swift', 'text/x-kotlin', 'text/x-csharp', 'text/x-vb', 'text/x-fsharp',
                            'text/x-ocaml', 'text/x-haskell', 'text/x-elm', 'text/x-clojure', 'text/x-scheme'
                        ]
                    },
                    audio: {
                        extensions: [
                            'mp3', 'wav', 'm4a', 'aac', 'ogg', 'flac', 'wma', 'aiff', 'au', 'ra', 'amr', 'ac3', 'dts',
                            'ape', 'opus', 'webm', 'caf', 'aifc', 'snd', 'mp2', 'mpa', 'mpc', 'tta', 'wv', 'tak'
                        ],
                        mimeTypes: [
                            'audio/mpeg', 'audio/wav', 'audio/x-wav', 'audio/wave', 'audio/x-m4a', 'audio/aac',
                            'audio/ogg', 'audio/flac', 'audio/x-flac', 'audio/x-ms-wma', 'audio/aiff', 'audio/x-aiff',
                            'audio/basic', 'audio/vnd.rn-realaudio', 'audio/amr', 'audio/ac3', 'audio/vnd.dts',
                            'audio/x-ape', 'audio/opus', 'audio/webm', 'audio/x-caf', 'audio/mp2', 'audio/x-musepack'
                        ]
                    },
                    presentation: {
                        extensions: [
                            'ppt', 'pptx', 'key', 'odp', 'pptm', 'potx', 'potm', 'ppsx', 'ppsm', 'sldx', 'sldm',
                            'thmx', 'keynote', 'show', 'shw', 'sdp', 'sti', 'uop', 'otp'
                        ],
                        mimeTypes: [
                            'application/vnd.ms-powerpoint', 'application/vnd.openxmlformats-officedocument.presentationml.presentation',
                            'application/vnd.apple.keynote', 'application/vnd.oasis.opendocument.presentation',
                            'application/vnd.openxmlformats-officedocument.presentationml.template',
                            'application/vnd.ms-powerpoint.slideshow.macroEnabled.12',
                            'application/vnd.openxmlformats-officedocument.presentationml.slideshow',
                            'application/vnd.oasis.opendocument.presentation-template'
                        ]
                    },
                    archive: {
                        extensions: [
                            'zip', 'rar', '7z', 'tar', 'gz', 'bz2', 'xz', 'lzma', 'lz', 'z', 'cab', 'arj', 'lzh', 'ace',
                            'iso', 'dmg', 'img', 'bin', 'cue', 'mdf', 'nrg', 'cdi', 'b6t', 'bwt', 'ccd', 'cif', 'p01',
                            'pdi', 'uif', 'vc4', 'vc6', 'vcd', 'vdi', 'vmdk', 'xar', 'sitx', 'sea', 'hqx', 'stuffit'
                        ],
                        mimeTypes: [
                            'application/zip', 'application/x-rar-compressed', 'application/x-rar', 'application/x-7z-compressed',
                            'application/x-tar', 'application/gzip', 'application/x-gzip', 'application/x-bzip2',
                            'application/x-xz', 'application/x-lzma', 'application/x-compress', 'application/vnd.ms-cab-compressed',
                            'application/x-arj', 'application/x-lzh-compressed', 'application/x-ace-compressed',
                            'application/x-iso9660-image', 'application/x-apple-diskimage', 'application/octet-stream'
                        ]
                    },
                    executable: {
                        extensions: [
                            'exe', 'att', 'msi', 'deb', 'dmg', 'apk', 'app', 'bin', 'run', 'com', 'scr', 'bat', 'cmd',
                            'ps1', 'vbs', 'jar', 'war', 'ear', 'ipa', 'pkg', 'rpm', 'snap', 'flatpak', 'appimage',
                            'elf', 'so', 'dll', 'dylib', 'bundle', 'framework', 'ocx', 'sys', 'drv', 'cpl', 'fon',
                            'ttf', 'otf', 'woff', 'woff2', 'eot', 'pfb', 'pfm', 'afm'
                        ],
                        mimeTypes: [
                            'application/octet-stream', 'application/x-msdownload', 'application/x-msdos-program',
                            'application/x-executable', 'application/x-debian-package', 'application/x-apple-diskimage',
                            'application/vnd.android.package-archive', 'application/x-apple-installer-package',
                            'application/x-rpm', 'application/java-archive', 'application/x-java-archive',
                            'application/x-sharedlib', 'application/x-mach-binary', 'application/x-ms-dos-executable',
                            'application/vnd.microsoft.portable-executable', 'font/ttf', 'font/otf', 'font/woff',
                            'font/woff2', 'application/vnd.ms-fontobject', 'font/type1'
                        ]
                    }
                };
                
                // æª¢æŸ¥æŒ‡å®šé¡å‹çš„æ”¯æ´æ ¼å¼
                if (supportedFormats[type]) {
                    const formats = supportedFormats[type];
                    
                    // æª¢æŸ¥å‰¯æª”å
                    const extensionMatch = formats.extensions.includes(fileExtension);
                    
                    // æª¢æŸ¥MIMEé¡å‹ - æ”¹é€²åŒ¹é…é‚è¼¯
                    const mimeMatch = formats.mimeTypes.some(mime => {
                        if (mimeType === mime) return true;
                        if (mimeType.includes(mime)) return true;
                        if (mime.includes(mimeType.split('/')[1])) return true;
                        
                        // ç‰¹æ®Šè™•ç†ï¼šéƒ¨åˆ†åŒ¹é…
                        const userMimeType = mimeType.split('/')[1];
                        const supportedMimeType = mime.split('/')[1];
                        if (userMimeType && supportedMimeType) {
                            if (userMimeType.includes(supportedMimeType) || supportedMimeType.includes(userMimeType)) {
                                return true;
                            }
                        }
                        return false;
                    });
                    
                    // ç‰¹æ®Šè™•ç†é‚è¼¯
                    const isTextType = (type === 'code' || type === 'document') && 
                        (mimeType.startsWith('text/') || mimeType.includes('text') || !mimeType);
                    
                    const isExecutableWithGenericMime = type === 'executable' && 
                        (mimeType === 'application/octet-stream' || mimeType === '' || !mimeType || 
                         mimeType.includes('binary') || mimeType.includes('executable'));
                    
                    const isArchiveWithGenericMime = type === 'archive' && 
                        (mimeType === 'application/octet-stream' || mimeType.includes('compress') || 
                         mimeType.includes('archive') || mimeType.includes('zip'));
                    
                    // å¯¬é¬†çš„åœ–ç‰‡æª¢æ¸¬
                    const isImageType = type === 'photo' && 
                        (mimeType.startsWith('image/') || extensionMatch);
                    
                    // å¯¬é¬†çš„å½±ç‰‡æª¢æ¸¬
                    const isVideoType = type === 'video' && 
                        (mimeType.startsWith('video/') || extensionMatch);
                    
                    // å¯¬é¬†çš„éŸ³é »æª¢æ¸¬
                    const isAudioType = type === 'audio' && 
                        (mimeType.startsWith('audio/') || extensionMatch);
                    
                    const isValid = extensionMatch || mimeMatch || isTextType || isExecutableWithGenericMime || 
                                   isArchiveWithGenericMime || isImageType || isVideoType || isAudioType;
                    
                    console.log(`âœ… æª”æ¡ˆé©—è­‰çµæœ - ${file.name}: ${isValid ? 'æœ‰æ•ˆ' : 'ç„¡æ•ˆ'}`);
                    console.log(`   å‰¯æª”ååŒ¹é…: ${extensionMatch}, MIMEåŒ¹é…: ${mimeMatch}, ç‰¹æ®Šè¦å‰‡: ${isTextType || isExecutableWithGenericMime || isArchiveWithGenericMime || isImageType || isVideoType || isAudioType}`);
                    
                    return isValid;
                }
                
                // å¦‚æœæ²’æœ‰æ‰¾åˆ°å°æ‡‰çš„é¡å‹ï¼Œä½¿ç”¨å¯¬é¬†é©—è­‰
                console.warn(`âš ï¸ æœªçŸ¥æª”æ¡ˆé¡å‹: ${type}, ä½¿ç”¨å¯¬é¬†é©—è­‰ - æª”æ¡ˆ: ${file.name}`);
                
                // å¯¬é¬†é©—è­‰ï¼šåªè¦æœ‰æª”æ¡ˆåç¨±å°±æ¥å—
                const hasValidExtension = fileExtension && fileExtension.length > 0;
                console.log(`ğŸ”„ å¯¬é¬†é©—è­‰çµæœ - ${file.name}: ${hasValidExtension ? 'æ¥å—' : 'æ‹’çµ•'}`);
                
                return hasValidExtension;
            }
            
            addFileToPreview(file, type) {
                const uploadedFiles = document.getElementById('uploadedFiles');
                uploadedFiles.classList.remove('hidden');
                
                const fileId = `file_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                const fileDiv = document.createElement('div');
                fileDiv.className = 'p-6 bg-white bg-opacity-10 rounded-2xl border border-white border-opacity-20 mb-5 animate-scale-bounce';
                fileDiv.dataset.fileId = fileId;
                
                this.uploadedFiles.set(fileId, file);
                
                let iconColor, iconPath, fileTypeLabel, fileTypeIcon;
                
                if (type === 'photo') {
                    iconColor = 'blue';
                    iconPath = 'M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z';
                    fileTypeLabel = 'ç…§ç‰‡';
                    fileTypeIcon = 'ğŸ“·';
                } else if (type === 'video') {
                    iconColor = 'purple';
                    iconPath = 'M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z';
                    fileTypeLabel = 'å½±ç‰‡';
                    fileTypeIcon = 'ğŸ¥';
                } else if (type === 'document') {
                    iconColor = 'green';
                    iconPath = 'M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z';
                    fileTypeLabel = 'æ–‡å­—æª”æ¡ˆ';
                    fileTypeIcon = 'ğŸ“„';
                } else if (type === 'code') {
                    iconColor = 'amber';
                    iconPath = 'M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4';
                    fileTypeLabel = 'ä»£ç¢¼æª”æ¡ˆ';
                    fileTypeIcon = 'ğŸ’»';
                } else if (type === 'audio') {
                    iconColor = 'pink';
                    iconPath = 'M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3';
                    fileTypeLabel = 'éŸ³é »æª”æ¡ˆ';
                    fileTypeIcon = 'ğŸµ';
                } else if (type === 'presentation') {
                    iconColor = 'orange';
                    iconPath = 'M7 4V2a1 1 0 011-1h8a1 1 0 011 1v2m0 0V3a1 1 0 011 1v9a1 1 0 01-1 1H8a1 1 0 01-1-1V4h10z M7 10h10M7 14h10';
                    fileTypeLabel = 'ç°¡å ±æª”æ¡ˆ';
                    fileTypeIcon = 'ğŸ“Š';
                } else if (type === 'archive') {
                    iconColor = 'indigo';
                    iconPath = 'M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4';
                    fileTypeLabel = 'å£“ç¸®æª”æ¡ˆ';
                    fileTypeIcon = 'ğŸ“¦';
                } else if (type === 'executable') {
                    iconColor = 'red';
                    iconPath = 'M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z';
                    fileTypeLabel = 'åŸ·è¡Œæª”æ¡ˆ';
                    fileTypeIcon = 'âš™ï¸';
                } else {
                    iconColor = 'gray';
                    iconPath = 'M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z';
                    fileTypeLabel = 'æª”æ¡ˆ';
                    fileTypeIcon = 'ğŸ“„';
                }
                
                fileDiv.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-5">
                            <div class="w-16 h-16 bg-${iconColor}-500 bg-opacity-30 rounded-2xl flex items-center justify-center">
                                <svg class="w-9 h-9 text-${iconColor}-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${iconPath}"></path>
                                </svg>
                            </div>
                            <div class="flex-1">
                                <p class="text-white font-black text-base truncate" title="${file.name}">${file.name}</p>
                                <p class="text-blue-200 font-bold text-sm">
                                    ${fileTypeIcon} ${fileTypeLabel} â€¢ ${this.formatFileSize(file.size)}
                                </p>
                            </div>
                        </div>
                        <button onclick="chatBotApp.removeFile('${fileId}')" class="text-red-300 hover:text-red-200 p-3 rounded-2xl transition-all duration-200 button-hover-lift" title="ç§»é™¤æª”æ¡ˆ">
                            <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                        </button>
                    </div>
                `;
                
                uploadedFiles.appendChild(fileDiv);
            }
            
            removeFile(fileId) {
                const fileElement = document.querySelector(`[data-file-id="${fileId}"]`);
                if (fileElement) {
                    fileElement.style.animation = 'slideUp 0.3s ease-out';
                    setTimeout(() => {
                        fileElement.remove();
                        
                        this.uploadedFiles.delete(fileId);
                        
                        const uploadedFiles = document.getElementById('uploadedFiles');
                        if (uploadedFiles.children.length === 0) {
                            uploadedFiles.classList.add('hidden');
                        }
                        
                        this.updateSendButton();
                    }, 300);
                    
                    this.showToast('âœ… æª”æ¡ˆå·²ç§»é™¤', 'info');
                }
            }
            
            formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }
            
            handleResize() {
                if (window.innerWidth >= 768) {
                    document.getElementById('sidebarOverlay').classList.add('hidden');
                    document.body.style.overflow = '';
                }
            }
            
            setupAutoSave() {
                // æ›´é »ç¹çš„è‡ªå‹•ä¿å­˜
                setInterval(() => {
                    this.saveConversations();
                    if (this.currentConversationId) {
                        this.saveCurrentConversationId(this.currentConversationId);
                    }
                }, 10000); // æ¯10ç§’ä¿å­˜ä¸€æ¬¡
                
                // é é¢é—œé–‰æ™‚ä¿å­˜
                window.addEventListener('beforeunload', () => {
                    this.saveConversations();
                });
                
                // é é¢éš±è—æ™‚ä¿å­˜
                document.addEventListener('visibilitychange', () => {
                    if (document.hidden) {
                        this.saveConversations();
                    }
                });
            }
            
            formatDateTime(date) {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                
                return `${year}.${month}.${day} ${hours}:${minutes}`;
            }
            
            handleGlobalError(e) {
                console.error('æ‡‰ç”¨ç¨‹å¼éŒ¯èª¤:', e.error);
                this.showToast('âŒ ç™¼ç”Ÿæœªé æœŸçš„éŒ¯èª¤', 'error');
            }
            
            handlePromiseRejection(e) {
                console.error('æœªè™•ç†çš„PromiseéŒ¯èª¤:', e.reason);
                e.preventDefault();
            }
            
            // å‰µå»ºAIæ°£æ³¡ - æ–°çš„ç©©å®šæ–¹æ³•
            createAIBubble() {
                const messagesContainer = document.getElementById('messagesContainer');
                const messageDiv = document.createElement('div');
                messageDiv.className = 'flex justify-start animate-slide-up mb-6';
                
                const bubbleDiv = document.createElement('div');
                bubbleDiv.className = 'chat-bubble bot p-6 streaming';
                
                const messageId = `ai_msg_${Date.now()}_${this.messageCounter++}`;
                bubbleDiv.innerHTML = `
                    <div id="${messageId}" class="font-bold text-xl break-words overflow-wrap-anywhere text-gray-800"></div>
                `;
                
                messageDiv.appendChild(bubbleDiv);
                messagesContainer.appendChild(messageDiv);
                
                // æ»¾å‹•åˆ°åº•éƒ¨
                setTimeout(() => {
                    const chatArea = document.getElementById('chatArea');
                    chatArea.scrollTop = chatArea.scrollHeight;
                }, 100);
                
                return bubbleDiv;
            }
            
            // æ›´æ–°AIæ°£æ³¡å…§å®¹ - é¿å…DOMéŒ¯èª¤
            updateAIBubbleContent(bubble, content, messageId) {
                if (!bubble || !content) return;
                
                try {
                    const messageElement = bubble.querySelector(`#${messageId}`);
                    if (messageElement) {
                        // æ¸…ç†ä¸¦æ ¼å¼åŒ–å…§å®¹
                        const cleanContent = this.cleanAIContent(content);
                        
                        // ç›´æ¥è¨­ç½®å…§å®¹ï¼Œä¸ä½¿ç”¨è¤‡é›œçš„æ‰“å­—æ©Ÿæ•ˆæœ
                        messageElement.innerHTML = cleanContent;
                        
                        // ç¢ºä¿æ–‡å­—é¡è‰²æ­£ç¢º
                        messageElement.style.color = '#1e293b';
                        messageElement.classList.add('animate-fade-in');
                    }
                } catch (error) {
                    console.error('æ›´æ–°AIæ°£æ³¡å…§å®¹å¤±æ•—:', error);
                }
            }
            
            // æ¸…ç†AIå…§å®¹
            cleanAIContent(content) {
                if (!content) return '';
                
                return content
                    .replace(/\r\n/g, '\n')
                    .replace(/\r/g, '\n')
                    .replace(/\n\n+/g, '</p><p class="mb-3">')
                    .replace(/\n/g, '<br>')
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\*(.*?)\*/g, '<em>$1</em>')
                    .trim();
            }
            
            // æ·»åŠ AIæ¶ˆæ¯ - å‚™ç”¨æ–¹æ³•
            addAIMessage(content) {
                const messagesContainer = document.getElementById('messagesContainer');
                const messageDiv = document.createElement('div');
                messageDiv.className = 'flex justify-start animate-slide-up mb-6';
                
                const bubbleDiv = document.createElement('div');
                bubbleDiv.className = 'chat-bubble bot p-6 complete';
                
                const cleanContent = this.cleanAIContent(content);
                bubbleDiv.innerHTML = `<div class="font-bold text-xl break-words overflow-wrap-anywhere text-gray-800">${cleanContent}</div>`;
                
                messageDiv.appendChild(bubbleDiv);
                messagesContainer.appendChild(messageDiv);
                
                // æ»¾å‹•åˆ°åº•éƒ¨
                setTimeout(() => {
                    const chatArea = document.getElementById('chatArea');
                    chatArea.scrollTop = chatArea.scrollHeight;
                }, 100);
                
                return bubbleDiv;
            }
            
            // å‰µå»ºä¸¦é¡¯ç¤ºAIå›æ‡‰çš„æ”¹è‰¯æ–¹æ³•
            createAndShowAIMessage(content) {
                console.log('é¡¯ç¤ºAIå›æ‡‰:', content);
                
                const messagesContainer = document.getElementById('messagesContainer');
                const messageDiv = document.createElement('div');
                messageDiv.className = 'flex justify-start animate-slide-up mb-4';
                
                const bubbleDiv = document.createElement('div');
                bubbleDiv.className = 'chat-bubble bot';
                bubbleDiv.style.backgroundColor = '#ffffff';
                bubbleDiv.style.color = '#1e293b';
                bubbleDiv.style.border = '2px solid #3b82f6';
                bubbleDiv.style.padding = '10px 14px';
                bubbleDiv.style.maxWidth = 'fit-content';
                bubbleDiv.style.lineHeight = '1.5';
                bubbleDiv.style.position = 'relative';
                
                // å‰µå»ºå…§å®¹å®¹å™¨
                const contentDiv = document.createElement('div');
                contentDiv.className = 'font-bold text-base leading-relaxed break-words overflow-wrap-anywhere';
                contentDiv.style.color = '#1e293b';
                contentDiv.style.lineHeight = '1.5';
                
                // å‰µå»ºåœæ­¢æŒ‰éˆ•å®¹å™¨
                const stopButtonContainer = document.createElement('div');
                stopButtonContainer.className = 'stop-button-container mt-3 pt-3 border-t border-gray-200 flex justify-center';
                stopButtonContainer.style.display = 'block'; // åˆå§‹é¡¯ç¤º
                
                // å‰µå»ºåœæ­¢æŒ‰éˆ•
                const stopButton = document.createElement('button');
                stopButton.className = 'stop-ai-button bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-xl text-sm font-bold transition-all duration-300 flex items-center space-x-2 animate-pulse';
                stopButton.innerHTML = `
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                        <rect x="6" y="6" width="12" height="12" rx="2"/>
                    </svg>
                    <span>åœæ­¢ç”Ÿæˆ</span>
                `;
                
                // åœæ­¢æŒ‰éˆ•é»æ“Šäº‹ä»¶
                stopButton.addEventListener('click', () => {
                    this.stopAIResponse(bubbleDiv);
                });
                
                stopButtonContainer.appendChild(stopButton);
                
                // åªæœ‰ç•¶æœ‰å¯¦éš›å…§å®¹æ™‚æ‰é¡¯ç¤ºï¼Œä¸é¡¯ç¤º"æ€è€ƒä¸­"
                if (content && content.trim()) {
                    const formattedContent = this.cleanAndFormatAIResponse(content);
                    contentDiv.innerHTML = formattedContent;
                    
                    bubbleDiv.appendChild(contentDiv);
                    bubbleDiv.appendChild(stopButtonContainer);
                    messageDiv.appendChild(bubbleDiv);
                    messagesContainer.appendChild(messageDiv);
                    
                    // ç¢ºä¿æ»¾å‹•åˆ°åº•éƒ¨
                    setTimeout(() => {
                        const chatArea = document.getElementById('chatArea');
                        chatArea.scrollTop = chatArea.scrollHeight;
                    }, 100);
                    
                    return bubbleDiv;
                }
                
                // å¦‚æœæ²’æœ‰å…§å®¹ï¼Œå…ˆä¸é¡¯ç¤ºæ°£æ³¡ï¼Œç­‰æœ‰å…§å®¹æ™‚å†å‰µå»º
                return null;
            }
            
            // æ¸…ç†ä¸¦æ ¼å¼åŒ–AIå›æ‡‰å…§å®¹
            cleanAndFormatAIResponse(content) {
                if (!content) return '';
                
                // åœ¨AIå›æ‡‰å‰åŠ å…¥é©ç•¶çš„emoji
                const processedContent = this.addEmojisToAIResponse(content);
                
                let formattedContent = processedContent
                    .replace(/\r\n/g, '\n')
                    .replace(/\r/g, '\n')
                    // ç¢ºä¿æ®µè½é–“æœ‰é©ç•¶é–“è·
                    .replace(/\n\n+/g, '</p><p class="mb-4">')
                    .replace(/\n/g, '<br>')
                    // æ ¼å¼åŒ–ç²—é«”æ–‡å­—
                    .replace(/\*\*(.*?)\*\*/g, '<strong style="color: #1e40af;">$1</strong>')
                    .replace(/\*(.*?)\*/g, '<em>$1</em>')
                    // ç¢ºä¿æ¨™é»ç¬¦è™Ÿå¾Œæœ‰é©ç•¶é–“è·
                    .replace(/([ã€‚ï¼ï¼Ÿ])\s*/g, '$1 ')
                    .replace(/([ï¼Œã€ï¼šï¼›])\s*/g, '$1 ')
                    // ç§»é™¤å¤šé¤˜ç©ºæ ¼ä½†ä¿æŒæ®µè½çµæ§‹
                    .replace(/ +/g, ' ')
                    .trim();
                
                // ç§»é™¤äº†åº•éƒ¨æç¤ºæ–‡å­— - ä¸éœ€è¦é¡å¤–çš„ç©ºç™½å’Œæç¤º
                
                return formattedContent;
            }
            
            // æ™ºèƒ½æ·»åŠ emojiåˆ°AIå›æ‡‰
            addEmojisToAIResponse(content) {
                if (!content) return '';
                
                // å›æ‡‰é–‹å§‹çš„æƒ…æ„Ÿemoji
                const greetingEmojis = ['ğŸ˜Š', 'ğŸ‘‹', 'ğŸ¤–', 'ğŸ’­', 'âœ¨'];
                const randomGreeting = greetingEmojis[Math.floor(Math.random() * greetingEmojis.length)];
                
                // æ ¹æ“šå…§å®¹é¡å‹æ·»åŠ ç›¸é—œemoji
                let enhancedContent = content;
                
                // å•å€™èªé–‹é ­ - ä¿®æ­£emojiæª¢æ¸¬
                if (!content.match(/^[\u{1F600}-\u{1F64F}\u{1F300}-\u{1F5FF}\u{1F680}-\u{1F6FF}\u{1F1E0}-\u{1F1FF}]/u) && content.length > 0) {
                    enhancedContent = `${randomGreeting} ${content}`;
                }
                
                // æ ¹æ“šå…§å®¹é—œéµè©æ·»åŠ ç›¸é—œemoji
                const emojiMappings = {
                    // è¨­è¨ˆæ€ç¶­ç›¸é—œ
                    'è¨­è¨ˆæ€ç¶­': 'ğŸ¨',
                    'å‰µæ–°': 'ğŸ’¡',
                    'è§£æ±ºæ–¹æ¡ˆ': 'ğŸ”§',
                    'åˆ†æ': 'ğŸ“Š',
                    'å»ºè­°': 'ğŸ’­',
                    'å¹«åŠ©': 'ğŸ¤',
                    'å”åŠ©': 'ğŸ¤',
                    
                    // æƒ…æ„Ÿå›æ‡‰
                    'å¾ˆå¥½': 'ğŸ‘',
                    'å„ªç§€': 'â­',
                    'å®Œç¾': 'âœ¨',
                    'å¤ªæ£’äº†': 'ğŸ‰',
                    'æˆåŠŸ': 'ğŸ†',
                    'è¬è¬': 'ğŸ™',
                    'æ„Ÿè¬': 'ğŸ™',
                    
                    // å•é¡Œå’Œè§£ç­”
                    'å•é¡Œ': 'â“',
                    'ç­”æ¡ˆ': 'ğŸ’¡',
                    'èªªæ˜': 'ğŸ“',
                    'æ­¥é©Ÿ': 'ğŸ“‹',
                    'æ–¹æ³•': 'ğŸ”§',
                    'æŠ€å·§': 'âš¡',
                    
                    // å­¸ç¿’å’Œæ•™è‚²
                    'å­¸ç¿’': 'ğŸ“š',
                    'æ•™å­¸': 'ğŸ“',
                    'çŸ¥è­˜': 'ğŸ§ ',
                    'è³‡è¨Š': 'ğŸ“°',
                    'è©³ç´°': 'ğŸ”',
                    
                    // æ³¨æ„å’Œè­¦å‘Š
                    'æ³¨æ„': 'âš ï¸',
                    'é‡è¦': 'â€¼ï¸',
                    'æé†’': 'ğŸ“Œ',
                    'è¨˜ä½': 'ğŸ§ ',
                    
                    // çµæŸå’Œç¸½çµ
                    'ç¸½çµ': 'ğŸ“',
                    'çµè«–': 'ğŸ¯',
                    'å®Œæˆ': 'âœ…',
                    'çµæŸ': 'ğŸ'
                };
                
                // åœ¨ç›¸é—œé—œéµè©å‰æ·»åŠ emoji
                Object.entries(emojiMappings).forEach(([keyword, emoji]) => {
                    const regex = new RegExp(`\\b${keyword}\\b`, 'gi');
                    enhancedContent = enhancedContent.replace(regex, `${emoji} $&`);
                });
                
                return enhancedContent;
            }
            
            // æ›´æ–°AIæ¶ˆæ¯å…§å®¹
            updateAIMessageContent(bubbleElement, content) {
                if (!bubbleElement || !content) return;
                
                try {
                    console.log('æ›´æ–°AIå›æ‡‰å…§å®¹:', content.substring(0, 100) + '...');
                    
                    const contentDiv = bubbleElement.querySelector('div:first-child');
                    if (contentDiv) {
                        // è¨­ç½®æ ¼å¼åŒ–å¾Œçš„å…§å®¹
                        contentDiv.innerHTML = content;
                        contentDiv.style.color = '#1e293b';
                        
                        // ç¢ºä¿æ°£æ³¡æ¨£å¼æ­£ç¢º
                        bubbleElement.style.backgroundColor = '#ffffff';
                        bubbleElement.style.border = '2px solid #3b82f6';
                        
                        // æ»¾å‹•åˆ°åº•éƒ¨
                        setTimeout(() => {
                            const chatArea = document.getElementById('chatArea');
                            chatArea.scrollTop = chatArea.scrollHeight;
                        }, 50);
                    }
                } catch (error) {
                    console.error('æ›´æ–°AIå…§å®¹å¤±æ•—:', error);
                }
            }
            
            // åœæ­¢AIå›æ‡‰åŠŸèƒ½ - æ”¹é€²ç‰ˆï¼Œç«‹åˆ»åœæ­¢å…§å®¹æ›´æ–°
            stopAIResponse(bubbleElement, context) {
                try {
                    console.log('ğŸ›‘ ç”¨æˆ¶è¦æ±‚ç«‹åˆ»åœæ­¢AIå›æ‡‰');
                    
                    // ç«‹å³æ¨™è¨˜ç‚ºå·²åœæ­¢ï¼Œé˜»æ­¢å¾ŒçºŒå…§å®¹æ›´æ–°
                    if (context) {
                        context.isStopped = true;
                    }
                    this.aiResponseStopped = true;
                    
                    // éš±è—åœæ­¢æŒ‰éˆ•
                    const stopButtonContainer = bubbleElement.querySelector('.stop-button-container');
                    if (stopButtonContainer) {
                        stopButtonContainer.style.display = 'none';
                    }
                    
                    // ç«‹å³åœæ­¢å…§å®¹æ›´æ–°ä¸¦æ·»åŠ åœæ­¢æ¨™è¨˜
                    const contentDiv = bubbleElement.querySelector('div:first-child');
                    if (contentDiv) {
                        // ç²å–ç•¶å‰å…§å®¹ä¸¦æ¸…ç†HTMLæ¨™ç±¤ç²å¾—ç´”æ–‡å­—
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = contentDiv.innerHTML;
                        const currentTextContent = tempDiv.textContent || tempDiv.innerText || '';
                        
                        // ç«‹å³å‡çµç•¶å‰å…§å®¹ï¼Œä¸å†æ¥å—æ›´æ–°
                        const finalContent = contentDiv.innerHTML + '<br><br><em style="color: #dc2626; font-size: 0.9em; font-weight: bold;">ğŸ›‘ å›æ‡‰å·²è¢«ç”¨æˆ¶åœæ­¢</em>';
                        contentDiv.innerHTML = finalContent;
                        
                        // é˜²æ­¢é€²ä¸€æ­¥ä¿®æ”¹
                        contentDiv.style.pointerEvents = 'none';
                        
                        // ä¿å­˜ç•¶å‰å…§å®¹åˆ°å°è©±è¨˜éŒ„
                        if (currentTextContent.trim()) {
                            const stoppedContent = currentTextContent + '\n\n[å›æ‡‰å·²è¢«ç”¨æˆ¶åœæ­¢]';
                            this.saveMessage(stoppedContent, false);
                        }
                    }
                    
                    // ç§»é™¤å‹•ç•«å’Œé‚Šæ¡†è„ˆå‹•æ•ˆæœ
                    bubbleElement.classList.remove('animate-pulse', 'animate-border-pulse');
                    bubbleElement.style.animation = 'none';
                    bubbleElement.style.border = '2px solid #dc2626'; // ç´…è‰²é‚Šæ¡†è¡¨ç¤ºå·²åœæ­¢
                    bubbleElement.style.opacity = '0.95'; // ç¨å¾®é™ä½é€æ˜åº¦è¡¨ç¤ºå·²åœæ­¢
                    
                    // ç«‹å³é¡¯ç¤ºåœæ­¢æˆåŠŸçš„æç¤º
                    this.showToast('ğŸ›‘ AIå›æ‡‰å·²ç«‹å³åœæ­¢', 'warning');
                    
                    console.log('âœ… AIå›æ‡‰å·²ç«‹å³æˆåŠŸåœæ­¢ï¼Œä¸å†æ¥å—ä»»ä½•æ›´æ–°');
                    
                } catch (error) {
                    console.error('âŒ åœæ­¢AIå›æ‡‰æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                    this.showToast('âŒ åœæ­¢å›æ‡‰æ™‚ç™¼ç”ŸéŒ¯èª¤', 'error');
                }
            }
            
            // éš±è—åœæ­¢æŒ‰éˆ•åŠŸèƒ½
            hideStopButton(bubbleElement) {
                try {
                    if (!bubbleElement) {
                        console.warn('âš ï¸ hideStopButton: bubbleElement ç‚ºç©º');
                        return;
                    }
                    
                    const stopButtonContainer = bubbleElement.querySelector('.stop-button-container');
                    if (stopButtonContainer) {
                        console.log('ğŸ”„ é–‹å§‹éš±è—åœæ­¢æŒ‰éˆ•...');
                        
                        // ç«‹å³éš±è—åœæ­¢æŒ‰éˆ•ï¼Œä¸ä½¿ç”¨å‹•ç•«å»¶é²
                        stopButtonContainer.style.transition = 'opacity 0.3s ease-out, transform 0.3s ease-out';
                        stopButtonContainer.style.opacity = '0';
                        stopButtonContainer.style.transform = 'translateY(10px) scale(0.9)';
                        
                        // è¼ƒçŸ­çš„å»¶é²å¾Œå®Œå…¨éš±è—
                        setTimeout(() => {
                            stopButtonContainer.style.display = 'none';
                            stopButtonContainer.remove(); // å®Œå…¨ç§»é™¤å…ƒç´ 
                        }, 300);
                        
                        console.log('âœ… åœæ­¢æŒ‰éˆ•éš±è—å‹•ç•«å·²å•Ÿå‹•');
                    } else {
                        console.warn('âš ï¸ æœªæ‰¾åˆ°åœæ­¢æŒ‰éˆ•å®¹å™¨');
                    }
                    
                    // ç§»é™¤é‚Šæ¡†å‹•ç•«æ•ˆæœï¼Œè¡¨ç¤ºAIå›æ‡‰å®Œæˆ
                    if (bubbleElement.classList) {
                        bubbleElement.classList.remove('animate-pulse', 'animate-border-pulse');
                    }
                    bubbleElement.style.border = '2px solid #10b981'; // ç¶ è‰²é‚Šæ¡†è¡¨ç¤ºå®Œæˆ
                    bubbleElement.style.animation = 'none';
                    
                    // æ·»åŠ å®Œæˆæ¨™è¨˜
                    bubbleElement.setAttribute('data-ai-status', 'complete');
                    
                    console.log('âœ… åœæ­¢æŒ‰éˆ•å·²éš±è—ï¼ŒAIå›æ‡‰æ¨™è¨˜ç‚ºå®Œæˆ');
                    
                } catch (error) {
                    console.error('âŒ éš±è—åœæ­¢æŒ‰éˆ•æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                }
            }
            
            ensureMessageVisibility() {
                // ç¢ºä¿æ‰€æœ‰æ¶ˆæ¯æ°£æ³¡éƒ½åœ¨å¯è¦–ç¯„åœå…§
                const messagesContainer = document.getElementById('messagesContainer');
                const chatBubbles = messagesContainer.querySelectorAll('.chat-bubble');
                
                chatBubbles.forEach(bubble => {
                    // æª¢æŸ¥æ°£æ³¡æ˜¯å¦è¶…å‡ºå®¹å™¨é‚Šç•Œ
                    const rect = bubble.getBoundingClientRect();
                    const containerRect = messagesContainer.getBoundingClientRect();
                    
                    // å¦‚æœæ°£æ³¡è¶…å‡ºå®¹å™¨ï¼Œèª¿æ•´å…¶æ¨£å¼
                    if (rect.width > containerRect.width * 0.9) {
                        bubble.style.maxWidth = '90%';
                        bubble.style.wordBreak = 'break-all';
                        bubble.style.overflowWrap = 'anywhere';
                    }
                });
                
                const chatArea = document.getElementById('chatArea');
                chatArea.scrollTop = chatArea.scrollHeight;
            }
            
            // åˆªé™¤æ¶ˆæ¯åŠŸèƒ½
            deleteMessage(messageDiv, content) {
                this.showCustomConfirm('åˆªé™¤è¨Šæ¯', 'ç¢ºå®šè¦åˆªé™¤æ­¤è¨Šæ¯å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•æ’¤éŠ·ã€‚', () => {
                    // æ·»åŠ åˆªé™¤å‹•ç•«
                    messageDiv.style.transition = 'all 0.3s ease-out';
                    messageDiv.style.opacity = '0';
                    messageDiv.style.transform = 'translateX(-100%) scale(0.8)';
                    
                    setTimeout(() => {
                        messageDiv.remove();
                        
                        // å¾å°è©±è¨˜éŒ„ä¸­ç§»é™¤æ­¤æ¶ˆæ¯
                        const conversation = this.conversations.find(c => c.id === this.currentConversationId);
                        if (conversation && conversation.messages) {
                            // æ‰¾åˆ°ä¸¦ç§»é™¤å°æ‡‰çš„æ¶ˆæ¯
                            const messageIndex = conversation.messages.findIndex(msg => 
                                msg.content === content && msg.isUser === true
                            );
                            
                            if (messageIndex !== -1) {
                                // ç§»é™¤ç”¨æˆ¶æ¶ˆæ¯
                                conversation.messages.splice(messageIndex, 1);
                                
                                // å¦‚æœä¸‹ä¸€æ¢æ˜¯AIå›æ‡‰ï¼Œä¹Ÿä¸€èµ·ç§»é™¤
                                if (messageIndex < conversation.messages.length && 
                                    !conversation.messages[messageIndex].isUser) {
                                    conversation.messages.splice(messageIndex, 1);
                                }
                                
                                conversation.lastUpdated = new Date().toISOString();
                                this.saveConversations();
                            }
                        }
                        
                        this.showToast('âœ… è¨Šæ¯å·²åˆªé™¤', 'info');
                    }, 300);
                });
            }
            
            // é‡æ–°ç™¼é€æ¶ˆæ¯åŠŸèƒ½
            resendMessage(content) {
                console.log('ğŸ”„ é‡æ–°ç™¼é€è¨Šæ¯:', content);
                
                // ç«‹å³æ·»åŠ ç”¨æˆ¶æ¶ˆæ¯åˆ°èŠå¤©ç•Œé¢
                this.addMessageToChat(content, true);
                this.saveMessage(content, true);
                
                // é‡æ–°ç™¼é€åˆ°AI
                this.sendToAI(content, []);
                
                this.showToast('ğŸ”„ æ­£åœ¨é‡æ–°ç™¼é€è¨Šæ¯...', 'info');
            }
            
            // é¡¯ç¤ºç”¨æˆ¶åé¥‹å°è©±æ¡†
            showUserFeedbackModal() {
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4 animate-fade-in';
                modal.innerHTML = `
                    <div class="bg-gradient-to-br from-blue-600 to-blue-800 rounded-2xl shadow-2xl max-w-md w-full p-6 animate-scale-bounce border-2 border-white border-opacity-20 max-h-[85vh] overflow-y-auto">
                        <!-- æ¨™é¡Œå€åŸŸ -->
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="text-xl font-black text-white">ç”¨å®¶åæ˜ äº‹é …</h3>
                            <button class="close-feedback text-white hover:text-gray-300 p-2 rounded-xl transition-all duration-200 button-hover-lift">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                        
                        <!-- ğŸ”§ é–‹ç™¼äººå“¡æ¨¡å¼æŒ‰éˆ• - é¡¯çœ¼ä½ç½® -->
                        <div class="mb-8 p-4 bg-purple-600 bg-opacity-30 rounded-xl border-2 border-purple-400 border-opacity-50">
                            <h4 class="text-white font-black text-base mb-3 text-center">ğŸ”§ é–‹ç™¼äººå“¡å°ˆå€</h4>
                            <button id="developerModeBtn" class="w-full bg-gradient-to-r from-purple-500 to-purple-600 hover:from-purple-600 hover:to-purple-700 text-white font-black py-4 px-6 rounded-xl transition-all duration-300 text-base button-hover-lift animate-glow-pulse flex items-center justify-center space-x-3 shadow-xl border-2 border-purple-300 border-opacity-50">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"></path>
                                </svg>
                                <span>ğŸ’» é–‹ç™¼äººå“¡æ¨¡å¼</span>
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                </svg>
                            </button>
                            <p class="text-purple-200 font-bold text-xs mt-2 text-center">æŸ¥çœ‹æ‰€æœ‰ç”¨æˆ¶åé¥‹å’Œçµ±è¨ˆæ•¸æ“š</p>
                        </div>
                        
                        <!-- ç”¨æˆ¶é«”é©—èª¿æŸ¥å€åŸŸ -->
                        <div class="bg-white bg-opacity-15 rounded-xl p-4 mb-6 border border-white border-opacity-20">
                            <div class="flex items-center mb-3">
                                <span class="text-xl mr-2">â­</span>
                                <h4 class="text-base font-black text-white">ç”¨æˆ¶é«”é©—èª¿æŸ¥</h4>
                            </div>
                            <p class="text-white font-bold mb-3 leading-relaxed text-sm">
                                æ‚¨å¥½ï¼Œæ­¡è¿é€²å…¥é€™å¹³å°åæ˜ çš„å€åŸŸ~ ã€‚ç”¨å®¶å¯ä»¥åæ˜ æœ¬å¹³å°æ•´é«”çš„ä½¿ç”¨æ„Ÿå—~
                            </p>
                            
                            <!-- èª¿æŸ¥å•é¡Œåˆ—è¡¨ -->
                            <div class="space-y-2 text-white font-bold text-xs">
                                <div class="flex items-start space-x-2">
                                    <span class="text-blue-300">â€¢</span>
                                    <span>è·ŸAIå°è©±å¦‚ä½•?</span>
                                </div>
                                <div class="flex items-start space-x-2">
                                    <span class="text-blue-300">â€¢</span>
                                    <span>å¯å¦è§£æ±ºç”¨å®¶çš„éœ€è¦ï¼Ÿ</span>
                                </div>
                                <div class="flex items-start space-x-2">
                                    <span class="text-blue-300">â€¢</span>
                                    <span>AIçš„æ„è¦‹æº–ç¢ºå—ï¼Ÿæ…‹åº¦å¦‚ä½•ï¼Ÿ</span>
                                </div>
                                <div class="flex items-start space-x-2">
                                    <span class="text-blue-300">â€¢</span>
                                    <span>å¹³å°çš„åŠŸèƒ½,æµæš¢æ€§,ä½¿ç”¨çš„æ„Ÿè¦ºåˆæ˜¯æ€æ¨£ï¼Ÿ</span>
                                </div>
                            </div>
                            
                            <div class="mt-3 p-3 bg-blue-500 bg-opacity-30 rounded-lg border border-blue-400 border-opacity-50">
                                <p class="text-white font-bold text-xs text-center">
                                    å¸Œæœ›ç”¨å®¶å¯ä»¥åæ˜ é€™å€‹Chatbotéœ€è¦ç²¾è®€åŠéœ€è¦é–‹ç™¼è€…å„ªåŒ–ã€
                                    é‡æ–°è¨­è¨ˆæ€è€ƒå°ˆæ¬„ä½ç½®
                                </p>
                            </div>
                        </div>
                        
                        <!-- åé¥‹æ„è¦‹å€åŸŸ -->
                        <div class="mb-6">
                            <h4 class="text-white font-black text-base mb-3">æ‚¨çš„åé¥‹æ„è¦‹ï¼š</h4>
                            <textarea 
                                id="feedbackText" 
                                placeholder="è«‹åˆ†äº«æ‚¨çš„ä½¿ç”¨é«”é©—å’Œå»ºè­°..." 
                                class="w-full h-32 p-3 bg-white bg-opacity-10 border-2 border-white border-opacity-30 rounded-xl text-white placeholder-blue-200 resize-y focus:outline-none focus:ring-2 focus:ring-white focus:ring-opacity-50 font-bold text-sm leading-relaxed"
                                rows="6"
                            ></textarea>
                            <p class="text-blue-200 font-bold text-xs mt-2">ğŸ’¬ æ²’æœ‰å­—æ•¸é™åˆ¶ï¼Œè«‹è‡ªç”±åˆ†äº«æ‚¨çš„æƒ³æ³•</p>
                        </div>
                        
                        <!-- æ“ä½œæŒ‰éˆ• -->
                        <div class="space-y-3">
                            <button id="submitFeedback" class="w-full bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white font-black py-3 px-5 rounded-xl transition-all duration-300 text-base button-hover-lift animate-glow-pulse">
                                æäº¤åé¥‹
                            </button>
                            
                            <div class="grid grid-cols-2 gap-3">
                                <button class="back-to-previous bg-transparent border-2 border-white border-opacity-50 hover:bg-white hover:bg-opacity-10 text-white font-bold py-2 px-3 rounded-xl transition-all duration-300 flex items-center justify-center space-x-1 button-hover-lift text-sm">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                                    </svg>
                                    <span>è¿”å›ä¸Šä¸€é </span>
                                </button>
                                <button class="back-to-home bg-transparent border-2 border-white border-opacity-50 hover:bg-white hover:bg-opacity-10 text-white font-bold py-2 px-3 rounded-xl transition-all duration-300 flex items-center justify-center space-x-1 button-hover-lift text-sm">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m0-11l7 7m0-5v5a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-1a1 1 0 011-1h2a1 1 0 011 1v1a1 1 0 001 1m-6 0h6"></path>
                                    </svg>
                                    <span>è¿”å›ä¸»é </span>
                                </button>
                            </div>
                        </div>
                        
                        <!-- éš±ç§èªªæ˜ -->
                        <div class="mt-6 pt-4 border-t border-white border-opacity-20">
                            <div class="bg-blue-500 bg-opacity-20 rounded-xl p-4 border border-blue-400 border-opacity-30">
                                <div class="flex items-start space-x-3">
                                    <div class="w-6 h-6 bg-blue-500 bg-opacity-40 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5">
                                        <svg class="w-3 h-3 text-blue-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                    </div>
                                    <div class="flex-1">
                                        <h5 class="text-blue-200 font-black text-sm mb-2">ğŸ”’ éš±ç§ä¿è­·è²æ˜</h5>
                                        <p class="text-white font-bold text-xs leading-relaxed">
                                            å¹³å°æ”¶é›†ç”¨å®¶æ„è¦‹ï¼Œæ˜¯ç‚ºäº†é€²ä¸€æ­¥å„ªåŒ–å¹³å°çš„å¯¦ç”¨æ€§ï¼Œä¿®å¾©BugéŒ¯èª¤çš„å•é¡Œï¼Œé–‹ç™¼æ›´å¤šåŠŸèƒ½ã€‚æ‰€æœ‰çš„è©•è«–ï¼Œéƒ½ä¸æœƒå…¬é–‹ï¼Œåªæœƒç”¨ä½œåˆ†æåŠæ”¹é€²ã€‚
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // è¨­ç½®äº‹ä»¶ç›£è½å™¨
                this.setupFeedbackModalEvents(modal);
                
                // é—œé–‰å´é‚Šæ¬„
                this.closeSidebar();
            }
            
            // è¨­ç½®æ˜Ÿç´šè©•åˆ†åŠŸèƒ½
            setupStarRating(modal) {
                const stars = modal.querySelectorAll('.star-btn');
                const currentRating = modal.querySelector('#currentRating');
                let selectedRating = 0;
                
                stars.forEach((starBtn, index) => {
                    const star = starBtn.querySelector('.star');
                    
                    // é¼ æ¨™æ‡¸åœæ•ˆæœ
                    starBtn.addEventListener('mouseenter', () => {
                        for (let i = 0; i <= index; i++) {
                            stars[i].querySelector('.star').style.color = '#fbbf24';
                        }
                        for (let i = index + 1; i < stars.length; i++) {
                            stars[i].querySelector('.star').style.color = '#9ca3af';
                        }
                    });
                    
                    // é¼ æ¨™é›¢é–‹æ•ˆæœ
                    starBtn.addEventListener('mouseleave', () => {
                        for (let i = 0; i < selectedRating; i++) {
                            stars[i].querySelector('.star').style.color = '#fbbf24';
                        }
                        for (let i = selectedRating; i < stars.length; i++) {
                            stars[i].querySelector('.star').style.color = '#9ca3af';
                        }
                    });
                    
                    // é»æ“Šé¸æ“‡è©•åˆ†
                    starBtn.addEventListener('click', () => {
                        selectedRating = index + 1;
                        currentRating.textContent = selectedRating;
                        
                        // æ›´æ–°æ˜Ÿæ˜Ÿé¡è‰²
                        for (let i = 0; i < selectedRating; i++) {
                            stars[i].querySelector('.star').style.color = '#fbbf24';
                        }
                        for (let i = selectedRating; i < stars.length; i++) {
                            stars[i].querySelector('.star').style.color = '#9ca3af';
                        }
                        
                        // æ·»åŠ å‹•ç•«æ•ˆæœ
                        starBtn.style.transform = 'scale(1.2)';
                        setTimeout(() => {
                            starBtn.style.transform = 'scale(1)';
                        }, 200);
                    });
                });
            }
            
            // è¨­ç½®åé¥‹å°è©±æ¡†äº‹ä»¶ç›£è½å™¨
            setupFeedbackModalEvents(modal) {
                const closeBtn = modal.querySelector('.close-feedback');
                const submitBtn = modal.querySelector('#submitFeedback');
                const backToPreviousBtn = modal.querySelector('.back-to-previous');
                const backToHomeBtn = modal.querySelector('.back-to-home');
                const feedbackText = modal.querySelector('#feedbackText');
                const developerModeBtn = modal.querySelector('#developerModeBtn');
                
                const closeModal = () => {
                    modal.style.opacity = '0';
                    modal.style.transform = 'scale(0.95)';
                    setTimeout(() => modal.remove(), 300);
                };
                
                // é–‹ç™¼äººå“¡æ¨¡å¼æŒ‰éˆ•äº‹ä»¶ - æ·»åŠ å¯†ç¢¼ä¿è­·
                developerModeBtn.addEventListener('click', () => {
                    this.showPasswordPrompt((isValid) => {
                        if (isValid) {
                            closeModal();
                            this.showDeveloperFeedbackViewer();
                        }
                    });
                });
                
                // é—œé–‰æŒ‰éˆ•
                closeBtn.addEventListener('click', closeModal);
                
                // é»æ“Šé®ç½©é—œé–‰
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        closeModal();
                    }
                });
                
                // ESC éµé—œé–‰
                const escapeHandler = (e) => {
                    if (e.key === 'Escape') {
                        closeModal();
                        document.removeEventListener('keydown', escapeHandler);
                    }
                };
                document.addEventListener('keydown', escapeHandler);
                
                // æäº¤åé¥‹
                submitBtn.addEventListener('click', () => {
                    const feedback = feedbackText.value.trim();
                    
                    if (!feedback) {
                        this.showToast('è«‹æä¾›åé¥‹æ„è¦‹', 'warning');
                        return;
                    }
                    
                    // ä¿å­˜åé¥‹åˆ°æœ¬åœ°å­˜å„²
                    this.saveFeedback({
                        feedback: feedback,
                        timestamp: new Date().toISOString(),
                        deviceFingerprint: this.deviceFingerprint
                    });
                    
                    closeModal();
                    this.showToast('âœ… æ„Ÿè¬æ‚¨çš„åé¥‹ï¼æˆ‘å€‘æœƒæŒçºŒæ”¹é€²å¹³å°', 'success');
                });
                
                // è¿”å›ä¸Šä¸€é ï¼ˆé—œé–‰å°è©±æ¡†ï¼‰
                backToPreviousBtn.addEventListener('click', closeModal);
                
                // è¿”å›ä¸»é 
                backToHomeBtn.addEventListener('click', () => {
                    closeModal();
                    if (window.pageManager) {
                        window.pageManager.showPage('homePage');
                    }
                });
            }
            
            // ä¿å­˜åé¥‹åˆ°æœ¬åœ°å­˜å„²
            saveFeedback(feedback) {
                try {
                    const feedbacks = this.loadFeedbacks();
                    feedbacks.push(feedback);
                    
                    // ä¿å­˜åˆ°å¤šå€‹å­˜å„²ä½ç½®
                    if (this.storageAvailable.localStorage) {
                        localStorage.setItem('chatbot_user_feedbacks', JSON.stringify(feedbacks));
                    }
                    
                    if (this.storageAvailable.sessionStorage) {
                        sessionStorage.setItem('chatbot_user_feedbacks', JSON.stringify(feedbacks));
                    }
                    
                    // å…§å­˜å‚™ä»½
                    if (!window.__chatbot_memory_storage) {
                        window.__chatbot_memory_storage = {};
                    }
                    window.__chatbot_memory_storage.feedbacks = feedbacks;
                    
                    console.log('ğŸ’¾ ç”¨æˆ¶åé¥‹å·²ä¿å­˜:', feedback);
                } catch (error) {
                    console.error('âŒ ä¿å­˜åé¥‹å¤±æ•—:', error);
                }
            }
            
            // è¼‰å…¥ç¾æœ‰åé¥‹
            loadFeedbacks() {
                try {
                    if (this.storageAvailable.localStorage) {
                        const feedbacks = localStorage.getItem('chatbot_user_feedbacks');
                        if (feedbacks) {
                            return JSON.parse(feedbacks);
                        }
                    }
                    
                    if (this.storageAvailable.sessionStorage) {
                        const feedbacks = sessionStorage.getItem('chatbot_user_feedbacks');
                        if (feedbacks) {
                            return JSON.parse(feedbacks);
                        }
                    }
                    
                    // å…§å­˜å­˜å„²
                    if (window.__chatbot_memory_storage && window.__chatbot_memory_storage.feedbacks) {
                        return window.__chatbot_memory_storage.feedbacks;
                    }
                    
                    return [];
                } catch (error) {
                    console.error('âŒ è¼‰å…¥åé¥‹å¤±æ•—:', error);
                    return [];
                }
            }
            
            // é¡¯ç¤ºé–‹ç™¼äººå“¡åé¥‹æŸ¥çœ‹å™¨
            showDeveloperFeedbackViewer() {
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 p-4 animate-fade-in';
                modal.innerHTML = `
                    <div class="bg-gradient-to-br from-gray-900 to-gray-800 rounded-2xl shadow-2xl max-w-5xl w-full max-h-[90vh] overflow-hidden animate-scale-bounce border-2 border-purple-500 border-opacity-50">
                        <!-- æ¨™é¡Œå€åŸŸ -->
                        <div class="bg-gradient-to-r from-purple-600 to-blue-600 p-6 border-b border-purple-400 border-opacity-50">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-3">
                                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"></path>
                                    </svg>
                                    <h3 class="text-2xl font-black text-white">é–‹ç™¼äººå“¡æ¨¡å¼ - ç”¨æˆ¶åé¥‹æŸ¥çœ‹å™¨</h3>
                                </div>
                                <button class="close-developer-modal text-white hover:text-gray-300 p-2 rounded-xl transition-all duration-200 button-hover-lift">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        
                        <!-- çµ±è¨ˆä¿¡æ¯ - ç¸½äººæ•¸é¡¯ç¤º -->
                        <div class="p-4 bg-gradient-to-r from-purple-800 to-blue-800 border-b border-purple-400 border-opacity-30">
                            <div class="flex justify-center">
                                <div class="bg-white bg-opacity-15 rounded-xl p-6 text-center border-2 border-white border-opacity-20 shadow-lg">
                                    <div class="text-3xl font-black text-white mb-2" id="totalUsers">0</div>
                                    <div class="text-base font-bold text-purple-200">ğŸ‘¥ ç¸½ç”¨æˆ¶äººæ•¸</div>
                                    <div class="text-xs font-medium text-purple-300 mt-1">å·²æäº¤åé¥‹çš„ç”¨æˆ¶æ•¸é‡</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- åé¥‹åˆ—è¡¨ - å¢åŠ å¯æ»¾å‹•å€åŸŸèˆ‡æ˜é¡¯æ»¾å‹•æ¢ -->
                        <div class="flex-1 overflow-y-auto p-3 space-y-3 max-h-[75vh] min-h-[400px] developer-scrollbar" id="feedbackList">
                            <!-- åé¥‹é …ç›®å°‡åœ¨é€™è£¡å‹•æ…‹ç”Ÿæˆ -->
                        </div>
                        
                        <!-- åº•éƒ¨æ“ä½œæŒ‰éˆ• - æ”¹ç‚ºå‚ç›´æ’åˆ— -->
                        <div class="p-6 bg-gradient-to-r from-gray-800 to-gray-700 border-t border-purple-400 border-opacity-30">
                            <div class="flex flex-col space-y-3">
                                <button id="refreshFeedbacks" class="bg-blue-600 hover:bg-blue-700 text-white font-black py-4 px-6 rounded-xl transition-all duration-300 button-hover-lift flex items-center justify-center space-x-3 animate-glow-pulse shadow-lg">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                    </svg>
                                    <span class="text-lg">ğŸ”„ å³æ™‚åˆ·æ–°</span>
                                </button>
                                <button id="exportFeedbacks" class="bg-green-600 hover:bg-green-700 text-white font-black py-4 px-6 rounded-xl transition-all duration-300 button-hover-lift flex items-center justify-center space-x-3">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                    </svg>
                                    <span class="text-lg">ğŸ“¤ åŒ¯å‡ºåé¥‹</span>
                                </button>
                                <button id="clearOldFeedbacks" class="bg-yellow-600 hover:bg-yellow-700 text-white font-black py-4 px-6 rounded-xl transition-all duration-300 button-hover-lift flex items-center justify-center space-x-3">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                    </svg>
                                    <span class="text-lg">ğŸ—‘ï¸ æ¸…ç†èˆŠåé¥‹</span>
                                </button>
                                <button class="close-developer-modal bg-red-600 hover:bg-red-700 text-white font-black py-4 px-6 rounded-xl transition-all duration-300 button-hover-lift flex items-center justify-center space-x-3">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                    <span class="text-lg">âŒ é—œé–‰</span>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // è¼‰å…¥ä¸¦é¡¯ç¤ºåé¥‹æ•¸æ“š
                this.loadDeveloperFeedbackData(modal);
                
                // è¨­ç½®äº‹ä»¶ç›£è½å™¨
                this.setupDeveloperModalEvents(modal);
                
                console.log('ğŸ”§ é–‹ç™¼äººå“¡åé¥‹æŸ¥çœ‹å™¨å·²é–‹å•Ÿ');
            }
            
            // è¼‰å…¥é–‹ç™¼äººå“¡åé¥‹æ•¸æ“š
            loadDeveloperFeedbackData(modal) {
                const feedbacks = this.loadFeedbacks();
                console.log('ğŸ“Š è¼‰å…¥çš„åé¥‹æ•¸æ“š:', feedbacks);
                
                const today = new Date();
                const todayStr = today.toISOString().split('T')[0];
                const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
                const monthAgo = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000);
                
                // è¨ˆç®—ç¸½ç”¨æˆ¶äººæ•¸ï¼ˆæœ‰åé¥‹çš„ç”¨æˆ¶æ•¸é‡ï¼‰
                const uniqueUsers = new Set();
                feedbacks.forEach(f => {
                    if (f.deviceFingerprint) {
                        uniqueUsers.add(f.deviceFingerprint);
                    }
                });
                const totalUsers = uniqueUsers.size || feedbacks.length;
                
                // æ›´æ–°çµ±è¨ˆæ•¸æ“š
                modal.querySelector('#totalUsers').textContent = totalUsers;
                
                // é¡¯ç¤ºåé¥‹åˆ—è¡¨
                const feedbackList = modal.querySelector('#feedbackList');
                feedbackList.innerHTML = '';
                
                if (feedbacks.length === 0) {
                    feedbackList.innerHTML = `
                        <div class="text-center py-12">
                            <svg class="w-16 h-16 text-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                            </svg>
                            <h3 class="text-xl font-bold text-gray-400 mb-2">æš«ç„¡ç”¨æˆ¶åé¥‹</h3>
                            <p class="text-gray-500 font-medium">ç”¨æˆ¶æäº¤åé¥‹å¾Œå°‡åœ¨æ­¤è™•é¡¯ç¤º</p>
                            <div class="mt-4 p-4 bg-blue-500 bg-opacity-20 rounded-lg border border-blue-400 border-opacity-30">
                                <p class="text-blue-200 font-bold text-sm">ğŸ’¡ æç¤ºï¼šç”¨æˆ¶å¯ä»¥é€šéå´é‚Šæ¬„çš„ã€Œç”¨å®¶åæ˜ äº‹é …ã€æŒ‰éˆ•æäº¤åé¥‹</p>
                            </div>
                        </div>
                    `;
                } else {
                    // æŒ‰æ™‚é–“å€’åºæ’åˆ—ï¼Œç¢ºä¿æœ€æ–°çš„åé¥‹åœ¨æœ€ä¸Šé¢
                    feedbacks.sort((a, b) => {
                        const dateA = new Date(a.timestamp || 0);
                        const dateB = new Date(b.timestamp || 0);
                        return dateB - dateA;
                    });
                    
                    feedbacks.forEach((feedback, index) => {
                        const feedbackDate = feedback.timestamp ? new Date(feedback.timestamp) : new Date();
                        const formattedDate = this.formatDateTime(feedbackDate);
                        const deviceId = feedback.deviceFingerprint ? feedback.deviceFingerprint.substring(0, 8) : 'æœªçŸ¥è¨­å‚™';
                        
                        // æ¸…ç†å’Œæ ¼å¼åŒ–åé¥‹å…§å®¹
                        const cleanFeedback = feedback.feedback ? 
                            feedback.feedback.replace(/</g, '&lt;').replace(/>/g, '&gt;').trim() : 
                            'ç„¡å…§å®¹';
                        
                        // ç¢ºå®šåé¥‹é¡å‹çš„æ¨™ç±¤é¡è‰²
                        let feedbackType = 'ä¸€èˆ¬åé¥‹';
                        let typeColor = 'bg-blue-500';
                        
                        if (cleanFeedback.includes('å•é¡Œ') || cleanFeedback.includes('éŒ¯èª¤') || cleanFeedback.includes('bug')) {
                            feedbackType = 'å•é¡Œå›å ±';
                            typeColor = 'bg-red-500';
                        } else if (cleanFeedback.includes('å»ºè­°') || cleanFeedback.includes('æ”¹é€²') || cleanFeedback.includes('å¸Œæœ›')) {
                            feedbackType = 'æ”¹é€²å»ºè­°';
                            typeColor = 'bg-yellow-500';
                        } else if (cleanFeedback.includes('å¾ˆå¥½') || cleanFeedback.includes('æ»¿æ„') || cleanFeedback.includes('è®š')) {
                            feedbackType = 'æ­£é¢è©•åƒ¹';
                            typeColor = 'bg-green-500';
                        }
                        
                        const feedbackItem = document.createElement('div');
                        feedbackItem.className = 'bg-white bg-opacity-10 rounded-xl p-6 border border-purple-400 border-opacity-30 hover:bg-opacity-15 transition-all duration-300 shadow-lg hover:shadow-xl';
                        feedbackItem.innerHTML = `
                            <!-- åé¥‹æ¨™é¡Œå€åŸŸ -->
                            <div class="flex items-start justify-between mb-4">
                                <div class="flex items-center space-x-3">
                                    <div class="w-12 h-12 bg-gradient-to-br from-purple-500 to-blue-500 bg-opacity-30 rounded-full flex items-center justify-center shadow-lg">
                                        <span class="text-white font-black text-base">#${feedbacks.length - index}</span>
                                    </div>
                                    <div>
                                        <div class="flex items-center space-x-2 mb-1">
                                            <div class="text-white font-black text-lg">ç”¨æˆ¶åé¥‹ #${feedbacks.length - index}</div>
                                            <span class="${typeColor} bg-opacity-80 text-white text-xs font-bold px-2 py-1 rounded-full">${feedbackType}</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="text-white font-bold text-base">${formattedDate}</div>
                                    <div class="text-purple-200 text-sm mt-1 font-medium">${this.getTimeAgo(feedbackDate)}</div>
                                </div>
                            </div>
                            
                            <!-- åé¥‹å…§å®¹å€åŸŸ -->
                            <div class="bg-gradient-to-br from-gray-800 to-gray-900 bg-opacity-70 rounded-xl p-5 border border-gray-600 border-opacity-50 shadow-inner">
                                <div class="flex items-center mb-3">
                                    <svg class="w-5 h-5 text-blue-300 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                                    </svg>
                                    <span class="text-blue-300 font-bold text-sm">ç”¨æˆ¶ç•™è¨€å…§å®¹ï¼š</span>
                                </div>
                                <div class="text-gray-100 font-medium leading-relaxed whitespace-pre-wrap text-base bg-gray-700 bg-opacity-50 rounded-lg p-4 border-l-4 border-blue-400 min-h-[60px]">${cleanFeedback}</div>
                                
                                <!-- åé¥‹çµ±è¨ˆä¿¡æ¯ -->
                                <div class="mt-4 pt-4 border-t border-gray-600 border-opacity-50">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center space-x-4 text-xs">
                                            <span class="text-gray-400 font-medium">ğŸ“ å­—æ•¸: ${cleanFeedback.length}</span>
                                            <span class="text-gray-400 font-medium">ğŸ•’ ${feedbackDate.toLocaleDateString('zh-TW')}</span>
                                        </div>
                                        <button class="copy-feedback-btn bg-blue-600 hover:bg-blue-700 text-white text-xs font-bold px-3 py-1 rounded-lg transition-all duration-200" data-feedback="${cleanFeedback.replace(/"/g, '&quot;')}">
                                            ğŸ“‹ è¤‡è£½å…§å®¹
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                        
                        feedbackList.appendChild(feedbackItem);
                    });
                    
                    // æ·»åŠ è¤‡è£½åŠŸèƒ½äº‹ä»¶ç›£è½å™¨
                    feedbackList.addEventListener('click', (e) => {
                        if (e.target.classList.contains('copy-feedback-btn')) {
                            const feedbackContent = e.target.getAttribute('data-feedback').replace(/&quot;/g, '"');
                            this.copyToClipboard(feedbackContent);
                            this.showToast('âœ… åé¥‹å…§å®¹å·²è¤‡è£½åˆ°å‰ªè²¼æ¿', 'success');
                        }
                    });
                }
                
                console.log('ğŸ“Š åé¥‹æŸ¥çœ‹å™¨è¼‰å…¥å®Œæˆï¼Œé¡¯ç¤º', feedbacks.length, 'æ¢åé¥‹');
            }
            
            // è¨­ç½®é–‹ç™¼äººå“¡æ¨¡æ…‹æ¡†äº‹ä»¶
            setupDeveloperModalEvents(modal) {
                const closeBtns = modal.querySelectorAll('.close-developer-modal');
                const exportBtn = modal.querySelector('#exportFeedbacks');
                const clearBtn = modal.querySelector('#clearOldFeedbacks');
                
                const closeModal = () => {
                    modal.style.opacity = '0';
                    modal.style.transform = 'scale(0.95)';
                    setTimeout(() => modal.remove(), 300);
                };
                
                // é—œé–‰æŒ‰éˆ•
                closeBtns.forEach(btn => {
                    btn.addEventListener('click', closeModal);
                });
                
                // é»æ“Šé®ç½©é—œé–‰
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        closeModal();
                    }
                });
                
                // åŒ¯å‡ºåé¥‹
                exportBtn.addEventListener('click', () => {
                    this.exportFeedbacks();
                });
                
                // æ¸…ç†èˆŠåé¥‹
                clearBtn.addEventListener('click', () => {
                    this.clearOldFeedbacks(modal);
                });
                
                // ESC éµé—œé–‰
                const escapeHandler = (e) => {
                    if (e.key === 'Escape') {
                        closeModal();
                        document.removeEventListener('keydown', escapeHandler);
                    }
                };
                document.addEventListener('keydown', escapeHandler);
            }
            
            // åŒ¯å‡ºåé¥‹åŠŸèƒ½
            exportFeedbacks() {
                const feedbacks = this.loadFeedbacks();
                if (feedbacks.length === 0) {
                    this.showToast('âŒ æ²’æœ‰åé¥‹å¯ä»¥åŒ¯å‡º', 'warning');
                    return;
                }
                
                // å‰µå»ºCSVæ ¼å¼çš„æ•¸æ“š
                let csvContent = 'åºè™Ÿ,åé¥‹å…§å®¹,æäº¤æ™‚é–“,è¨­å‚™ID\n';
                feedbacks.forEach((feedback, index) => {
                    const deviceId = feedback.deviceFingerprint ? feedback.deviceFingerprint.substring(0, 8) : 'æœªçŸ¥è¨­å‚™';
                    const cleanFeedback = feedback.feedback.replace(/"/g, '""').replace(/\n/g, ' ');
                    csvContent += `${index + 1},"${cleanFeedback}","${feedback.timestamp}","${deviceId}"\n`;
                });
                
                // å‰µå»ºä¸‹è¼‰éˆæ¥
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `AI_Sam_ç”¨æˆ¶åé¥‹_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                this.showToast('âœ… åé¥‹å·²æˆåŠŸåŒ¯å‡º', 'success');
            }
            
            // æ¸…ç†èˆŠåé¥‹åŠŸèƒ½
            clearOldFeedbacks(modal) {
                const feedbacks = this.loadFeedbacks();
                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                
                const oldFeedbacks = feedbacks.filter(f => new Date(f.timestamp) < thirtyDaysAgo);
                
                if (oldFeedbacks.length === 0) {
                    this.showToast('âŒ æ²’æœ‰è¶…é30å¤©çš„èˆŠåé¥‹éœ€è¦æ¸…ç†', 'info');
                    return;
                }
                
                this.showCustomConfirm(
                    'æ¸…ç†èˆŠåé¥‹', 
                    `ç¢ºå®šè¦åˆªé™¤ ${oldFeedbacks.length} å€‹è¶…é30å¤©çš„èˆŠåé¥‹å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•æ’¤éŠ·ã€‚`, 
                    () => {
                        const newFeedbacks = feedbacks.filter(f => new Date(f.timestamp) >= thirtyDaysAgo);
                        
                        // ä¿å­˜æ›´æ–°å¾Œçš„åé¥‹
                        if (this.storageAvailable.localStorage) {
                            localStorage.setItem('chatbot_user_feedbacks', JSON.stringify(newFeedbacks));
                        }
                        
                        if (this.storageAvailable.sessionStorage) {
                            sessionStorage.setItem('chatbot_user_feedbacks', JSON.stringify(newFeedbacks));
                        }
                        
                        if (!window.__chatbot_memory_storage) {
                            window.__chatbot_memory_storage = {};
                        }
                        window.__chatbot_memory_storage.feedbacks = newFeedbacks;
                        
                        // é‡æ–°è¼‰å…¥æ•¸æ“š
                        this.loadDeveloperFeedbackData(modal);
                        
                        this.showToast(`âœ… å·²æ¸…ç† ${oldFeedbacks.length} å€‹èˆŠåé¥‹`, 'success');
                    }
                );
            }
            
            // ç²å–æ™‚é–“å·®æè¿°
            getTimeAgo(date) {
                const now = new Date();
                const diffMs = now - date;
                const diffMins = Math.floor(diffMs / 60000);
                const diffHours = Math.floor(diffMs / 3600000);
                const diffDays = Math.floor(diffMs / 86400000);
                
                if (diffMins < 1) return 'å‰›å‰›';
                if (diffMins < 60) return `${diffMins}åˆ†é˜å‰`;
                if (diffHours < 24) return `${diffHours}å°æ™‚å‰`;
                if (diffDays < 7) return `${diffDays}å¤©å‰`;
                if (diffDays < 30) return `${Math.floor(diffDays / 7)}é€±å‰`;
                return `${Math.floor(diffDays / 30)}å€‹æœˆå‰`;
            }
            
            // é¡¯ç¤ºå¯†ç¢¼æç¤ºå°è©±æ¡† - æµæš¢å¿«é€Ÿç‰ˆæœ¬
            showPasswordPrompt(onSuccess) {
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50';
                modal.style.opacity = '0';
                modal.innerHTML = `
                    <div class="bg-gradient-to-br from-purple-600 to-blue-600 rounded-2xl shadow-2xl max-w-sm w-full mx-4 p-6 border-2 border-white border-opacity-30 transform scale-90">
                        <!-- ç°¡åŒ–æ¨™é¡Œå€åŸŸ -->
                        <div class="text-center mb-4">
                            <div class="w-12 h-12 bg-yellow-500 bg-opacity-30 rounded-full flex items-center justify-center mx-auto mb-3">
                                <svg class="w-6 h-6 text-yellow-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                                </svg>
                            </div>
                            <h3 class="text-lg font-black text-white mb-1">ğŸ” é–‹ç™¼äººå“¡é©—è­‰</h3>
                            <p class="text-blue-200 font-bold text-xs">å¿«é€Ÿè¼¸å…¥å¯†ç¢¼é€²å…¥</p>
                        </div>
                        
                        <!-- ç°¡åŒ–å¯†ç¢¼è¼¸å…¥ -->
                        <div class="mb-4">
                            <input 
                                type="password" 
                                id="developerPassword" 
                                placeholder="adminå¯†ç¢¼..." 
                                class="w-full p-3 bg-white bg-opacity-20 border-2 border-white border-opacity-30 rounded-xl text-white placeholder-blue-200 font-bold text-sm focus:outline-none focus:ring-2 focus:ring-yellow-400 focus:border-yellow-400 transition-all duration-100"
                                autocomplete="off"
                            >
                        </div>
                        
                        <!-- å¿«é€ŸéŒ¯èª¤æç¤º -->
                        <div id="passwordError" class="hidden mb-3 p-2 bg-red-500 bg-opacity-30 rounded-lg">
                            <p class="text-red-200 font-bold text-xs text-center">âŒ å¯†ç¢¼éŒ¯èª¤</p>
                        </div>
                        
                        <!-- ç°¡åŒ–æŒ‰éˆ• -->
                        <div class="flex space-x-2">
                            <button class="cancel-password flex-1 bg-gray-500 bg-opacity-30 hover:bg-opacity-50 text-white font-black py-2 px-3 rounded-xl transition-all duration-100 text-sm">
                                å–æ¶ˆ
                            </button>
                            <button class="confirm-password flex-1 bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white font-black py-2 px-3 rounded-xl transition-all duration-100 text-sm">
                                é€²å…¥
                            </button>
                        </div>
                        
                        <!-- å¿«æ·éµæç¤º -->
                        <div class="mt-3 text-center">
                            <p class="text-blue-200 font-medium text-xs">
                                ğŸ’¡ Enterç¢ºèª â€¢ Escapeå–æ¶ˆ â€¢ Ctrl+Då¿«é€Ÿæ¨¡å¼
                            </p>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // ç«‹å³é¡¯ç¤ºå‹•ç•«
                requestAnimationFrame(() => {
                    modal.style.opacity = '1';
                    modal.style.transition = 'opacity 0.15s ease-out';
                    const dialog = modal.querySelector('div > div');
                    dialog.style.transform = 'scale(1)';
                    dialog.style.transition = 'transform 0.15s ease-out';
                });
                
                const passwordInput = modal.querySelector('#developerPassword');
                const errorDiv = modal.querySelector('#passwordError');
                const cancelBtn = modal.querySelector('.cancel-password');
                const confirmBtn = modal.querySelector('.confirm-password');
                
                // æ”¯æ´å¤šç¨®å¯†ç¢¼
                const correctPasswords = ['admin2025', 'dev', 'admin', '123456'];
                
                // ç«‹å³èšç„¦
                passwordInput.focus();
                
                const closeModal = () => {
                    modal.style.opacity = '0';
                    setTimeout(() => modal.remove(), 100);
                };
                
                const verifyPassword = () => {
                    const enteredPassword = passwordInput.value.trim();
                    
                    if (correctPasswords.includes(enteredPassword.toLowerCase())) {
                        // å¯†ç¢¼æ­£ç¢º - ç«‹å³æˆåŠŸ
                        console.log('âœ… é–‹ç™¼äººå“¡å¯†ç¢¼é©—è­‰æˆåŠŸ');
                        
                        // é¡¯ç¤ºæˆåŠŸæ•ˆæœ
                        passwordInput.style.borderColor = '#10b981';
                        passwordInput.style.boxShadow = '0 0 0 2px rgba(16, 185, 129, 0.3)';
                        
                        // å¿«é€Ÿé—œé–‰ä¸¦åŸ·è¡ŒæˆåŠŸå›èª¿
                        setTimeout(() => {
                            closeModal();
                            onSuccess(true);
                        }, 50);
                        
                    } else {
                        // å¯†ç¢¼éŒ¯èª¤ - å¿«é€Ÿåé¥‹
                        console.log('âŒ é–‹ç™¼äººå“¡å¯†ç¢¼é©—è­‰å¤±æ•—');
                        errorDiv.classList.remove('hidden');
                        passwordInput.value = '';
                        passwordInput.style.borderColor = '#ef4444';
                        passwordInput.style.boxShadow = '0 0 0 2px rgba(239, 68, 68, 0.3)';
                        
                        // å¿«é€Ÿéœ‡å‹•
                        passwordInput.style.animation = 'shake 0.3s ease-in-out';
                        setTimeout(() => {
                            passwordInput.style.animation = '';
                            passwordInput.style.borderColor = '';
                            passwordInput.style.boxShadow = '';
                        }, 300);
                        
                        // 1ç§’å¾Œéš±è—éŒ¯èª¤è¨Šæ¯
                        setTimeout(() => {
                            errorDiv.classList.add('hidden');
                        }, 1000);
                        
                        passwordInput.focus();
                    }
                };
                
                // äº‹ä»¶ç›£è½å™¨
                cancelBtn.addEventListener('click', () => {
                    closeModal();
                    onSuccess(false);
                });
                
                confirmBtn.addEventListener('click', verifyPassword);
                
                // å¿«æ·éµæ”¯æ´
                passwordInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        verifyPassword();
                    } else if (e.key === 'Escape') {
                        e.preventDefault();
                        closeModal();
                        onSuccess(false);
                    }
                });
                
                // é»æ“Šé®ç½©å¿«é€Ÿé—œé–‰
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        closeModal();
                        onSuccess(false);
                    }
                });
                
                // æ·»åŠ å¿«é€Ÿå‹•ç•«CSS
                if (!document.querySelector('#fast-animations-style')) {
                    const style = document.createElement('style');
                    style.id = 'fast-animations-style';
                    style.textContent = `
                        @keyframes shake {
                            0%, 100% { transform: translateX(0); }
                            25% { transform: translateX(-3px); }
                            75% { transform: translateX(3px); }
                        }
                    `;
                    document.head.appendChild(style);
                }
            }
            
            // è¨­ç½®é»æ“ŠèŠå¤©å€åŸŸé—œé–‰å´é‚Šæ¬„çš„åŠŸèƒ½
            setupChatAreaClick() {
                const chatArea = document.getElementById('chatArea');
                const mainContent = document.querySelector('.flex-1.flex.flex-col.h-screen');
                const header = document.querySelector('header');
                const inputArea = document.querySelector('.glass-effect.border-t');
                
                // ç‚ºå¤šå€‹èŠå¤©ç›¸é—œå€åŸŸæ·»åŠ é»æ“Šäº‹ä»¶
                [chatArea, header, inputArea].forEach(area => {
                    if (area) {
                        area.addEventListener('click', (e) => {
                            // æª¢æŸ¥å´é‚Šæ¬„æ˜¯å¦æ‰“é–‹
                            const sidebar = document.getElementById('sidebar');
                            if (sidebar && sidebar.classList.contains('open')) {
                                // æª¢æŸ¥é»æ“Šçš„ç›®æ¨™ï¼Œç¢ºä¿ä¸æ˜¯è¼¸å…¥æ¡†ã€æŒ‰éˆ•ç­‰äº¤äº’å…ƒç´ 
                                const clickedElement = e.target;
                                const isInteractiveElement = clickedElement.closest('input, textarea, button, select, a, [role="button"], .button-hover-lift') ||
                                                           clickedElement.tagName === 'INPUT' ||
                                                           clickedElement.tagName === 'TEXTAREA' ||
                                                           clickedElement.tagName === 'BUTTON' ||
                                                           clickedElement.tagName === 'SELECT' ||
                                                           clickedElement.tagName === 'A';
                                
                                // å¦‚æœä¸æ˜¯äº¤äº’å…ƒç´ ï¼Œå‰‡é—œé–‰å´é‚Šæ¬„
                                if (!isInteractiveElement) {
                                    e.preventDefault();
                                    this.closeSidebar();
                                }
                            }
                        });
                    }
                });
                
                // ç‚ºæ•´å€‹ä¸»è¦å…§å®¹å€åŸŸæ·»åŠ é»æ“Šäº‹ä»¶ï¼ˆä½œç‚ºå‚™ç”¨ï¼‰
                if (mainContent) {
                    mainContent.addEventListener('click', (e) => {
                        const sidebar = document.getElementById('sidebar');
                        if (sidebar && sidebar.classList.contains('open')) {
                            // æª¢æŸ¥é»æ“Šæ˜¯å¦åœ¨å´é‚Šæ¬„å¤–éƒ¨
                            const sidebarRect = sidebar.getBoundingClientRect();
                            const clickX = e.clientX;
                            const clickY = e.clientY;
                            
                            // å¦‚æœé»æ“Šåœ¨å´é‚Šæ¬„å¤–éƒ¨ä¸”ä¸æ˜¯äº¤äº’å…ƒç´ 
                            if ((clickX < sidebarRect.left || clickX > sidebarRect.right || 
                                 clickY < sidebarRect.top || clickY > sidebarRect.bottom)) {
                                
                                const clickedElement = e.target;
                                const isInteractiveElement = clickedElement.closest('input, textarea, button, select, a, [role="button"], .button-hover-lift') ||
                                                           clickedElement.tagName === 'INPUT' ||
                                                           clickedElement.tagName === 'TEXTAREA' ||
                                                           clickedElement.tagName === 'BUTTON' ||
                                                           clickedElement.tagName === 'SELECT' ||
                                                           clickedElement.tagName === 'A';
                                
                                if (!isInteractiveElement) {
                                    e.preventDefault();
                                    this.closeSidebar();
                                }
                            }
                        }
                    });
                }
            }
        }

        // åˆå§‹åŒ–é é¢ç®¡ç†å™¨
        const pageManager = new PageManager();

        // æ€§èƒ½ç›£æ§å’ŒéŒ¯èª¤è™•ç†
        window.addEventListener('load', () => {
            console.log('Design Thinking AI æ”¹è‰¯ç‰ˆæœ¬è¼‰å…¥å®Œæˆ');
        });
        
        // é˜²æ­¢å¸¸è¦‹éŒ¯èª¤
        window.addEventListener('error', (e) => {
            console.error('å…¨å±€éŒ¯èª¤:', e.error);
        });
        
        window.addEventListener('unhandledrejection', (e) => {
            console.error('æœªè™•ç†çš„PromiseéŒ¯èª¤:', e.reason);
            e.preventDefault();
        });
        
        // ç¢ºä¿ chatBotApp å…¨åŸŸå¯ç”¨ (ä¾› removeFile å‡½æ•¸ä½¿ç”¨)
        window.chatBotApp = null;
    </script>
</body>
</html>
